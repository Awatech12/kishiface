<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.7/dist/htmx.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<title>Chat</title>

<style>
/* ---------------------------------------------------- */
/* --- GENERAL CHAT STYLES (Unchanged from Original) --- */
/* ---------------------------------------------------- */
* { box-sizing: border-box; }
body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #FAFAFA; display: flex; flex-direction: column; height: 100vh; }
@media (min-width: 768px) { body { align-items: center; justify-content: center; background-color: #EFEFEF; } .main-chat-wrapper { width: 100%; height: 90vh; background: white; border: 1px solid #DBDBDB; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); display: flex; flex-direction: column; overflow: hidden; } .input-area { position: static !important; width: 100% !important; } }
.main-chat-wrapper { display: contents; }
.profile-header { background: white; color: #262626; padding: 10px 15px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #EFEFEF; height: 60px; text-align: left; }
.profile-header-content { display: flex; align-items: center; }
.profile-header img { border-radius: 50%; width: 40px; height: 40px; margin-right: 10px; }
.profile-header b { font-size: 16px; font-weight: 600; }
.chat-container { padding: 15px; flex-grow: 1; overflow-y: auto; scroll-behavior: smooth; background: white; margin-bottom: 40px; }
.chat-container::-webkit-scrollbar { display: none; }
.message { max-width: 85%; padding: 10px 14px 18px 14px; margin-bottom: 8px; border-radius: 20px; font-size: 15px; line-height: 1.4; position: relative; }
.sent { background: linear-gradient(135deg, #0099ff 0%, #a033ff 100%); color: white; margin-left: auto; border-bottom-right-radius: 5px; }
.received { background: #EFEFEF; color: #262626; margin-right: auto; border-bottom-left-radius: 5px; }
.time { display: block; position: absolute; bottom: 3px; right: 8px; font-size: 10px; color: rgba(255, 255, 255, 0.7); text-align: right; white-space: nowrap; }
.received .time { color: #8E8E93; }
.chat-container center b i { font-size: 12px; color: #8E8E93; font-style: normal; font-weight: 400; margin: 15px 0; display: block; }
.input-area { padding: 10px 15px; background: white; display: flex; align-items: center; position: fixed; bottom: 0; width: 100%; border-top: 1px solid #EFEFEF; }
.input-area input { flex-grow: 1; padding: 10px 15px; margin-right: 8px; border: 1px solid #DBDBDB; border-radius: 30px; outline: none; font-size: 15px; background: #FAFAFA; }
.input-area button { width: 40px; height: 40px; padding: 0; margin-left: 0; border: none; border-radius: 50%; background: none; color: #0099ff; font-size: 20px; font-weight: bold; cursor: pointer; transition: opacity 0.2s; line-height: 40px; text-align: center; }
.input-area button:hover { opacity: 0.8; }
.profile-header-text { display: flex; flex-direction: column; align-items: flex-start; }
.recording { position: relative; font-size: 20px; color: #ff3b30; animation: pulse 1s infinite; }
@media (max-width: 767px) { .chat-container { height: calc(100vh - 60px - 60px); } }

/* ----------------------------------------------------------- */
/* --- UPDATED INSTAGRAM-STYLE AUDIO PLAYER CSS (Essential) --- */
/* ----------------------------------------------------------- */

/* Remove old conflicting styles */
.audio-player { display: none; }

/* Base container for the audio player */
.ig-audio-player {
    display: flex;
    align-items: center;
    padding: 2px 0;
    width: 220px; /* Consistent width */
}

/* Play/Pause Button */
.ig-audio-player button.play-pause-btn {
    border: none;
    background: #EFEFEF; /* Light gray circle background */
    color: #262626; /* Dark icon color */
    border-radius: 50%;
    width: 30px; 
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    margin-right: 8px; 
    flex-shrink: 0;
    cursor: pointer;
    font-size: 12px;
    transition: background 0.2s;
}

/* Specific styling for the 'sent' (blue/purple) message button */
.sent .ig-audio-player button.play-pause-btn {
    background: white; /* White circle background */
    color: #0099ff; /* Blue/Purple color for the icon */
}

/* Progress Slider */
.ig-audio-player input[type=range] {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: 4px;
    background: rgba(255, 255, 255, 0.4); /* Light track for sent messages */
    border-radius: 2px;
    cursor: pointer;
    margin: 0 5px;
}

/* Track for received messages */
.received .ig-audio-player input[type=range] {
    background: #CCC; /* Darker track for received messages */
}

/* Thumb (The draggable circle) */
.ig-audio-player input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    height: 10px;
    width: 10px;
    border-radius: 50%;
    background: white; /* White thumb on sent messages */
    cursor: pointer;
    margin-top: -3px;
}

/* Thumb on received messages */
.received .ig-audio-player input[type=range]::-webkit-slider-thumb {
    background: #262626; /* Dark thumb on received messages */
}

/* Duration/Time Stamp */
.ig-audio-player span.timestamp {
    font-size: 11px;
    margin-left: 5px;
    flex-shrink: 0;
    font-weight: 500;
}

/* Color adjustments for duration span */
.sent .ig-audio-player span.timestamp {
    color: rgba(255, 255, 255, 0.8); /* Light color on sent message */
}
.received .ig-audio-player span.timestamp {
    color: #8E8E93; /* Subtle gray on received message */
}
</style>
</head>
<body>

<div class="main-chat-wrapper">
    <div class="profile-header">
        <div class="profile-header-content">
            <img src="{{ receiver.profile.picture.url }}" alt="">
            <div class="profile-header-text">
                <b>{% if receiver.profile.full_name %}{{ receiver.profile.full_name }}{% else %}{{ receiver.username }}{% endif %}</b>
            </div>
        </div>
        <div></div>
    </div>

    <div id="messageOutput" class="chat-container">
        {% for label, msgs in grouped_messages.items %}
            <center><b><i>{{ label }}</i></b></center>
            {% for message in msgs %}
                {% if message.sender.username == request.user.username %}
                    {% if message.conversation %}
                    <div class="sent message">
                        {{ message.conversation }}
                        <span class="time">{{ message.chat_time }}</span>
                    </div>
                    {% elif message.file %}
                    <div class="sent message">
                        <div class="ig-audio-player">
                            <button class="play-pause-btn"><i class="fa-solid fa-play"></i></button>
                            <input type="range" min="0" max="100" value="0" class="progress">
                            <span class="timestamp">0:00</span>
                        </div>
                        <audio class="audio-source" src="{{ message.file.url }}"></audio>
                        <span class="time">{{ message.chat_time }}</span>
                    </div>
                    {% endif %}
                {% else %}
                    {% if message.conversation %}
                    <div class="received message">
                        {{ message.conversation }}
                        <span class="time">{{ message.chat_time }}</span>
                    </div>
                    {% elif message.file %}
                    <div class="received message">
                        <div class="ig-audio-player">
                            <button class="play-pause-btn"><i class="fa-solid fa-play"></i></button>
                            <input type="range" min="0" max="100" value="0" class="progress">
                            <span class="timestamp">0:00</span>
                        </div>
                        <audio class="audio-source" src="{{ message.file.url }}"></audio>
                        <span class="time">{{ message.chat_time }}</span>
                    </div>
                    {% endif %}
                {% endif %}
            {% endfor %}
        {% endfor %}
    </div>

    <div class="input-area">
        <input type="text" id="message" placeholder="Message...">
        <button id="startBtn" type="button"><i class="fa-solid fa-microphone"></i></button>
        <span id="status"></span>
        <button id="stopBtn" type="button" hidden><i class="fa-solid fa-circle-stop"></i></button>
        <button id="sendBtn">âž¤</button>
    </div>
</div>

<script>
const receiver = "{{ receiver.username }}";
const sender = "{{ request.user.username }}";
const messageOutput = document.getElementById('messageOutput');
const message = document.getElementById('message');
const sendBtn = document.getElementById('sendBtn');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const status = document.getElementById('status');

let mediaRecorder;
let audioFile = null;

const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
const socket = new WebSocket(protocol + window.location.host + "/ws/message/");

messageOutput.scrollTo({ top: messageOutput.scrollHeight, behavior: 'smooth' });

socket.addEventListener("message", function (e) {
    const data = JSON.parse(e.data);
    const div = document.createElement("div");

    if (data.sender === sender) div.className = "sent message";
    else div.className = "received message";

    if (data.message) {
        div.innerHTML = `${data.message}<span class="time">${data.time}</span>`;
    } else if (data.audio_url) {
        // Updated structure for live-received audio messages
        div.innerHTML = `<div class="ig-audio-player">
            <button class="play-pause-btn"><i class="fa-solid fa-play"></i></button>
            <input type="range" min="0" max="100" value="0" class="progress">
            <span class="timestamp">0:00</span>
        </div>
        <audio class="audio-source" src="${data.audio_url}"></audio>
        <span class="time">${data.time}</span>`;
    }

    messageOutput.appendChild(div);
    // Initialize the new controls on the newly added message
    initAudioControls(div); 
    messageOutput.scrollTo({ top: messageOutput.scrollHeight, behavior: 'smooth' });
});

// --- Audio recording using base64 ---
startBtn.addEventListener('click', async () => {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        const chunks = [];

        mediaRecorder.ondataavailable = e => chunks.push(e.data);
        mediaRecorder.onstop = () => {
            const blob = new Blob(chunks, { type: 'audio/webm' });
            const reader = new FileReader();
            reader.onloadend = () => {
                const base64Audio = reader.result; // data:audio/webm;base64,...
                socket.send(JSON.stringify({
                    type: 'audio',
                    receiver: receiver,
                    audio: base64Audio
                }));
            };
            reader.readAsDataURL(blob);
            status.textContent = '';
        };

        mediaRecorder.start();
        status.innerHTML = `<i class="fa-solid fa-circle recording"></i> Recording...`;
        startBtn.hidden = true;
        stopBtn.hidden = false;
    } catch (err) { alert('Microphone access denied'); }
});

stopBtn.addEventListener('click', () => {
    if (mediaRecorder) mediaRecorder.stop();
    startBtn.hidden = false;
    stopBtn.hidden = true;
});

sendBtn.addEventListener('click', () => {
    const msg = message.value.trim();
    if (msg) {
        socket.send(JSON.stringify({ type: 'text', receiver: receiver, message: msg }));
    }
    message.value = '';
});

message.addEventListener("keypress", e => { if (e.key === "Enter") sendBtn.click(); });

// -----------------------------------------------------------
// --- UPDATED JAVASCRIPT AUDIO CONTROL LOGIC (Essential) ---
// -----------------------------------------------------------

function initAudioControls(container) {
    // Select the new player class
    const player = container.querySelector('.ig-audio-player');
    if (!player) return;

    const audio = container.querySelector('.audio-source');
    const playBtn = player.querySelector('.play-pause-btn');
    const progress = player.querySelector('.progress');
    const durationSpan = player.querySelector('.timestamp');

    if (!audio || !playBtn || !progress || !durationSpan) return;

    // Helper function to format time (M:SS)
    const formatTime = (timeInSeconds) => {
        if (isNaN(timeInSeconds)) return '0:00';
        const mins = Math.floor(timeInSeconds / 60);
        const secs = Math.floor(timeInSeconds % 60);
        return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
    };

    playBtn.addEventListener('click', () => {
        if (audio.paused) {
            // Pause any other playing audio before starting this one
            document.querySelectorAll('.audio-source').forEach(a => {
                if (a !== audio && !a.paused) a.pause();
            });
            audio.play();
        } else {
            audio.pause();
        }
    });

    // Use Font Awesome icons for visual feedback
    audio.addEventListener('play', () => playBtn.innerHTML = '<i class="fa-solid fa-pause"></i>');
    audio.addEventListener('pause', () => playBtn.innerHTML = '<i class="fa-solid fa-play"></i>');
    audio.addEventListener('ended', () => {
        playBtn.innerHTML = '<i class="fa-solid fa-play"></i>';
        audio.currentTime = 0; // Reset to start
        progress.value = 0;
    });

    // Set initial duration when metadata loads
    audio.addEventListener('loadedmetadata', () => {
        durationSpan.textContent = formatTime(audio.duration);
    });

    // Update progress and current time display
    audio.addEventListener('timeupdate', () => {
        if (!isNaN(audio.duration)) {
            const percent = (audio.currentTime / audio.duration) * 100;
            progress.value = percent;
        }
        durationSpan.textContent = formatTime(audio.currentTime);
    });

    // Scrubbing (user dragging the progress bar)
    progress.addEventListener('input', () => {
        if (!isNaN(audio.duration)) {
            audio.currentTime = (progress.value / 100) * audio.duration;
        }
    });

    // Set the initial state for messages loaded on page load
    if (audio.readyState >= 1) { 
        durationSpan.textContent = formatTime(audio.duration);
    }
}

// Initialize controls for all existing messages on page load
document.querySelectorAll('.message').forEach(initAudioControls);
</script>

</body>
</html>
