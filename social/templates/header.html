{% load humanize %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="{% static 'images/logo.jpg' %}" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.7/dist/htmx.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --main-bg: #f0f2f5;
            --white: #ffffff;
            --border-color: #e0e0e0;
            --text-dark: #1f1f1f;
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        body {
            font-family: var(--font-stack);
            background-color: var(--white);
            margin: 0;
            padding-top: 54px;
            padding-bottom: 49px;
            color: var(--text-dark);
        }

        header {
            position: fixed; top: 0; left: 0; right: 0;
            height: 54px;
            background: var(--white);
            border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px;
            z-index: 1000;
        }

        header h1 {
            font-family: 'Billabong', cursive, 'Brush Script MT', cursive;
            font-size: 28px;
            margin: 0;
        }

        header .icon-group {
            display: flex; gap: 20px; align-items: center;
        }

        header .icon-group i {
            font-size: 26px; color: #666; cursor: pointer;
        }
        
        .channel-icon-header {
            width: 26px; height: 26px; object-fit: contain;
        }
        
        .icon-badge-container {
            position: relative; display: inline-block;
        }
        
        .icon-badge {
            position: absolute; top: -8px; right: -8px;
            background-color: #0095f6; color: white;
            border-radius: 10px; min-width: 18px; height: 18px;
            font-size: 11px; font-weight: 600;
            display: flex; align-items: center; justify-content: center;
            padding: 0 4px; border: 1.5px solid var(--white);
        }
        
        .icon-badge:empty, .icon-badge[data-count="0"] { display: none; }
        .message-badge { background-color: #007aff; }
        .icon-link { text-decoration: none; color: inherit; display: flex; align-items: center; }
    </style>
</head>
<body>

<header>
    <h1>KishiFace</h1>
    <div class="icon-group">
        <a href="{% url 'channel_create' %}" class="icon-link">
            <div class="icon-badge-container">
                <img src="{% static 'images/chat.png' %}" class="channel-icon-header">
               {% if total_followed_unread > 0 %}
                <div class="icon-badge" id="header-channel-badge">
                    {{ total_followed_unread }}
                </div>
                {% endif %}
            </div>
        </a>
        
        <a href="{% url 'inbox' %}" class="icon-link">
            <div class="icon-badge-container">
                <i class="fa-regular fa-envelope"></i>
                <div class="icon-badge message-badge" id="message-badge">
                    <span hx-get="{% url 'inbox_partial' %}" hx-trigger="every 1s" hx-target="#message-badge" hx-swap="outerHTML">
                        {% include 'snippet/inbox_count.html' %}
                    </span>
                </div>
            </div>
        </a>
    </div>
</header>

<script>
    // 1. Back button refresh logic
    window.addEventListener('pageshow', function(event) {
        if (event.persisted || (window.performance && window.performance.navigation.type === 2)) {
            window.location.reload();
        }
    });

    // 2. WebSocket Real-time updates
    document.addEventListener('DOMContentLoaded', function() {
        if ("{{ request.user.is_authenticated }}" === "True") {
            const userId = "{{ request.user.id }}";
            const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
            const ws = new WebSocket(`${protocol}${window.location.host}/ws/user/${userId}/`);

            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                if (data.type === 'unread_update') {
                    // Update Global Header Badge
                    const globalBadge = document.getElementById('header-channel-badge');
                    if (globalBadge) {
                        globalBadge.textContent = data.total_followed_unread;
                        globalBadge.style.display = data.total_followed_unread > 0 ? 'flex' : 'none';
                    }

                    // Update Channel Item in List
                    const previewElement = document.getElementById(`last-msg-${data.channel_id}`);
                    if (previewElement) {
                        const channelItem = previewElement.closest('.channel-item');
                        
                        // Move to top
                        const list = document.querySelector('.channels-list');
                        if (list) {
                            const header = list.querySelector('.channels-header');
                            if (header) header.after(channelItem);
                        }

                        // Update Preview with Audio/Video Icons
                        if (data.message_type === 'audio') {
                            previewElement.innerHTML = '<i class="fas fa-microphone"></i> Audio message';
                        } else if (data.message_type === 'video') {
                            previewElement.innerHTML = '<i class="fas fa-video"></i> Video message';
                        }
                        else if (data.message_type === 'image') {
                            previewElement.innerHTML = '<i class="fas fa-image"></i> Image message';
                        }
                        
                        else {
                            previewElement.textContent = data.message_preview;
                        }

                        // Update Time
                        const timeSpan = channelItem.querySelector('.channel-time');
                        if (timeSpan) timeSpan.textContent = "Now";

                        // Update Individual Badge
                        const actions = channelItem.querySelector('.channel-actions');
                        if (actions) {
                            let itemBadge = actions.querySelector('.unread-badge');
                            if (data.unread_count > 0) {
                                if (!itemBadge) {
                                    itemBadge = document.createElement('span');
                                    itemBadge.className = 'unread-badge';
                                    actions.appendChild(itemBadge);
                                }
                                itemBadge.textContent = data.unread_count;
                            } else if (itemBadge) {
                                itemBadge.remove();
                            }
                        }
                    }
                }
            };
        }
    });
</script>
</body>
</html>
