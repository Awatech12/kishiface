{% load humanize %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="{% static 'images/logo.jpg' %}" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.7/dist/htmx.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
    /*
     * COMBINED STYLE: LinkedIn Boxed Card with Instagram Carousel Functionality
     */
    :root {
      --main-bg: #f0f2f5;
      --white: #ffffff;
      --border-color: #e0e0e0;
      --primary-color: #0077b5;
      --text-dark: #1f1f1f;
      --text-muted: #6a6a6a;
      --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    body {
      font-family: var(--font-stack);
      background-color: var(--white);
      margin: 0;
      padding-top: 54px;
      padding-bottom: 49px;
      color: var(--text-dark);
      min-height: 100vh;
    }
    /* ===== Header (Top Bar) ===== */
    header {
      position: fixed; top: 0; left: 0; right: 0;
      height: 54px;
      background: var(--white);
      border-bottom: 1px solid var(--border-color);
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 16px;
      z-index: 1000;
    }
    header h1 {
      /* Keep the stylistic font for the logo */
      font-family: 'Billabong', cursive, 'Brush Script MT', cursive;
      font-size: 28px;
      font-weight: normal;
    }
    /* Updated: Added gap for the header icons */
    header .icon-group {
      display: flex;
      gap: 20px;
      align-items: center;
    }
    /* Updated: Changed icons to plane white with #666 color */
    header .icon-group i {
      font-size: 26px;
      color: #666;
      cursor: pointer;
      /* Remove any text-shadow that might be added by Font Awesome */
      text-shadow: none !important;
    }
    
    /* ===== Channel Icon Style ===== */
    .channel-icon-header {
      width: 26px;
      height: 26px;
      cursor: pointer;
      object-fit: contain;
    }
    
    /* ===== Message Badge Styles ===== */
    .icon-badge-container {
      position: relative;
      display: inline-block;
    }
    
    .icon-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background-color: #ff3b30; /* Red color for alerts */
      color: white;
      border-radius: 10px;
      min-width: 18px;
      height: 18px;
      font-size: 11px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
      box-sizing: border-box;
      border: 1.5px solid var(--white);
      /* No shadow as requested */
      text-shadow: none;
      box-shadow: none;
    }
    
    /* Style for zero count - hide the badge */
    .icon-badge[data-count="0"] {
      display: none;
    }
    
    /* Message badge specific style */
    .message-badge {
      background-color: #007aff; /* Blue color for messages */
    }
    
    /* ===== Link Styles ===== */
    .icon-link {
      text-decoration: none;
      color: inherit;
      display: flex;
      align-items: center;
      position: relative;
    }
    
    /* ===== Footer Notification Badge Styles ===== */
    .footer-badge-container {
      position: relative;
      display: inline-block;
    }
    
    .footer-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background-color: #ff3b30;
      color: white;
      font-size: 10px;
      font-weight: 600;
      min-width: 16px;
      height: 16px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
      z-index: 1002;
      border: 1.5px solid white;
    }
    
    </style>
</head>
<body>
  

  <header>
  <h1>KishiFace</h1>
  <div class="icon-group"><a href="{% url 'channel_create' %}" class="icon-link" title="Channels">
  <div class="icon-badge-container">
    <img src="{% static 'images/chat.png' %}" alt="Channel" class="channel-icon-header">
    <div class="icon-badge" id="header-channel-badge" 
         >
        {{ total_followed_unread }}
    </div>
  </div>
</a>

<script>
    function updateHeaderBadge(count) {
        const badge = document.getElementById('header-channel-badge');
        if (badge) {
            badge.textContent = count;
            badge.style.display = count > 0 ? 'flex' : 'none';
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        if ('WebSocket' in window && "{{ request.user.is_authenticated }}" === "True") {
            const userId = "{{ request.user.id }}";
            const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
            const ws = new WebSocket(`${protocol}${window.location.host}/ws/user/${userId}/`);
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                if (data.type === 'unread_update') {
                    // Update the header badge instantly using the total from the server
                    if (data.total_followed_unread !== undefined) {
                        updateHeaderBadge(data.total_followed_unread);
                    }

                    // Optional: Update individual list item badge if on channel_create.html
                    const channelItemLink = document.querySelector(`.channel-item a[href*="${data.channel_id}"]`);
                    if (channelItemLink) {
                        const actions = channelItemLink.closest('.channel-item').querySelector('.channel-actions');
                        let itemBadge = actions.querySelector('.unread-badge');
                        if (data.unread_count > 0) {
                            if (!itemBadge) {
                                itemBadge = document.createElement('span');
                                itemBadge.className = 'unread-badge';
                                actions.appendChild(itemBadge);
                            }
                            itemBadge.textContent = data.unread_count;
                        } else if (itemBadge) {
                            itemBadge.remove();
                        }
                    }
                }
            };
        }
    });
</script>

    <!-- Message Icon with Badge -->
    <a href="{% url 'inbox' %}" class="icon-link">
      <div class="icon-badge-container">
        <i class="fa-regular fa-envelope"></i>
        <div class="icon-badge message-badge" id="message-badge">
          <span
            hx-get="{% url 'inbox_partial' %}"
            hx-trigger="every 1s"
            hx-target="#message-badge"
            hx-swap="outerHTML"   
          >
          {% include 'snippet/inbox_count.html' %}
          </span>
        </div>
      </div>
    </a>
  </div>
</header>

{% include 'info.html' %}
<script>
    // Handles page refresh on "Back" navigation
    window.addEventListener('pageshow', function(event) {
        if (event.persisted || (window.performance && window.performance.navigation.type === 2)) {
            window.location.reload();
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        if ("{{ request.user.is_authenticated }}" === "True") {
            const userId = "{{ request.user.id }}";
            const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
            const ws = new WebSocket(`${protocol}${window.location.host}/ws/user/${userId}/`);

            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                if (data.type === 'unread_update') {
                    // 1. Global Badge Update
                    const hBadge = document.getElementById('header-channel-badge');
                    if (hBadge) {
                        hBadge.textContent = data.total_followed_unread;
                        hBadge.style.display = data.total_followed_unread > 0 ? 'flex' : 'none';
                    }

                    // 2. Find Channel Item in List
                    const channelLink = document.querySelector(`a[href*="${data.channel_id}"]`);
                    if (channelLink) {
                        const channelItem = channelLink.closest('.channel-item');
                        
                        // 3. Reorder: Move to top
                        const list = document.querySelector('.channels-list');
                        if (list && channelItem) {
                            const header = list.querySelector('.channels-header');
                            header.after(channelItem);
                        }

                        // 4. Update Message Text
                        const preview = document.getElementById(`last-msg-${data.channel_id}`);
                        if (preview && data.message_preview) {
                            preview.textContent = data.message_preview;
                        }

                        // 5. Update Time
                        const timeSpan = channelItem.querySelector('.channel-time');
                        if (timeSpan) timeSpan.textContent = "just now";

                        // 6. Update Badge
                        const actions = channelItem.querySelector('.channel-actions');
                        if (actions) {
                            let badge = actions.querySelector('.unread-badge');
                            if (data.unread_count > 0) {
                                if (!badge) {
                                    badge = document.createElement('span');
                                    badge.className = 'unread-badge';
                                    actions.appendChild(badge);
                                }
                                badge.textContent = data.unread_count;
                            } else if (badge) {
                                badge.remove();
                            }
                        }
                    }
                }
            };
        }
    });
</script>




</body>
</html>