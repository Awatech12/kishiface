{% include 'header.html' %}

<!-- Font Awesome CDN (Ensure this is in your base.html or here) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    body { background: #000; margin: 0; overflow: hidden; }

    /* Full-screen Spotlight Container */
    .spotlight-container {
        height: 100vh;
        width: 100%;
        overflow-y: scroll;
        scroll-snap-type: y mandatory;
        scrollbar-width: none; /* Hide scrollbar Firefox */
    }
    .spotlight-container::-webkit-scrollbar { display: none; } /* Hide scrollbar Chrome */

    .spotlight-item {
        height: 100vh;
        width: 100vw;
        scroll-snap-align: start;
        position: relative;
        display: flex;
        justify-content: center;
        background: #000;
    }

    video {
        height: 100%;
        max-width: 500px; /* Standard mobile width for desktop viewing */
        width: 100%;
        object-fit: cover;
    }

    /* RIGHT SIDEBAR (Actions) */
    .action-sidebar {
        position: absolute;
        right: 15px;
        bottom: 120px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        z-index: 10;
    }

    .profile-link-container {
        position: relative;
        margin-bottom: 10px;
    }

    .profile-pic-spotlight {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        border: 2px solid white;
        object-fit: cover;
    }

    .follow-plus {
        position: absolute;
        bottom: -8px;
        left: 50%;
        transform: translateX(-50%);
        background: #fe2c55;
        color: white;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .action-btn {
        text-align: center;
        color: white;
        cursor: pointer;
        font-size: 28px;
        text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
    }

    .action-btn span {
        display: block;
        font-size: 12px;
        margin-top: 4px;
        font-weight: 600;
    }

    /* BOTTOM OVERLAY (Captions) */
    .bottom-overlay {
        position: absolute;
        bottom: 40px;
        left: 15px;
        right: 80px; /* Avoid overlapping sidebar */
        color: white;
        z-index: 10;
    }

    .user-handle {
        font-weight: bold;
        font-size: 17px;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 5px;
        text-decoration: none;
        color: white;
    }

    .verified-badge { color: #20d5ec; font-size: 14px; }

    .post-caption {
        font-size: 15px;
        line-height: 1.4;
        margin-bottom: 10px;
    }
</style>

<div class="spotlight-container" id="video-feed">
    {% for post in posts %}
    <div class="spotlight-item">
        <!-- The Video -->
        <video loop playsinline preload="auto" class="spotlight-video">
            <source src="{{ post.preview_url }}" type="video/mp4">
        </video>

        <!-- Right Sidebar (Like, Comment, Share) -->
        <div class="action-sidebar">
            <!-- Profile Pic Link -->
            <div class="profile-link-container">
                <a href="{% url 'profile' post.author.username %}">
                    <img src="{{ post.author.profile.picture.url }}" class="profile-pic-spotlight" alt="profile">
                    <div class="follow-plus"><i class="fa-solid fa-plus"></i></div>
                </a>
            </div>

            <div class="action-btn">
                <i class="fa-solid fa-heart"></i>
                <span>{{ post.likes.count }}</span>
            </div>

            <div class="action-btn">
                <i class="fa-solid fa-comment-dots"></i>
                <span>{{ post.comments.count|default:"0" }}</span>
            </div>

            <div class="action-btn">
                <i class="fa-solid fa-retweet"></i>
                <span>{{ post.reposts.count }}</span>
            </div>

            <div class="action-btn">
                <i class="fa-solid fa-share"></i>
                <span>Share</span>
            </div>
        </div>

        <!-- Bottom Info -->
        <div class="bottom-overlay">
            <a href="{% url 'profile' post.author.username %}" class="user-handle">
                @{{ post.author.username }}
                {% if post.author.profile.is_verify %}
                    <i class="fa-solid fa-circle-check verified-badge"></i>
                {% endif %}
            </a>
            
            <div class="post-caption">
                {% if post.is_repost %}
                    <span style="color: #bbb;">(Repost) {{ post.repost_content|default:"" }}</span><br>
                {% endif %}
                {{ post.get_republished_content|truncatechars:150 }}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<script>
    // Intersection Observer to Autoplay/Pause videos on scroll
    const options = { threshold: 0.7 };
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            const video = entry.target.querySelector('video');
            if (entry.isIntersecting) {
                video.play().catch(() => {});
            } else {
                video.pause();
            }
        });
    }, options);

    document.querySelectorAll('.spotlight-item').forEach(item => {
        observer.observe(item);
    });
</script>


    {% endfor %}
</div>

<script>
    // Handle Auto-play/Pause on scroll
    const options = {
        root: document.querySelector('#video-feed'),
        threshold: 0.6 // Play when 60% of video is visible
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            const video = entry.target.querySelector('video');
            if (entry.isIntersecting) {
                video.play().catch(e => console.log("Auto-play blocked"));
            } else {
                video.pause();
                video.currentTime = 0; // Reset video when scrolled away
            }
        });
    }, options);

    document.querySelectorAll('.spotlight-item').forEach(item => {
        observer.observe(item);
    });

    // Toggle Play/Pause on Click
    document.querySelectorAll('.spotlight-video').forEach(video => {
        video.addEventListener('click', () => {
            if (video.paused) video.play();
            else video.pause();
        });
    });
</script>

