{% include 'header.html' %}
{% load static %}

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    /* Reset and Layout */
    body { background: #000; margin: 0; overflow: hidden; }
    
    .spotlight-wrapper {
        height: 100vh;
        width: 100%;
        background-color: #000;
        display: flex;
        justify-content: center;
    }

    /* Scroll Container */
    .spotlight-container {
        height: 100vh;
        width: 100%;
        max-width: 500px; /* Constrain width for desktop like TikTok */
        overflow-y: scroll;
        scroll-snap-type: y mandatory;
        scrollbar-width: none; /* Firefox */
        position: relative;
    }
    .spotlight-container::-webkit-scrollbar { display: none; } /* Chrome/Safari */

    /* Video Section */
    .spotlight-item {
        height: 100vh;
        width: 100%;
        scroll-snap-align: start;
        position: relative;
        background: #000;
        display: flex;
        align-items: center;
    }

    video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        cursor: pointer;
    }

    /* RIGHT SIDEBAR (Actions) */
    .action-sidebar {
        position: absolute;
        right: 12px;
        bottom: 100px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 18px;
        z-index: 10;
    }

    .profile-wrap {
        position: relative;
        margin-bottom: 10px;
    }

    .profile-pic {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        border: 2px solid #fff;
        object-fit: cover;
    }

    .follow-btn {
        position: absolute;
        bottom: -8px;
        left: 50%;
        transform: translateX(-50%);
        background: #fe2c55;
        color: #fff;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .action-group {
        text-align: center;
        color: #fff;
        cursor: pointer;
    }

    .action-group i {
        font-size: 30px;
        text-shadow: 1px 1px 5px rgba(0,0,0,0.4);
    }

    .action-group span {
        display: block;
        font-size: 12px;
        font-weight: 600;
        margin-top: 4px;
    }

    /* BOTTOM TEXT (Captions) */
    .video-data {
        position: absolute;
        bottom: 30px;
        left: 15px;
        right: 70px;
        color: #fff;
        z-index: 10;
        text-shadow: 1px 1px 5px rgba(0,0,0,0.5);
    }

    .user-name {
        font-weight: 700;
        font-size: 18px;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
        color: #fff;
        text-decoration: none;
    }

    .verified { color: #20d5ec; font-size: 14px; }

    .caption {
        font-size: 15px;
        line-height: 1.4;
        margin-bottom: 5px;
    }

    /* DESKTOP NAVIGATION BUTTONS */
    .desktop-nav {
        position: fixed;
        right: 30px;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        flex-direction: column;
        gap: 15px;
        z-index: 100;
    }

    .nav-circle {
        width: 40px;
        height: 40px;
        background: rgba(255,255,255,0.2);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: 0.3s;
    }
    .nav-circle:hover { background: rgba(255,255,255,0.4); }

    @media (max-width: 768px) {
        .desktop-nav { display: none; }
        .spotlight-container { max-width: 100%; }
    }
</style>

<div class="spotlight-wrapper">
    <!-- Desktop Controls -->
    <div class="desktop-nav">
        <div class="nav-circle" onclick="scrollPrev()"><i class="fa-solid fa-chevron-up"></i></div>
        <div class="nav-circle" onclick="scrollNext()"><i class="fa-solid fa-chevron-down"></i></div>
    </div>

    <div class="spotlight-container" id="spotlight-feed">
        {% for post in posts %}
        <div class="spotlight-item" id="video-{{ forloop.index }}">
            <!-- Video Player -->
            <video loop playsinline preload="auto" class="main-video">
                <source src="{{ post.preview_url }}" type="video/mp4">
            </video>

            <!-- Sidebar -->
            <div class="action-sidebar">
                <div class="profile-wrap">
                    <a href="{% url 'profile' post.author.username %}">
                        <img src="{{ post.author.profile.picture.url }}" class="profile-pic">
                        <div class="follow-btn"><i class="fa-solid fa-plus"></i></div>
                    </a>
                </div>

                <div class="action-group">
                    <i class="fa-solid fa-heart"></i>
                    <span>{{ post.likes.count }}</span>
                </div>

                <div class="action-group">
                    <i class="fa-solid fa-comment-dots"></i>
                    <span>{{ post.comments.count|default:"0" }}</span>
                </div>

                <div class="action-group">
                    <i class="fa-solid fa-share"></i>
                    <span>Share</span>
                </div>
            </div>

            <!-- Bottom Data -->
            <div class="video-data">
                <a href="{% url 'profile' post.author.username %}" class="user-name">
                    @{{ post.author.username }}
                    {% if post.author.profile.is_verify %}
                        <i class="fa-solid fa-circle-check verified"></i>
                    {% endif %}
                </a>
                <div class="caption">
                    {% if post.is_repost %}
                        <strong style="color: #fe2c55;">Repost:</strong> {{ post.repost_content|default:"" }}<br>
                    {% endif %}
                    {{ post.get_republished_content|truncatechars:150 }}
                </div>
            </div>
        </div>
        {% empty %}
        <div class="spotlight-item" style="justify-content: center; color: white;">
            <h3>No Spotlight Videos yet</h3>
        </div>
        {% endfor %}
    </div>
</div>

<script>
    const container = document.getElementById('spotlight-feed');
    const videos = document.querySelectorAll('.main-video');
    const items = document.querySelectorAll('.spotlight-item');
    let currentIndex = 0;

    // --- AUTOPLAY LOGIC ---
    const observerOptions = { threshold: 0.6 };
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            const video = entry.target.querySelector('video');
            if (entry.isIntersecting) {
                video.play().catch(error => console.log("Autoplay blocked by browser"));
            } else {
                video.pause();
                video.currentTime = 0;
            }
        });
    }, observerOptions);

    items.forEach(item => observer.observe(item));

    // --- CLICK TO PLAY/PAUSE ---
    videos.forEach(v => {
        v.addEventListener('click', () => {
            if (v.paused) v.play();
            else v.pause();
        });
    });

    // --- DESKTOP NAVIGATION ---
    function scrollNext() {
        if (currentIndex < items.length - 1) {
            currentIndex++;
            items[currentIndex].scrollIntoView({ behavior: 'smooth' });
        }
    }

    function scrollPrev() {
        if (currentIndex > 0) {
            currentIndex--;
            items[currentIndex].scrollIntoView({ behavior: 'smooth' });
        }
    }

    // Keyboard Support
    window.addEventListener('keydown', (e) => {
        if (e.key === "ArrowDown") {
            e.preventDefault();
            scrollNext();
        } else if (e.key === "ArrowUp") {
            e.preventDefault();
            scrollPrev();
        }
    });

    // Tracking current index during manual scroll
    container.addEventListener('scroll', () => {
        currentIndex = Math.round(container.scrollTop / window.innerHeight);
    });
</script>

