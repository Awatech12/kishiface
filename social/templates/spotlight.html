{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Spotlight - KishiFace</title>
    
    <!-- Scripts & Fonts -->
    <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.7/dist/htmx.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        /* 1. Reset & Global */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body, html { 
            width: 100%; 
            height: 100dvh; 
            background-color: #000; 
            overflow: hidden; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        /* 2. Snapchat Top Bar */
        .snap-header {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: env(safe-area-inset-top) 15px 0 15px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, transparent 100%);
            z-index: 1000;
        }

        .header-left, .header-right { display: flex; align-items: center; gap: 15px; }

        .user-avatar-top {
            width: 38px; height: 38px; border-radius: 50%; border: 2px solid #fff; object-fit: cover;
        }

        .header-icon {
            color: white; font-size: 22px; text-decoration: none; text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            position: relative;
        }

        .spotlight-title {
            color: white; font-weight: 800; font-size: 28px; letter-spacing: 0.5px;
            font-family: 'Billabong', cursive, 'Brush Script MT', cursive;
            margin: 0;
        }

        .badge {
            position: absolute; top: -5px; right: -8px; background: #ff3b30; color: white;
            font-size: 10px; min-width: 16px; height: 16px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; border: 1.5px solid #000;
        }
        .hidden { display: none !important; }

        /* 3. Feed Container */
        .spotlight-wrapper {
            height: 100dvh; width: 100vw; display: flex; justify-content: center; background: #000;
        }

        .spotlight-container {
            height: 100dvh; width: 100%; overflow-y: scroll; scroll-snap-type: y mandatory;
            scrollbar-width: none; position: relative;
        }
        .spotlight-container::-webkit-scrollbar { display: none; }

        @media (min-width: 768px) {
            .spotlight-container { 
                max-width: 450px; 
                border-left: 1px solid #222; 
                border-right: 1px solid #222; 
            }
        }

        .spotlight-item {
            height: 100dvh; 
            width: 100%; 
            scroll-snap-align: start; 
            position: relative;
            background: #000; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            overflow: hidden;
        }

        video { 
            width: 100%; 
            height: 100%; 
            object-fit: contain; 
            cursor: pointer; 
        }

        /* 4. Action Sidebar (Right) */
        .action-sidebar {
            position: absolute; 
            right: 12px; 
            bottom: calc(160px + env(safe-area-inset-bottom)); 
            display: flex;
            flex-direction: column; 
            align-items: center; 
            gap: 20px; 
            z-index: 10;
        }

        .creator-pic-wrap { position: relative; margin-bottom: 10px; }
        .creator-pic { width: 48px; height: 48px; border-radius: 50%; border: 2px solid #fff; object-fit: cover; }
        
        .follow-plus {
            position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%);
            background: #fe2c55; color: #fff; border-radius: 50%; width: 18px; height: 18px;
            font-size: 10px; display: flex; align-items: center; justify-content: center; border: 1.5px solid #fff;
        }

        .action-btn { text-align: center; color: #fff; text-decoration: none; cursor: pointer; background: none; border: none; }
        .action-btn i { font-size: 28px; text-shadow: 0 1px 4px rgba(0,0,0,0.7); transition: color 0.3s; }
        .action-btn span { display: block; font-size: 12px; font-weight: 600; margin-top: 4px; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }

        .reposted { color: #17bf63 !important; }

        /* 5. Bottom Data Overlay */
        .bottom-overlay {
            position: absolute; 
            bottom: calc(20px + env(safe-area-inset-bottom)); 
            left: 15px; 
            right: 15px; 
            color: #fff; 
            z-index: 10;
            pointer-events: none; 
        }
        .bottom-overlay a, .bottom-overlay div, .bottom-overlay button { pointer-events: auto; }

        .handle { font-weight: bold; font-size: 17px; margin-bottom: 5px; color: #fff; text-decoration: none; display: flex; align-items: center; gap: 5px; }
        .caption { 
            font-size: 14px; 
            line-height: 1.4; 
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
            margin-bottom: 15px;
            max-width: 80%;
        }

        /* FACEBOOK STYLE COMMENT BUTTON */
        .fb-comment-bar {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            padding: 10px 18px;
            display: flex;
            align-items: center;
            width: 100%;
            cursor: pointer;
            transition: background 0.2s;
            text-decoration: none;
            color: white;
        }
        .fb-comment-bar:active { background: rgba(255, 255, 255, 0.4); }
        .fb-comment-bar i { margin-right: 10px; font-size: 16px; opacity: 0.9; }
        .fb-comment-bar span { font-size: 14px; opacity: 0.8; }

        /* 6. Desktop Nav Arrows */
        .desktop-nav { position: fixed; right: 30px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 15px; z-index: 20; }
        .nav-circle { width: 45px; height: 45px; border-radius: 50%; background: rgba(255,255,255,0.1); color: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid rgba(255,255,255,0.2); transition: background 0.3s; }
        .nav-circle:hover { background: rgba(255,255,255,0.3); }
        @media (max-width: 1024px) { .desktop-nav { display: none; } }

        /* Logout Modal */
        .logout-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 2000; justify-content: center; align-items: center; }
        .logout-modal.active { display: flex; }
        .logout-modal-content { background: white; border-radius: 12px; padding: 24px; width: 320px; text-align: center; }
        .logout-modal-btn { padding: 12px; border: none; border-radius: 8px; width: 100%; margin-top: 10px; cursor: pointer; font-weight: bold; }
    
        .is-liked { color: #fe2c55 !important; animation: pop 0.3s ease; }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.4); } 100% { transform: scale(1); } }

        /* REPOST MODAL STYLES */
        .kf-repost-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center;
            z-index: 3000; opacity: 0; visibility: hidden; transition: 0.3s;
        }
        .kf-repost-modal.show { opacity: 1; visibility: visible; }
        .kf-repost-modal-content { background: #fff; border-radius: 16px; width: 90%; max-width: 400px; padding: 20px; }
        .kf-repost-modal-header { text-align: center; font-weight: 700; font-size: 18px; margin-bottom: 15px; color: #000; }
        .kf-repost-textarea { width: 100%; border: 1px solid #ddd; border-radius: 10px; padding: 12px; font-family: inherit; font-size: 14px; resize: none; min-height: 100px; margin-bottom: 5px; }
        .kf-repost-modal-footer { display: flex; gap: 10px; margin-top: 15px; }
        .kf-repost-btn { flex: 1; background: #17bf63; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .kf-repost-cancel-btn { flex: 1; background: #eee; color: #333; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; }

        /* Toast Notification */
        .kf-toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px;
            font-size: 14px; z-index: 4000; pointer-events: none;
        }
    </style>
</head>
<body>

<header class="snap-header">
    <div class="header-left">
        <a href="{% url 'profile' request.user.username %}">
            <img src="{{ request.user.profile.picture.url }}" class="user-avatar-top" alt="Me">
        </a>
        <a href="{% url 'home' %}" class="header-icon"><i class="fa-solid fa-house"></i></a>
    </div>

    <div class="spotlight-title">KishiFace</div>

    <div class="header-right">
        <a href="{% url 'post' %}" class="header-icon"><i class="fa-solid fa-plus-square"></i></a>
        <a href="{% url 'notification_list' %}" class="header-icon">
            <i class="fa-regular fa-bell"></i>
            <span class="badge {% if unread_notifications_count == 0 %}hidden{% endif %}" id="headerBadge">
                <span hx-get="{% url 'notification_partial' %}">
                    {{ unread_notifications_count|default:0 }}
                </span>
            </span>
        </a>
        <a href="#" class="header-icon" id="logoutTrigger"><i class="fa-solid fa-right-from-bracket"></i></a>
    </div>
</header>

<!-- Logout Modal -->
<div class="logout-modal" id="logoutModal">
    <div class="logout-modal-content">
        <h3 style="color: black;">Log Out?</h3>
        <button class="logout-modal-btn" style="background: #ff4444; color: white;" onclick="window.location.href='{% url 'logout' %}'">Log Out</button>
        <button class="logout-modal-btn" style="background: #eee; color: black;" id="closeLogout">Cancel</button>
    </div>
</div>

<div class="spotlight-wrapper">
    <div class="desktop-nav">
        <div class="nav-circle" onclick="goPrev()"><i class="fa-solid fa-chevron-up"></i></div>
        <div class="nav-circle" onclick="goNext()"><i class="fa-solid fa-chevron-down"></i></div>
    </div>

    <div class="spotlight-container" id="spotlight-feed">
        {% for post in posts %}
        <div class="spotlight-item">
            <video loop playsinline preload="auto" class="post-video">
                <source src="{{ post.preview_url }}" type="video/mp4">
            </video>

            <!-- Sidebar -->
            <div class="action-sidebar">
                <div class="creator-pic-wrap">
                    <a href="{% url 'profile' post.author.username %}">
                        <img src="{{ post.author.profile.picture.url }}" class="creator-pic">
                        {% if request.user.is_authenticated and request.user != post.author and request.user.profile not in post.author.profile.followers.all %}
                            <div class="follow-plus"><i class="fa-solid fa-plus"></i></div>
                        {% endif %}
                    </a>
                </div>

                <button class="action-btn spotlight-like-btn" data-post-id="{{ post.post_id }}">
                    <i class="fa-solid fa-heart {% if request.user in post.likes.all %}is-liked{% endif %}"></i>
                    <span class="like-count-text">{{ post.likes.count }}</span>
                </button>

                <!-- REPOST BUTTON -->
                <button class="action-btn spotlight-repost-btn" 
                        onclick="kfToggleRepost('{% if post.is_repost and post.original_post %}{{ post.original_post.post_id }}{% else %}{{ post.post_id }}{% endif %}', this)"
                        data-reposted="{% if request.user in post.reposts.all %}true{% else %}false{% endif %}">
                    <i class="fa-solid fa-retweet {% if request.user in post.reposts.all %}reposted{% endif %}"></i>
                    <span class="repost-count-text">{{ post.reposts.count|default:"0" }}</span>
                </button>

                <a href="{% url 'post_comment' post.post_id %}" class="action-btn">
                    <i class="fa-solid fa-comment-dots"></i>
                    <span>{{ post.comments.count|default:"0" }}</span>
                </a>

                <div class="action-btn">
                    <i class="fa-solid fa-share"></i>
                    <span>Share</span>
                </div>
            </div>

            <!-- Bottom Data Overlay -->
            <div class="bottom-overlay">
                <a href="{% url 'profile' post.author.username %}" class="handle">
                    @{{ post.author.username }}
                    {% if post.author.profile.is_verify %}
                        <i class="fa-solid fa-circle-check" style="color: #20d5ec;"></i>
                    {% endif %}
                </a>
                
                <div class="caption">
                    {% if post.is_repost %}
                        <strong style="color: #17bf63;"><i class="fa-solid fa-retweet"></i> Repost:</strong> {{ post.repost_content|default:"" }}<br>
                    {% endif %}
                    {{ post.get_republished_content|truncatechars:150 }}
                </div>

                <a href="{% url 'post_comment' post.post_id %}" class="fb-comment-bar">
                    <i class="fa-regular fa-comment"></i>
                    <span>Write a comment...</span>
                </a>
            </div>
        </div>
        {% empty %}
        <div class="spotlight-item" style="color: white; flex-direction: column;">
            <i class="fa-solid fa-video-slash" style="font-size: 40px; margin-bottom: 10px;"></i>
            <p>No videos available.</p>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Repost Modal -->
<div class="kf-repost-modal" id="kf-repost-modal">
    <div class="kf-repost-modal-content">
        <div class="kf-repost-modal-header">Repost Spotlight</div>
        <textarea class="kf-repost-textarea" id="kf-repost-caption" placeholder="Add a comment to your repost..." maxlength="500"></textarea>
        <div style="font-size: 12px; color: #888; text-align: right;">
            <span id="kf-repost-char-count">0</span>/500
        </div>
        <div class="kf-repost-modal-footer">
            <button class="kf-repost-cancel-btn" onclick="kfCloseRepostModal()">Cancel</button>
            <button class="kf-repost-btn" id="kf-repost-confirm-btn">Repost</button>
        </div>
    </div>
</div>

<script>
    const feed = document.getElementById('spotlight-feed');
    const items = document.querySelectorAll('.spotlight-item');
    const videos = document.querySelectorAll('.post-video');
    let currentIndex = 0;

    // Like Logic
    document.addEventListener('DOMContentLoaded', () => {
        feed.addEventListener('click', async (e) => {
            const btn = e.target.closest('.spotlight-like-btn');
            if (!btn) return;
            const postId = btn.getAttribute('data-post-id');
            const icon = btn.querySelector('i');
            const countLabel = btn.querySelector('.like-count-text');
            try {
                const response = await fetch(`/like/${postId}`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                if (response.ok) {
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const wrapper = doc.querySelector('.engagement-wrapper');
                    if (wrapper) {
                        countLabel.innerText = wrapper.getAttribute('data-like-count');
                        if (wrapper.getAttribute('data-is-liked') === 'true') {
                            icon.classList.add('is-liked');
                        } else {
                            icon.classList.remove('is-liked');
                        }
                    }
                }
            } catch (err) { console.error("Error:", err); }
        });
    });

    // --- REPOST LOGIC ---
    let currentRepostPostId = null;
    let currentRepostButton = null;

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'kf-toast';
        toast.innerText = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2500);
    }

    function kfToggleRepost(postId, button) {
        currentRepostPostId = postId;
        currentRepostButton = button;
        const isReposted = button.getAttribute('data-reposted') === 'true';
        if (isReposted) {
            kfPerformRepost(postId, '', true);
        } else {
            const modal = document.getElementById('kf-repost-modal');
            const textarea = document.getElementById('kf-repost-caption');
            textarea.value = '';
            document.getElementById('kf-repost-char-count').innerText = '0';
            modal.classList.add('show');
            textarea.focus();
        }
    }

    function kfCloseRepostModal() {
        document.getElementById('kf-repost-modal').classList.remove('show');
    }

    document.getElementById('kf-repost-confirm-btn').onclick = function() {
        const caption = document.getElementById('kf-repost-caption').value;
        kfPerformRepost(currentRepostPostId, caption, false);
        kfCloseRepostModal();
    };

    document.getElementById('kf-repost-caption').oninput = function() {
        document.getElementById('kf-repost-char-count').innerText = this.value.length;
    };

    function kfPerformRepost(postId, caption, undo = false) {
        const btn = currentRepostButton;
        const icon = btn.querySelector('i');
        const countSpan = btn.querySelector('.repost-count-text');
        const csrftoken = getCookie('csrftoken');

        fetch(`/repost/${postId}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrftoken, 'Content-Type': 'application/json' },
            body: JSON.stringify({ caption: caption, undo: undo })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                showToast(data.message);
                if (data.reposted) {
                    btn.setAttribute('data-reposted', 'true');
                    icon.classList.add('reposted');
                } else {
                    btn.setAttribute('data-reposted', 'false');
                    icon.classList.remove('reposted');
                }
                countSpan.innerText = data.repost_count;
            } else {
                showToast(data.error);
            }
        }).catch(err => showToast("Error connecting to server"));
    }

    // Autoplay logic
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            const video = entry.target.querySelector('video');
            if (entry.isIntersecting) {
                if (video) video.play().catch(() => {});
            } else {
                if (video) { video.pause(); video.currentTime = 0; }
            }
        });
    }, { threshold: 0.7 });
    items.forEach(item => observer.observe(item));

    // Play/Pause on tap
    videos.forEach(v => {
        v.addEventListener('click', () => {
            if (v.paused) v.play(); else v.pause();
        });
    });

    function goNext() {
        if (currentIndex < items.length - 1) {
            currentIndex++;
            items[currentIndex].scrollIntoView({ behavior: 'smooth' });
        }
    }
    function goPrev() {
        if (currentIndex > 0) {
            currentIndex--;
            items[currentIndex].scrollIntoView({ behavior: 'smooth' });
        }
    }

    window.addEventListener('keydown', (e) => {
        if (e.key === "ArrowDown") { e.preventDefault(); goNext(); }
        else if (e.key === "ArrowUp") { e.preventDefault(); goPrev(); }
    });

    feed.addEventListener('scroll', () => {
        currentIndex = Math.round(feed.scrollTop / window.innerHeight);
    });

    const logoutTrigger = document.getElementById('logoutTrigger');
    const logoutModal = document.getElementById('logoutModal');
    const closeLogout = document.getElementById('closeLogout');
    logoutTrigger.addEventListener('click', (e) => { e.preventDefault(); logoutModal.classList.add('active'); });
    closeLogout.addEventListener('click', () => { logoutModal.classList.remove('active'); });
    window.onclick = function(event) { if (event.target == logoutModal) { logoutModal.classList.remove('active'); } }
</script>

</body>
</html>