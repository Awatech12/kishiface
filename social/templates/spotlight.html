{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Spotlight - KishiFace</title>
    
    <!-- Scripts & Fonts -->
    <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.7/dist/htmx.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        /* 1. Reset & Global */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body, html { 
            width: 100%; 
            height: 100dvh; /* Uses dynamic viewport height for mobile compatibility */
            background-color: #000; 
            overflow: hidden; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        /* 2. Snapchat Top Bar */
        .snap-header {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: env(safe-area-inset-top) 15px 0 15px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, transparent 100%);
            z-index: 1000;
        }

        .header-left, .header-right { display: flex; align-items: center; gap: 15px; }

        .user-avatar-top {
            width: 38px; height: 38px; border-radius: 50%; border: 2px solid #fff; object-fit: cover;
        }

        .header-icon {
            color: white; font-size: 22px; text-decoration: none; text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            position: relative;
        }

        .spotlight-title {
            color: white; font-weight: 800; font-size: 20px; letter-spacing: 0.5px;
            font-family: 'Billabong', cursive, 'Brush Script MT', cursive;
            font-size: 28px;
            margin: 0;
        }

        /* Notification Badge */
        .badge {
            position: absolute; top: -5px; right: -8px; background: #ff3b30; color: white;
            font-size: 10px; min-width: 16px; height: 16px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; border: 1.5px solid #000;
        }
        .hidden { display: none !important; }

        /* 3. Feed Container */
        .spotlight-wrapper {
            height: 100dvh; width: 100vw; display: flex; justify-content: center; background: #000;
        }

        .spotlight-container {
            height: 100dvh; width: 100%; overflow-y: scroll; scroll-snap-type: y mandatory;
            scrollbar-width: none; position: relative;
        }
        .spotlight-container::-webkit-scrollbar { display: none; }

        /* Desktop Optimization */
        @media (min-width: 768px) {
            .spotlight-container { 
                max-width: 450px; 
                border-left: 1px solid #222; 
                border-right: 1px solid #222; 
            }
        }

        .spotlight-item {
            height: 100dvh; 
            width: 100%; 
            scroll-snap-align: start; 
            position: relative;
            background: #000; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            overflow: hidden;
        }

        video { 
            width: 100%; 
            height: 100%; 
            object-fit: normal; /* Important: Ensures video fills screen without gaps */
            cursor: pointer; 
        }

        /* 4. Action Sidebar (Right) */
        .action-sidebar {
            position: absolute; 
            right: 12px; 
            bottom: calc(100px + env(safe-area-inset-bottom)); 
            display: flex;
            flex-direction: column; 
            align-items: center; 
            gap: 20px; 
            z-index: 10;
        }

        .creator-pic-wrap { position: relative; margin-bottom: 10px; }
        .creator-pic { width: 48px; height: 48px; border-radius: 50%; border: 2px solid #fff; object-fit: cover; }
        
        .follow-plus {
            position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%);
            background: #fe2c55; color: #fff; border-radius: 50%; width: 18px; height: 18px;
            font-size: 10px; display: flex; align-items: center; justify-content: center; border: 1.5px solid #fff;
        }

        .action-btn { text-align: center; color: #fff; text-decoration: none; cursor: pointer; background: none; border: none; }
        .action-btn i { font-size: 28px; text-shadow: 0 1px 4px rgba(0,0,0,0.7); }
        .action-btn span { display: block; font-size: 12px; font-weight: 600; margin-top: 4px; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }

        /* 5. Bottom Data Overlay */
        .bottom-overlay {
            position: absolute; 
            bottom: calc(30px + env(safe-area-inset-bottom)); 
            left: 15px; 
            right: 80px; 
            color: #fff; 
            z-index: 10;
            pointer-events: none; /* Allows clicks to pass through to video for pause/play */
        }
        .bottom-overlay a, .bottom-overlay div { pointer-events: auto; }

        .handle { font-weight: bold; font-size: 17px; margin-bottom: 8px; color: #fff; text-decoration: none; display: flex; align-items: center; gap: 5px; }
        .caption { 
            font-size: 15px; 
            line-height: 1.4; 
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* 6. Desktop Nav Arrows */
        .desktop-nav { position: fixed; right: 30px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 15px; z-index: 20; }
        .nav-circle { width: 45px; height: 45px; border-radius: 50%; background: rgba(255,255,255,0.1); color: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid rgba(255,255,255,0.2); transition: background 0.3s; }
        .nav-circle:hover { background: rgba(255,255,255,0.3); }
        @media (max-width: 1024px) { .desktop-nav { display: none; } }

        /* Logout Modal */
        .logout-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 2000; justify-content: center; align-items: center; }
        .logout-modal.active { display: flex; }
        .logout-modal-content { background: white; border-radius: 12px; padding: 24px; width: 320px; text-align: center; }
        .logout-modal-btn { padding: 12px; border: none; border-radius: 8px; width: 100%; margin-top: 10px; cursor: pointer; font-weight: bold; }
    
        /* Spotlight Like Color */
        .is-liked { color: #fe2c55 !important; animation: pop 0.3s ease; }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.4); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

<!-- Snapchat Top Bar -->
<header class="snap-header">
    <div class="header-left">
        <a href="{% url 'profile' request.user.username %}">
            <img src="{{ request.user.profile.picture.url }}" class="user-avatar-top" alt="Me">
        </a>
        <a href="{% url 'home' %}" class="header-icon"><i class="fa-solid fa-house"></i></a>
    </div>

    <div class="spotlight-title">KishiFace</div>

    <div class="header-right">
        <a href="{% url 'post' %}" class="header-icon"><i class="fa-solid fa-plus-square"></i></a>
        <a href="{% url 'notification_list' %}" class="header-icon">
            <i class="fa-regular fa-bell"></i>
            <span class="badge {% if unread_notifications_count == 0 %}hidden{% endif %}" id="headerBadge">
                <span hx-get="{% url 'notification_partial' %}">
                    {{ unread_notifications_count|default:0 }}
                </span>
            </span>
        </a>
        <a href="#" class="header-icon" id="logoutTrigger"><i class="fa-solid fa-right-from-bracket"></i></a>
    </div>
</header>

<!-- Logout Modal -->
<div class="logout-modal" id="logoutModal">
    <div class="logout-modal-content">
        <h3 style="color: black;">Log Out?</h3>
        <button class="logout-modal-btn" style="background: #ff4444; color: white;" onclick="window.location.href='{% url 'logout' %}'">Log Out</button>
        <button class="logout-modal-btn" style="background: #eee; color: black;" id="closeLogout">Cancel</button>
    </div>
</div>

<div class="spotlight-wrapper">
    <!-- Desktop Controls -->
    <div class="desktop-nav">
        <div class="nav-circle" onclick="goPrev()"><i class="fa-solid fa-chevron-up"></i></div>
        <div class="nav-circle" onclick="goNext()"><i class="fa-solid fa-chevron-down"></i></div>
    </div>

    <div class="spotlight-container" id="spotlight-feed">
        {% for post in posts %}
        <div class="spotlight-item">
            <video loop playsinline preload="auto" class="post-video">
                <source src="{{ post.preview_url }}" type="video/mp4">
            </video>

            <!-- spotlight Sidebar -->
            <div class="action-sidebar">
                <div class="creator-pic-wrap">
                    <a href="{% url 'profile' post.author.username %}">
                        <img src="{{ post.author.profile.picture.url }}" class="creator-pic">
                        {% if request.user.is_authenticated and request.user != post.author and request.user.profile not in post.author.profile.followers.all %}
                            <div class="follow-plus"><i class="fa-solid fa-plus"></i></div>
                        {% endif %}
                    </a>
                </div>

                <button class="action-btn spotlight-like-btn" data-post-id="{{ post.post_id }}">
                    <i class="fa-solid fa-heart {% if request.user in post.likes.all %}is-liked{% endif %}"></i>
                    <span class="like-count-text">{{ post.likes.count }}</span>
                </button>

                <a href="{% url 'post_comment' post.post_id %}" class="action-btn">
                    <i class="fa-solid fa-comment-dots"></i>
                    <span>{{ post.comments.count|default:"0" }}</span>
                </a>

                <div class="action-btn">
                    <i class="fa-solid fa-share"></i>
                    <span>Share</span>
                </div>
            </div>

            <!-- Bottom Caption -->
            <div class="bottom-overlay">
                <a href="{% url 'profile' post.author.username %}" class="handle">
                    @{{ post.author.username }}
                    {% if post.author.profile.is_verify %}
                        <i class="fa-solid fa-circle-check" style="color: #20d5ec;"></i>
                    {% endif %}
                </a>
                <div class="caption">
                    {% if post.is_repost %}
                        <strong style="color: #fe2c55;">Repost:</strong> {{ post.repost_content|default:"" }}<br>
                    {% endif %}
                    {{ post.get_republished_content|truncatechars:150 }}
                </div>
            </div>
        </div>
        {% empty %}
        <div class="spotlight-item" style="color: white; flex-direction: column;">
            <i class="fa-solid fa-video-slash" style="font-size: 40px; margin-bottom: 10px;"></i>
            <p>No videos available.</p>
        </div>
        {% endfor %}
    </div>
</div>

<script>
    const feed = document.getElementById('spotlight-feed');
    const items = document.querySelectorAll('.spotlight-item');
    const videos = document.querySelectorAll('.post-video');
    let currentIndex = 0;

    // --- 1. SPOTLIGHT LIKE API LOGIC ---
    document.addEventListener('DOMContentLoaded', () => {
        const feed = document.getElementById('spotlight-feed');

        feed.addEventListener('click', async (e) => {
            const btn = e.target.closest('.spotlight-like-btn');
            if (!btn) return;

            const postId = btn.getAttribute('data-post-id');
            const icon = btn.querySelector('i');
            const countLabel = btn.querySelector('.like-count-text');
            
            const url = `/like/${postId}`; 

            try {
                const response = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                if (response.ok) {
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const wrapper = doc.querySelector('.engagement-wrapper');

                    if (wrapper) {
                        const newCount = wrapper.getAttribute('data-like-count');
                        const isLiked = wrapper.getAttribute('data-is-liked') === 'true';

                        countLabel.innerText = newCount;
                        if (isLiked) {
                            icon.classList.add('is-liked');
                        } else {
                            icon.classList.remove('is-liked');
                        }
                    }
                }
            } catch (err) { console.error("Error:", err); }
        });
    });


    // --- 2. VIDEO AUTOPLAY LOGIC ---
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            const video = entry.target.querySelector('video');
            if (entry.isIntersecting) {
                if (video) video.play().catch(() => {});
            } else {
                if (video) { video.pause(); video.currentTime = 0; }
            }
        });
    }, { threshold: 0.7 });

    items.forEach(item => observer.observe(item));

    // --- 3. CLICK PLAY/PAUSE ---
    videos.forEach(v => {
        v.addEventListener('click', () => {
            if (v.paused) v.play(); else v.pause();
        });
    });

    // --- 4. NAVIGATION (Desktop & Keyboard) ---
    function goNext() {
        if (currentIndex < items.length - 1) {
            currentIndex++;
            items[currentIndex].scrollIntoView({ behavior: 'smooth' });
        }
    }
    function goPrev() {
        if (currentIndex > 0) {
            currentIndex--;
            items[currentIndex].scrollIntoView({ behavior: 'smooth' });
        }
    }

    window.addEventListener('keydown', (e) => {
        if (e.key === "ArrowDown") { e.preventDefault(); goNext(); }
        else if (e.key === "ArrowUp") { e.preventDefault(); goPrev(); }
    });

    feed.addEventListener('scroll', () => {
        currentIndex = Math.round(feed.scrollTop / window.innerHeight);
    });

    // --- 5. LOGOUT MODAL LOGIC ---
    const logoutTrigger = document.getElementById('logoutTrigger');
    const logoutModal = document.getElementById('logoutModal');
    const closeLogout = document.getElementById('closeLogout');

    logoutTrigger.addEventListener('click', (e) => {
        e.preventDefault();
        logoutModal.classList.add('active');
    });

    closeLogout.addEventListener('click', () => {
        logoutModal.classList.remove('active');
    });

    window.onclick = function(event) {
        if (event.target == logoutModal) {
            logoutModal.classList.remove('active');
        }
    }
</script>

</body>
</html>
