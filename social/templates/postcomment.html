{% load humanize %}
{% load static %}
{% load time %}
{% load text_filters %}  <!-- ADD THIS LINE -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kishiface - Post</title>
  <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.7/dist/htmx.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
 
  <link rel="stylesheet" href="{% static 'css/postcomment.css' %}">
 
  <!-- Additional CSS for text formatting -->
  <style>
    /* Text formatting styles from home.html */
    .kf-post-content {
      padding: 0 16px 12px;
      font-size: 14px;
      line-height: 1.5;
      position: relative;
    }
    
    .kf-post-text {
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    
    .kf-post-text.collapsed {
      max-height: 60px; /* Show about 3 lines */
    }
    
    .kf-post-text.expanded {
      max-height: 1000px; /* Enough for expanded text */
    }
    
    /* Paragraph styling */
    .kf-post-paragraph {
      margin-bottom: 10px;
      line-height: 1.5;
    }
    
    .kf-post-paragraph:last-child {
      margin-bottom: 0;
    }
    
    /* Link styling for formatted text */
    .kf-post-paragraph a,
    .kf-post-text a {
      color: var(--kf-primary);
      text-decoration: none;
      font-weight: 500;
    }
    
    .kf-post-paragraph a:hover,
    .kf-post-text a:hover {
      text-decoration: underline;
    }
    
    /* Mention link styling */
    .kf-mention-link {
      color: var(--kf-primary);
      text-decoration: none;
      font-weight: 600;
      background: rgba(0, 149, 246, 0.1);
      padding: 0 2px;
      border-radius: 3px;
    }
    
    .kf-mention-link:hover {
      text-decoration: underline;
      background: rgba(0, 149, 246, 0.2);
    }
    
    /* URL link styling */
    .kf-url-link {
      color: var(--kf-primary);
      text-decoration: none;
      font-weight: 500;
      word-break: break-word;
    }
    
    .kf-url-link:hover {
      text-decoration: underline;
    }
    
    /* BB Code styling */
    .kf-post-paragraph strong,
    .kf-post-paragraph b {
      font-weight: 700;
    }
    
    .kf-post-paragraph em,
    .kf-post-paragraph i {
      font-style: italic;
    }
    
    .kf-post-paragraph u {
      text-decoration: underline;
    }
    
    .kf-text-toggle {
      background: none;
      border: none;
      color: var(--kf-text-light);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      padding: 4px 0;
      margin-top: 4px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    
    .kf-text-toggle:hover {
      color: var(--kf-text);
    }
    
    .kf-text-toggle i {
      font-size: 12px;
    }
    
    /* Repost caption styling */
    .kf-repost-caption-container {
      padding: 12px 16px 0 16px;
      background: white;
    }
    
    .kf-repost-caption {
      padding: 10px;
      background: var(--kf-white);
      border: 1px solid whitesmoke;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.5;
      color: var(--kf-text);
    }
    
    .kf-repost-caption-author {
      font-weight: 600;
      color: var(--kf-repost);
      display: block;
      margin-bottom: 4px;
    }
    
    .kf-repost-caption-text {
      color: var(--kf-text);
    }
  </style>
</head>
<body>
{% include 'header.html' %}

<main class="kf-desktop-layout">
  <!-- Left Sidebar - Main Navigation -->
  <aside class="kf-left-sidebar">
    <!-- Desktop Navigation (Instagram Style - Icon + Text inline) -->
    <div class="kf-desktop-nav">
      <!-- Home -->
      <a href="{% url 'home' %}" class="kf-desktop-nav-item" title="Home">
        <div class="kf-desktop-nav-icon">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-width="2" d="M3 12l9-9 9 9M4 10v10h16V10" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <span class="kf-desktop-nav-label">Home</span>
      </a>
      
      <!-- Explore Users -->
      <a href="{% url 'explore' %}" class="kf-desktop-nav-item" title="Explore Users">
        <div class="kf-desktop-nav-icon">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M12 21a9 9 0 100-18 9 9 0 000 18z"/>
            <path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M8.25 15.75l1.5-1.5 2.25 2.25 4.5-4.5 1.5 1.5-6 6z"/>
            <circle cx="18" cy="6" r="1.5" stroke-width="2"/>
          </svg>
          {% if unread_follow_count and unread_follow_count > 0 %}
          <span class="kf-desktop-notification-badge">{{ unread_follow_count }}</span>
          {% endif %}
        </div>
        <span class="kf-desktop-nav-label">Explore</span>
      </a>
      
      <!-- Search -->
      <a href="{% url 'search' %}" class="kf-desktop-nav-item" title="Search">
        <div class="kf-desktop-nav-icon">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <line x1="21" y1="21" x2="16.65" y2="16.65" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <span class="kf-desktop-nav-label">Search</span>
      </a>
      
      <!-- Create Post -->
      <a href="{% url 'post' %}" class="kf-desktop-nav-item" title="Create Post">
        <div class="kf-desktop-nav-icon">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10" stroke-width="2"/>
            <line x1="12" y1="8" x2="12" y2="16" stroke-width="2"/>
            <line x1="8" y1="12" x2="16" y2="12" stroke-width="2"/>
          </svg>
        </div>
        <span class="kf-desktop-nav-label">Create</span>
      </a>
      
      <!-- Notifications -->
      <a href="{% url 'notification_list' %}" class="kf-desktop-nav-item" title="Notifications">
        <div class="kf-desktop-nav-icon">
          <i class="fa-regular fa-bell" style="font-size: 20px; color: var(--kf-text-light);"></i>
          {% if unread_notifications_count and unread_notifications_count > 0 %}
          <span class="kf-desktop-notification-badge">{{ unread_notifications_count }}</span>
          {% endif %}
        </div>
        <span class="kf-desktop-nav-label">Alerts</span>
      </a>
      
      <!-- Profile -->
      <a href="{% url 'profile' request.user.username %}" class="kf-desktop-nav-item" title="Profile">
        <div class="kf-desktop-nav-icon">
          <i class="fa-regular fa-user" style="font-size: 20px; color: var(--kf-text-light);"></i>
        </div>
        <span class="kf-desktop-nav-label">Profile</span>
      </a>
      
      <!-- Marketplace -->
      <a href="{% url 'market' %}" class="kf-desktop-nav-item" title="Marketplace">
        <div class="kf-desktop-nav-icon">
          <i class="fa-solid fa-store" style="font-size: 20px; color: var(--kf-text-light);"></i>
        </div>
        <span class="kf-desktop-nav-label">Marketplace</span>
      </a>
      
      <!-- Logout -->
      <a href="#" class="kf-desktop-nav-item logout" title="Log Out" id="desktopLogoutIcon">
        <div class="kf-desktop-nav-icon">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
          </svg>
        </div>
        <span class="kf-desktop-nav-label">Logout</span>
      </a>
    </div>
  </aside>

  <!-- Main Post Section (Center) -->
  <div class="kf-main-post-section">
    <article class="kf-post" data-post-id="{{ post.post_id }}">
      {% if post.is_repost and post.original_post %}
      <div class="kf-repost-header">
        <i class="fas fa-retweet"></i>
        <span>
          <a href="{% url 'profile' post.author.username %}">{{ post.author.first_name }} {{ post.author.last_name }}</a>
          reposted
        </span>
      </div>
      {% endif %}
      
      <div class="kf-post-header">
        <img 
          src="{% if post.is_repost and post.original_post %}{{ post.original_post.author.profile.picture.url }}{% else %}{{ post.author.profile.picture.url }}{% endif %}" 
          class="kf-profile-pic"
          alt="{% if post.is_repost and post.original_post %}{{ post.original_post.author.username }}{% else %}{{ post.author.username }}{% endif %}"
          loading="lazy"
        >
        <div>
          <a href="{% url 'profile' username=post.get_original_author.username %}" class="kf-username" data-user="{% if post.is_repost and post.original_post %}{{ post.original_post.author.username }}{% else %}{{ post.author.username }}{% endif %}">
            {% if post.is_repost and post.original_post %}
              {{ post.original_post.author.first_name }} {{ post.original_post.author.last_name }}
            {% else %}
              {{ post.author.first_name }} {{ post.author.last_name }}
            {% endif %}
            {% if post.is_repost and post.original_post %}
              {% if post.original_post.author.profile.is_verify %} 
                <img src="{% static 'images/verify1.jpg' %}" height="16" width="16" alt="✓" style="vertical-align: middle;">
              {% endif %}
            {% else %}
              {% if post.author.profile.is_verify and post.author.first_name %} 
                <img src="{% static 'images/verify1.jpg' %}" height="16" width="16" alt="✓" style="vertical-align: middle;">
              {% endif %}
            {% endif %}
          </a>
          <div class="kf-post-time">
            {% if post.is_repost %}
              @{% if post.original_post %}{{ post.original_post.author.username }}{% else %}{{ post.author.username }}{% endif %}
              · Original post: {{ post.original_post.created_at|insta_timesince }}
              · Reposted: {{ post.created_at|insta_timesince }}
            {% else %}
              @{{ post.author.username }} · {{ post.created_at|insta_timesince }}
            {% endif %}
          </div>
        </div>
        <div class="kf-post-actions">
          <button class="kf-repost-icon" 
                  title="Repost" 
                  onclick="kfToggleRepost('{% if post.is_repost and post.original_post %}{{ post.original_post.post_id }}{% else %}{{ post.post_id }}{% endif %}', this)"
                  data-reposted="{% if request.user in post.reposts.all %}true{% else %}false{% endif %}">
            <i class="fas fa-retweet {% if request.user in post.reposts.all %}reposted{% endif %}"></i>
            <span class="kf-repost-count {% if post.reposts.count > 0 %}show{% endif %}" id="kf-repost-count-{{ post.post_id }}">
              {% if post.reposts.count > 0 %}{{ post.reposts.count }}{% endif %}
            </span>
          </button>
          
          {% if request.user == post.author and not post.is_repost %}
            <a href="{% url 'editpost' post.post_id %}" title="Edit" class="kf-edit-icon">
              <i class="fas fa-edit"></i>
            </a>
          {% endif %}
        </div>
      </div>

      {% if post.is_repost and post.repost_content %}
      <div class="kf-repost-caption-container">
        <div class="kf-repost-caption">
          <span class="kf-repost-caption-author">
            {{ post.author.first_name }} {{ post.author.last_name }}
            {% if post.author.profile.is_verify %} 
              <img src="{% static 'images/verify1.jpg' %}" height="14" width="14" alt="✓" style="vertical-align: middle;">
            {% endif %}
          </span>
          <div class="kf-repost-caption-text">
            <!-- UPDATED: Use format_post_text filter -->
            {{ post.repost_content|format_post_text|safe }}
          </div>
        </div>
      </div>
      {% endif %}

      {% if post.content or post.is_repost %}
      <div class="kf-post-content">
        <div class="kf-post-text collapsed" id="kf-text-{{ post.post_id }}">
          {% if post.is_repost and post.original_post %}
            <!-- UPDATED: Use format_post_text filter -->
            {{ post.original_post.content|format_post_text|safe }}
          {% else %}
            <!-- UPDATED: Use format_post_text filter -->
            {{ post.content|format_post_text|safe }}
          {% endif %}
        </div>
        {% if post.is_repost and post.original_post %}
          {% if post.original_post.content|length > 150 %}
          <button class="kf-text-toggle" onclick="kfToggleText('{{ post.post_id }}')">
            <span>more</span>
            <i class="fas fa-chevron-down"></i>
          </button>
          {% endif %}
        {% else %}
          {% if post.content|length > 150 %}
          <button class="kf-text-toggle" onclick="kfToggleText('{{ post.post_id }}')">
            <span>more</span>
            <i class="fas fa-chevron-down"></i>
          </button>
          {% endif %}
        {% endif %}
      </div>
      {% endif %}

      {% if post.is_repost and post.original_post %}
        {% with original_post=post.original_post %}
          {% if original_post.file or original_post.video_file or original_post.images.all %}
          <div class="kf-media-container">
            {% if original_post.file %}
            <div class="kf-audio-player" id="kf-audio-{{ post.post_id }}">
              <button class="kf-audio-download-btn" 
                      title="Download Audio" 
                      onclick="kfDownloadAudio('{{ original_post.post_id }}', '{{ original_post.file.url }}')">
                <i class="fas fa-download"></i>
              </button>
              
              <div class="kf-audio-cover" 
                   style="background-image: url('{% if original_post.images.first %}{{ original_post.images.first.image.url }}{% else %}{{ original_post.author.profile.picture.url }}{% endif %}');">
                <button class="kf-audio-play-btn" onclick="kfToggleAudio('{{ post.post_id }}')">
                  <i class="fas fa-play" id="kf-audio-icon-{{ post.post_id }}"></i>
                </button>
              </div>
              <div class="kf-audio-controls">
                <div class="kf-audio-info">
                  <span class="kf-audio-title">Audio Post</span>
                  <span class="kf-audio-time" id="kf-audio-time-{{ post.post_id }}">0:00</span>
                </div>
                <div class="kf-audio-progress" onclick="kfSeekAudio(event, '{{ post.post_id }}')">
                  <div class="kf-audio-progress-bar" id="kf-audio-progress-{{ post.post_id }}"></div>
                </div>
                <div class="kf-audio-seek-buttons">
                  <button class="kf-seek-btn" onclick="kfSeekAudioBy('{{ post.post_id }}', -10)">
                    <i class="fas fa-backward-step"></i> 10s
                  </button>
                  <button class="kf-seek-btn" onclick="kfSeekAudioBy('{{ post.post_id }}', 10)">
                    10s <i class="fas fa-forward-step"></i>
                  </button>
                </div>
              </div>
              <audio id="kf-audio-element-{{ post.post_id }}" preload="metadata" autoplay class="kf-audio-hidden">
                <source src="{{ original_post.file.url }}" type="audio/webm">
              </audio>
            </div>
            {% endif %}

            {% if original_post.video_file %}
            <div class="kf-video-container" id="kf-container-{{ post.post_id }}">
              <button class="kf-video-download-btn" 
                      title="Download Video" 
                      onclick="kfDownloadVideo('{{ original_post.post_id }}', '{{ original_post.video_file.url }}')">
                <i class="fas fa-download"></i>
              </button>
              
              <video class="kf-video" 
                     id="kf-post-video-{{ post.post_id }}" 
                     preload="metadata" 
                     autoplay
                     onclick="kfTogglePlayPause('kf-post-video-{{ post.post_id }}', event)">
                <source src="{{ original_post.video_file.url }}" type="video/mp4">
              </video>
              
              <i class="fa-solid fa-play kf-play-pause-icon" id="kf-play-icon-{{ post.post_id }}"></i>
              
              <button class="kf-seek-overlay-btn kf-backward-btn" 
                      onclick="event.stopPropagation(); kfSeekVideo('kf-post-video-{{ post.post_id }}', -10)">
                <i class="fa-solid fa-backward-step"></i> 10s
              </button>
              <button class="kf-seek-overlay-btn kf-forward-btn" 
                      onclick="event.stopPropagation(); kfSeekVideo('kf-post-video-{{ post.post_id }}', 10)">
                10s <i class="fa-solid fa-forward-step"></i>
              </button>
            </div>
            {% endif %}

            {% if original_post.images.all %}
            <div class="kf-media-container">
              <div class="kf-image-carousel" id="kf-carousel-{{ post.post_id }}" data-slide="0" data-total="{{ original_post.images.all|length }}">
                <div class="kf-image-track" id="kf-track-{{ post.post_id }}">
                  {% for image in original_post.images.all %}
                  <div class="kf-image-slide">
                    <img 
                      src="{{ image.image.url }}" 
                      alt="Post image {{ forloop.counter }}"
                      loading="lazy"
                    />
                  </div>
                  {% endfor %}
                </div>
                
                {% if original_post.images.all|length > 1 %}
                <div class="kf-carousel-controls">
                  <button class="kf-carousel-prev" onclick="kfSlideCarousel('{{ post.post_id }}', -1)">
                    <i class="fas fa-chevron-left"></i>
                  </button>
                  <button class="kf-carousel-next" onclick="kfSlideCarousel('{{ post.post_id }}', 1)">
                    <i class="fas fa-chevron-right"></i>
                  </button>
                </div>
                
                <div class="kf-carousel-indicators">
                  {% for image in original_post.images.all %}
                  <span class="kf-indicator {% if forloop.first %}active{% endif %}"></span>
                  {% endfor %}
                </div>
                {% endif %}
              </div>
            </div>
            {% endif %}
          </div>
          {% endif %}
        {% endwith %}
      
      {% else %}
        {% if post.file %}
        <div class="kf-media-container">
          <div class="kf-audio-player" id="kf-audio-{{ post.post_id }}">
            <button class="kf-audio-download-btn" 
                    title="Download Audio" 
                    onclick="kfDownloadAudio('{{ post.post_id }}', '{{ post.file.url }}')">
              <i class="fas fa-download"></i>
            </button>
            
            <div class="kf-audio-cover" 
                 style="background-image: url('{% if post.images.first %}{{ post.images.first.image.url }}{% else %}{{ post.author.profile.picture.url }}{% endif %}');">
              <button class="kf-audio-play-btn" onclick="kfToggleAudio('{{ post.post_id }}')">
                <i class="fas fa-play" id="kf-audio-icon-{{ post.post_id }}"></i>
              </button>
            </div>
            <div class="kf-audio-controls">
              <div class="kf-audio-info">
                <span class="kf-audio-title">Audio Post</span>
                <span class="kf-audio-time" id="kf-audio-time-{{ post.post_id }}">0:00</span>
              </div>
              <div class="kf-audio-progress" onclick="kfSeekAudio(event, '{{ post.post_id }}')">
                <div class="kf-audio-progress-bar" id="kf-audio-progress-{{ post.post_id }}"></div>
              </div>
              <div class="kf-audio-seek-buttons">
                <button class="kf-seek-btn" onclick="kfSeekAudioBy('{{ post.post_id }}', -10)">
                  <i class="fas fa-backward-step"></i> 10s
                </button>
                <button class="kf-seek-btn" onclick="kfSeekAudioBy('{{ post.post_id }}', 10)">
                  10s <i class="fas fa-forward-step"></i>
                </button>
              </div>
            </div>
            <audio id="kf-audio-element-{{ post.post_id }}" preload="metadata" autoplay class="kf-audio-hidden">
              <source src="{{ post.file.url }}" type="audio/webm">
            </audio>
          </div>
        </div>
        {% endif %}

        {% if post.video_file %}
        <div class="kf-media-container">
          <div class="kf-video-container" id="kf-container-{{ post.post_id }}">
            <button class="kf-video-download-btn" 
                    title="Download Video" 
                    onclick="kfDownloadVideo('{{ post.post_id }}', '{{ post.video_file.url }}')">
              <i class="fas fa-download"></i>
            </button>
            
            <video class="kf-video" 
                   id="kf-post-video-{{ post.post_id }}" 
                   preload="metadata" 
                   autoplay
                   onclick="kfTogglePlayPause('kf-post-video-{{ post.post_id }}', event)">
              <source src="{{ post.video_file.url }}" type="video/mp4">
            </video>
            
            <i class="fa-solid fa-play kf-play-pause-icon" id="kf-play-icon-{{ post.post_id }}"></i>
            
            <button class="kf-seek-overlay-btn kf-backward-btn" 
                    onclick="event.stopPropagation(); kfSeekVideo('kf-post-video-{{ post.post_id }}', -10)">
              <i class="fa-solid fa-backward-step"></i> 10s
            </button>
            <button class="kf-seek-overlay-btn kf-forward-btn" 
                    onclick="event.stopPropagation(); kfSeekVideo('kf-post-video-{{ post.post_id }}', 10)">
              10s <i class="fa-solid fa-forward-step"></i>
            </button>
          </div>
        </div>
        {% endif %}

        {% if post.images.all %}
        <div class="kf-media-container">
          <div class="kf-image-carousel" id="kf-carousel-{{ post.post_id }}" data-slide="0" data-total="{{ post.images.all|length }}">
            <div class="kf-image-track" id="kf-track-{{ post.post_id }}">
              {% for image in post.images.all %}
              <div class="kf-image-slide">
                <img 
                  src="{{ image.image.url }}" 
                  alt="Post image {{ forloop.counter }}"
                  loading="lazy"
                />
              </div>
              {% endfor %}
            </div>
            
            {% if post.images.all|length > 1 %}
            <div class="kf-carousel-controls">
              <button class="kf-carousel-prev" onclick="kfSlideCarousel('{{ post.post_id }}', -1)">
                <i class="fas fa-chevron-left"></i>
              </button>
              <button class="kf-carousel-next" onclick="kfSlideCarousel('{{ post.post_id }}', 1)">
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
            
            <div class="kf-carousel-indicators">
              {% for image in post.images.all %}
              <span class="kf-indicator {% if forloop.first %}active{% endif %}"></span>
              {% endfor %}
            </div>
            {% endif %}
          </div>
        </div>
        {% endif %}
      {% endif %}

      <div class="kf-post-actions">
        {% include 'snippet/post_like.html' %}
      </div>
    </article>
  </div>

  <!-- Comments Section (Right) -->
  <div class="kf-comments-section">
    {% if comments %}
    <div class="comments-header">
      <h2><i class="fas fa-comments"></i> Comments</h2>
    </div>
    {% endif %}

    <div id="comment_list">
      {% for comment in comments %}
        {% include 'snippet/comment_list.html' with comment=comment %}
      {% empty %}
      <div class="no-comments">
        <i class="far fa-comment-alt"></i>
        <h3>No comments yet</h3>
        <p>Be the first to comment on this post</p>
      </div>
      {% endfor %}
    </div>

    <div class="kf-comment-input-area" id="myForm">
      <form id="postForm"
        hx-post="{% url 'postcomment' post.post_id %}" 
        hx-target="#comment_list"
        hx-encoding="multipart/form-data"
        hx-on::after-request="if(event.detail.successful) { this.reset(); resetInputUI(); }"
        hx-swap="afterbegin">
        {% csrf_token %}
        
        <div class="kf-comment-input-wrapper">
          <a href="{% url 'profile' user.username %}" style="display: flex; align-items: center;">
            <img src="{{user.profile.picture.url}}" alt="Profile" class="kf-comment-profile-img">
          </a> 
          
          <button type="button" class="kf-comment-action-btn" onclick="document.getElementById('image').click()" title="Attach image">
            <svg width="20" height="20" viewBox="0 0 24 24">
              <path d="M21 19V5H3v14h18zm0-16c1.1 0 2 .9 2 2v14c0 
              1.1-.9 2-2 2H3c-1.1 0-2-.9-2-2V5c0-1.1.9-2 2-2h18zM8.5 
              11.5l2.5 3.01L14.5 10l4.5 6H5l3.5-4.5z"/>
            </svg>
          </button>
          
          <input type="file" id="image" name="image" multiple hidden>
          <input type="file" name="audio_file" id="audio_file" hidden>
          
          <textarea class="kf-comment-input" 
                    name="comment" 
                    id="textInput" 
                    placeholder="Write a comment..." 
                    autocomplete="off" 
                    rows="1"></textarea>
          
          <div class="kf-audio-preview-container record-mode-hidden" id="audioPreviewContainer">
            <button id="deleteAudioBtn" type="button" class="kf-comment-action-btn"><i class="fa-solid fa-trash-can"></i></button>
            <button id="stopRecordingBtn" type="button" class="kf-stop-recording-btn" title="Stop recording" style="display: none;">
              <i class="fa-solid fa-square"></i>
            </button>
            <div class="kf-preview-audio-player">
              <audio id="previewAudio"></audio>
              <div id="recordingStatus" class="kf-recording-indicator"></div>
            </div>
          </div>
          
          <button type="submit" class="kf-comment-send-btn" id="sendBtn" title="Send" style="display: none;">
            <svg width="24"  height="24" viewBox="0 0 24 24">
              <path fill="#ffffff" d="M2 21l21-9L2 3v7l15 2-15 2v7z"/>
            </svg>
          </button>
          
          <button type="button" class="kf-comment-action-btn" id="startBtn" title="Record audio">
            <i class="fa-solid fa-microphone"></i>
          </button>
        </div>
      </form>
    </div>
  </div>
</main>

<div class="kf-repost-modal" id="kf-repost-modal">
  <div class="kf-repost-modal-content">
    <div class="kf-repost-modal-header">
      Repost
    </div>
    <div class="kf-repost-modal-body">
      <textarea 
        class="kf-repost-textarea" 
        id="kf-repost-caption" 
        placeholder="Add a comment to your repost (optional)"
        maxlength="500"></textarea>
      <div style="font-size: 12px; color: var(--kf-text-light); text-align: right;">
        <span id="kf-repost-char-count">0</span>/500
      </div>
    </div>
    <div class="kf-repost-modal-footer">
      <button class="kf-repost-cancel-btn" onclick="kfCloseRepostModal()">Cancel</button>
      <button class="kf-repost-btn" id="kf-repost-confirm-btn">
        <i class="fas fa-retweet"></i> Repost
      </button>
    </div>
  </div>
</div>

<!-- Logout Modal (for desktop) -->
<div class="logout-modal" id="logoutModal">
  <div class="logout-modal-content">
    <h3 class="logout-modal-title">Log Out?</h3>
    <p class="logout-modal-message">Are you sure you want to log out of your account?</p>
    <div class="logout-modal-buttons">
      <button class="logout-modal-btn logout-modal-cancel" id="cancelLogout">Cancel</button>
      <button class="logout-modal-btn logout-modal-confirm" id="confirmLogout">Log Out</button>
    </div>
  </div>
</div>

 <script src="{% static 'js/postcomment.js' %}"></script>


 </script>
</body>
</html>