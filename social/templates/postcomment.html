{% load humanize %}
{% load static %}
{% load time %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KishiFace - Home</title>
   <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.7/dist/htmx.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <script src="{% static 'js/home.js' %}"></script>
  <style>
    /*
     * COMBINED STYLE: LinkedIn Boxed Card with Instagram Carousel Functionality
     */
    :root {
      --main-bg: #f0f2f5;
      --white: #ffffff;
      --border-color: #e0e0e0;
      --primary-color: #0077b5;
      --text-dark: #1f1f1f;
      --text-muted: #6a6a6a;
      --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    body {
      font-family: var(--font-stack);
      background-color: white;
      margin: 0;
      padding-top: 54px;
      color: var(--text-dark);
      min-height: 100vh;
    }
    /* ===== Global Utility & Card Style (Boxed) ===== */
    .container { 
      max-width: 600px;
      margin: 0 auto;
      padding: 0; }
    .card {
      background: var(--white);
   
     
      overflow: hidden;
      box-shadow: 0 1px 1px rgba(0,0,0,0.05);
    }

    .text-center { text-align: center; }

    /* Post Creation Form (Re-used) */
    .post-form { padding: 12px;   margin-bottom: 15px; box-shadow: 0 1px 1px rgba(0,0,0,0.05); }
    input { width: 95%; padding: 8px; border: 1px solid #ccc; border-radius: 2px; resize: none; margin-bottom: 10px; font-size: 14px; }
    
    .file-label {
      color: var(--primary-color); cursor: pointer; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 6px;
      padding: 6px 8px; border: 1px solid transparent; border-radius: 4px; transition: background-color 0.2s;
    }
    
    input[type=file] { display: none; }

    /* Post Header (LinkedIn Style) */
    .post-header {
      display: flex; align-items: flex-start; justify-content: space-between;
      padding: 12px 16px 8px 16px;
    }
    .post-user { display: flex; align-items: center; gap: 10px; }
    .profile-pic { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: none; }
    .username-link { font-weight: 600; text-decoration: none; color: var(--text-dark); font-size: 15px; line-height: 1.2; }
    .user-details { display: flex; flex-direction: column; justify-content: center; }
    .post-meta { font-size: 12px; color: var(--text-muted); margin-top: 2px; }

    /* Post Title (LinkedIn Style) */
    .post-title {
      padding: 0 16px 12px 16px; color: var(--text-dark); margin: 0; line-height: 1.3;
    }

    /* ===== Image Carousel Styles (RE-ENABLED) ===== */
    .post-image-carousel {
      position: relative;
      overflow: hidden;
      max-height: 70vh; /* Re-enabled and adjusted */
      background-color: #efefef;
    }
    .slider-track {
      display: flex;
      transition: transform 0.3s ease-in-out;
    }
    .post-image-slide {
      width: 100%;
      flex-shrink: 0;
      height: auto;
      max-height: 70vh;
      object-fit: cover; /* Use cover for better look on mixed images */
      display: block;
    }

    /* Slide Nav Arrows */
    .slide-nav {
      position: absolute; top: 0; bottom: 0; width: 100%; display: flex; justify-content: space-between; align-items: center;
      padding: 0 8px; pointer-events: none;
    }
    .slide-nav button {
      background: rgba(0, 0, 0, 0.4); color: white; border: none; border-radius: 50%; width: 30px; height: 30px;
      display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; font-size: 14px;
      opacity: 0.8; pointer-events: all;
    }
    .slide-nav button.hidden { visibility: hidden; }

    /* Indicators (Dots) */
    .slider-indicators {
      position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 6px; z-index: 10;
    }
    .indicator-dot {
      width: 6px; height: 6px; background: rgba(255, 255, 255, 0.8); border-radius: 50%; transition: background 0.3s;
    }
    .indicator-dot.active { background: var(--primary-color); }
    /* ===== End Carousel Styles ===== */

    /* Liked Profile Pictures Section (Re-used) */
    .likers-container { display: flex; align-items: center; gap: 5px; }
    .liker-pic {
      width: 20px; height: 20px; border-radius: 50%; object-fit: cover; border: 1px solid var(--white); margin-left: -5px;
    }
    .liker-pic:first-child { margin-left: 0; }

    /* Engagement (Re-used) */
    .engagement {
      display: flex; align-items: center; padding: 8px 16px 12px 16px; font-size: 13px; color: var(--text-muted);
      border-bottom: 1px solid var(--border-color);
    }
    .engagement a { color: var(--text-muted); text-decoration: none; font-weight: 600; }
    .engagement a:hover { text-decoration: underline; }

    /* Actions Bar (Re-used) */
    .actions-container { display: flex; justify-content: center; padding: 8px 16px;}
    .actions-left { display: flex; gap: 50px; }
    .action-item {
        display: flex; align-items: center; gap: 6px; color: var(--text-muted); font-weight: 600;
        font-size: 13px; cursor: pointer; text-decoration: none; padding: 6px 10px; border-radius: 4px;
    }
    .action-item:hover { background-color: #f6f6f6; }
    .action-icon { font-size: 18px; color: var(--text-muted); }
    .action-icon.liked { color: #ed4956; }

    .post-content-section { display: none; } /* Keeping caption hidden for LinkedIn-style look */
    .post-management { display: none; }
    .pagination { display: flex; justify-content: center; gap: 12px; padding: 20px 0; }
    .pagination a { background: var(--white); padding: 8px 14px; border-radius: 4px; border: 1px solid var(--border-color); text-decoration: none; color: var(--text-dark); font-size: 14px; }
    .pagination a:hover { background: #eee; }



#icon{
  margin:0 10px;
}

audio{
  width: 100%;
  outline: none;
  background-color: #eef2f7;
}
audio::-webkit-media-controls-pannel{
  background-color: #eef2f7;
}

button{
  font-size: 24px;
  border: none;
  cursor: pointer;
  margin: 8px;
  background-color: #ffffff;
  transform: color 0.3s ease;
}
button:hover{
  color: #007bff;
}
/* --- Global Comment Container: Uses Flexbox for three-column layout (Avatar, Text, Actions) --- */
.comment {
    display: flex;
    align-items: flex-start; /* Aligns content to the top */
    padding: 8px 0; 
}

/* --- 1. Avatar Styling (Applies to both the actual image and the letter placeholder) --- */
/* Actual Profile Picture Styling */
.avatar-img {
    width: 28px; 
    height: 28px;
    border-radius: 50%; /* Makes the image round */
    margin-right: 12px;
    flex-shrink: 0; 
    object-fit: cover; /* Ensures the image fills the circle */
}

/* Letter Placeholder Styling */
.avatar-letter {
    width: 38px; 
    height: 38px;
    border-radius: 50%; 
    margin-right: 12px;
    flex-shrink: 0; 
    
    /* Style for the Initial/Letter Placeholder */
    background-color: #555; /* Dark gray for the circle background */
    color: white;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 18px;
    font-weight: 500;
}

/* --- 2. Comment Body Styling (Content Area) --- */
.comment-body {
    flex-grow: 1; /* Takes up all available space */
    display: flex;
    flex-direction: column;
}

/* Username/Author Name */
.username {
    font-weight: bold; 
    color: #222; /* Very dark text */
    text-decoration: none; 
    font-size: 14px; 
    margin-bottom: 2px;
}

/* Comment Text */
.text {
    margin: 0; 
    color: #000; 
    line-height: 1.4;
    font-size: 15px; 
    white-space: pre-wrap; 
}

/* Image Styling */
.comment-image {
    margin-top: 5px;
}

/* ðŸŽ§ Audio Player Styling */
.comment-audio-player {
    width: 100%; 
    max-width: 300px; 
    margin-top: 8px; 
    margin-bottom: 2px; 
    
    background-color: #f7f7f7; /* Light gray background */
    border-radius: 4px; 
    border: 1px solid #e0e0e0; 
    height: 35px; 
}

/* Styling the internal controls for webkit browsers (Chrome, Safari) */
.comment-audio-player::-webkit-media-controls-panel {
    background-color: #f7f7f7;
    color: #404040;
}
.comment-audio-player::-webkit-media-controls-play-button {
    color: #606060; 
}
.comment-audio-player::-webkit-media-controls-current-time-display,
.comment-audio-player::-webkit-media-controls-time-remaining-display {
    color: #606060;
    font-size: 12px;
}


/* Time and Reply Action Sub-line */
.channel-name {
    margin-top: 4px;
    font-size: 12px; 
    color: #606060; 
    display: flex;
    align-items: center;
}

/* Reply Link Styling */
.channel-name a {
    color: #606060; 
    text-decoration: none; 
    font-weight: 500;
    margin-left: 5px; 
}


/* --- 3. Heart/Like Action Styling (Far Right) --- */
.comment-actions {
    display: flex;
    flex-direction: column; /* Stacks the number and icon vertically */
    align-items: center; 
    margin-left: 15px; 
    flex-shrink: 0; 
    padding-top: 5px; 
    color: #606060; 
    font-size: 12px;
}

.like-icon {
    margin-top: 2px;
    font-size: 14px;
}
    .recording{
      position: relative;
      font-size: 20px;
      color: #ff3b30;
      animation: pulse 1s infinite;
    }
    .input-wrapper {
    position: relative;
    flex: 1;
}
.input-wrapper svg {
    position: absolute;
    left: 12px;
    top: 40%;
    transform: translateY(-50%);
    fill: #555;
    
}

    .input-area {
    padding: 10px;
    border-top: 1px solid #ddd;
    display: flex;
    align-items: center;
    gap: 8px;
    background: #fff;
}
.message-input {
    width: 100%;
    padding: 10px 12px 10px 38px; /* left padding for image icon */
    border: 1px solid #ccc;
    border-radius: 20px;
    outline: none;
    box-sizing: border-box;
}

#myForm{
  position: fixed;
  bottom: -30px;
  left: 0;
  right: 0;
  z-index: 999;
}

    @keyframes pulse{
      0% {
        transform: scale(1);
        opacity: 1;
      }
      50%{
        transform: scale(1.3);
        opacity: 0.5;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }
 
    /* ---------------- INSTAGRAM-STYLE AUDIO DESIGN ---------------- */
    .audio-post-container {
        /* Main container for the cover and controls */
        display: flex;
        flex-direction: column;
        border: 1px solid var(--divider-color);
        border-radius: 8px;
        overflow: hidden; 
        margin-top: 10px;
    }
    
    .audio-cover-area {
        /* Styles for the background poster image - now clickable */
        width: 100%;
        height: 250px; 
        background-size: cover;
        background-position: center;
        background-color: var(--text-dark); /* Fallback dark color */
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.4);
        cursor: pointer;
        position: relative;
    }
    
    /* Play/Pause icon over the audio cover */
    .audio-play-icon {
        font-size: 3em;
        color: white;
        text-shadow: 0 0 10px rgba(0, 0, 0, 0.9);
        z-index: 5;
        transition: opacity 0.3s ease;
    }

    /* Hide the native audio element */
    .audio-hidden {
        display: none; 
    }
    /* ---------------- END AUDIO DESIGN ---------------- */

    /* Existing styles from the original file (kept for compatibility) */
    .cover{
        width: 100%;
        height: 250px;
        /*background-image: url('https://placehold.co/600x400/999999/ffffff?text=KishiFace+Post');*/
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 10px;
    }
    .cover i{
        font-size: 50px;
        color: #bdbdbd;
        margin-right: 40px;
    }
    .audio{
        width: 100%;
        outline: none;
    }

    /* ---------------- Instagram Video Styles (CLEANED) ---------------- */
    .instagram-video-container {
        position: relative; 
        width: 100%;
        overflow: hidden;
        margin-top: 10px;
        background-color: black;
        min-height: 200px; 
        display: flex; 
        justify-content: center;
        align-items: center;
    }

    .instagram-video {
        max-width: 100%; 
        height: auto; 
        object-fit: contain; 
        display: block; 
    }

    /* Styling for the Play/Pause Icon */
    .play-pause-icon {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 4em; 
        color: white;
        background: rgba(0, 0, 0, 0.4);
        border-radius: 50%;
        padding: 15px 20px 15px 23px;
        pointer-events: none;
        opacity: 0; 
        transition: opacity 0.3s ease;
    }

    /* State Class: Show Play icon when video is paused */
    .instagram-video-container.paused .play-pause-icon {
        opacity: 1;
    }
    /* ---------------- End Instagram Video Styles ---------------- */
    
    /* ---------------- NEW OVERLAY SEEK ICONS ---------------- */
    .seek-overlay-btn {
        position: absolute;
        bottom: 10px; 
        background: rgba(0, 0, 0, 0.4);
        color: white;
        border: none;
        border-radius: 5px;
        padding: 8px 10px;
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        z-index: 10; 
        opacity: 0; 
        transition: opacity 0.3s ease;
    }

    .seek-overlay-btn:hover {
        background: rgba(0, 0, 0, 0.6);
    }

    .backward-btn {
        left: 10px;
    }

    .forward-btn {
        right: 10px; /* Adjusted position */
    }

    /* State Class: Show controls when paused or hovered */
    .instagram-video-container.paused .seek-overlay-btn,
    .instagram-video-container:hover .seek-overlay-btn {
        opacity: 1;
    }
    /* ---------------- END NEW SEEK ICONS ---------------- */
    
  </style>
</head>
<body>
{% include 'header.html' %}


<main class="container">
 
  <article class="card">
<div class="post-header">
<div class="post-user">
<img src="{{post.author.profile.picture.url}}" onerror="this.onerror=null; this.src='https://placehold.co/40x40/cccccc/ffffff?text=P';" alt="{{post.author.username}}" class="profile-pic">
<div class="user-details">
<a href="{% url 'profile' post.author.username %}" class="username-link">{{post.author.first_name}} {{post.author.last_name}}
  {% if post.author.profile.is_verify and post.author.first_name %} <img src="{% static 'images/verify1.jpg' %}" height="20" width="20" alt="">{% endif %}
</a>
<div class="post-meta">
@{{post.author.username}}Â· {{post.created_at|insta_timesince}}
</div>
</div>
</div>
<i class="fa-solid fa-ellipsis" style="color:var(--text-muted); cursor:pointer;"></i>
</div>
<b class="post-title" style="color: #6a6a6a;">{{post.content|urlize|linebreaksbr}}</b>

 {% if post.file %}
              <div class="audio-post-container" id="audio-container-{{ post.post_id }}">
                  <div class="audio-cover-area" 
                       style="background-image: url('{% if post.images.first %}{{post.images.first.image.url}}{% else %}{{post.author.profile.picture.url}}{% endif %}');"
                       onclick="toggleAudioPlay('audio-{{ post.post_id }}')">
                        <i class="fa-solid fa-play audio-play-icon" id="audio-icon-{{ post.post_id }}"></i>
                  </div>
                  <audio id="audio-{{ post.post_id }}" class="audio-hidden">
                    <source src="{{ post.file.url }}" type="audio/webm">
                  </audio>
              </div>
            {% endif %}

              {% if post.video_file %}
              <div class="instagram-video-container" id="container-{{ post.post_id }}">
                  <video class="instagram-video" 
                         id="post-video-{{ post.post_id }}" 
                         preload="metadata" 
                         autoplay 
                         loop 
                         onclick="togglePlayPause('post-video-{{ post.post_id }}', event)"> 
                      
                      <source src="{{ post.video_file.url }}" type="video/mp4">
                      Your browser does not support HTML5 video.
                  </video>
                  
                  <i class="fa-solid fa-play play-pause-icon" id="play-icon-{{ post.post_id }}"></i>
                  
                  <button class="seek-overlay-btn backward-btn" 
                          onclick="event.stopPropagation(); seekVideo('post-video-{{ post.post_id }}', -10)">
                      <i class="fa-solid fa-backward-step"></i> 10s
                  </button>
                  <button class="seek-overlay-btn forward-btn" 
                          onclick="event.stopPropagation(); seekVideo('post-video-{{ post.post_id }}', 10)">
                      10s <i class="fa-solid fa-forward-step"></i>
                  </button>
                  </div>
              
              {% endif %}
              

{% if post.images.all %}

<div class="post-image-carousel" id="carousel-{{ post.post_id }}" data-current-slide="0" data-total-slides="{{ post.images.all|length }}">

  <div class="slider-track" id="track-{{ post.post_id }}">
    {% for p in post.images.all %}
      <img src="{{p.image.url}}" onerror="this.onerror=null; this.src='https://placehold.co/600x400/999999/ffffff?text=KishiFace+Post';" alt="Post Image {{forloop.counter}}" class="post-image-slide">
    {% empty %}
    <img src="https://placehold.co/600x400/999999/ffffff?text=KishiFace" alt="No Post Image" class="post-image-slide">
    {% endfor %}
  </div>

{% endif %}

  {% if post.images.all|length > 1 %}
  <div class="slide-nav">
    <button id="prev-{{ post.post_id }}" onclick="slidePost('{{ post.post_id }}', -1)" class="hidden"><i class="fa-solid fa-chevron-left"></i></button>
    <button id="next-{{ post.post_id }}" onclick="slidePost('{{ post.post_id }}', 1)"><i class="fa-solid fa-chevron-right"></i></button>
  </div>

  <div class="slider-indicators" id="indicators-{{ post.post_id }}">
    {% for p in post.images.all %}
    <div class="indicator-dot {% if forloop.first %}active{% endif %}"></div>
    {% endfor %}
  </div>
  {% endif %}
</div>

<!-- 
  NEW: We now include the single snippet that contains 
  both the likers/count summary AND the action buttons.
-->
{% include 'snippet/post_like.html' %}

</article>
<span id="comment_list">
  {% for comment in comments %}

      {% include 'snippet/comment_list.html' with comment=comment %}
    
  {% empty %}
<h2>No comment yet</h2>
{% endfor %}
  </span>

</main>

<div class="card post-form" id="myForm">
   <form id="postForm"
    hx-post="{% url 'postcomment' post.post_id %}" 
    hx-target="#comment_list"
    hx-encoding="multipart/form-data"
    hx-on::after-request="this.reset()"
    hx-swap="afterbegin"
    >
      {% csrf_token %}
      <div class="input-area">
         <!-- Profile Icon -->
      <a href="{% url 'profile' user.username %}">
          <img src="{{user.profile.picture.url}}" alt="Profile" height="30px" width="30px" style="border-radius:50%;">
      </a> 
      <div class="input-wrapper">
       <label for="image" >
          <svg width="20" height="20" viewBox="0 0 24 24">
                <path d="M21 19V5H3v14h18zm0-16c1.1 0 2 .9 2 2v14c0 
                1.1-.9 2-2 2H3c-1.1 0-2-.9-2-2V5c0-1.1.9-2 2-2h18zM8.5 
                11.5l2.5 3.01L14.5 10l4.5 6H5l3.5-4.5z"/>
            </svg>
        </label>
      <input type="text" name="comment" class="message-input"  placeholder="Write a caption...">
      </div>
      <div class="form-actions">
        <button id="startBtn" type="button"><i class="fa-solid fa-microphone"></i></button> <span id="status"></span> <button id="stopBtn" type="button" hidden><i class="fa-solid fa-circle-stop"></i></button>
        <input type="file" name="audio_file" id="audio_file" hidden>
        <input type="file" id="image" name="image" multiple>
        <button type="submit" > <svg width="24" height="24" viewBox="0 0 24 24">
                <path d="M2 21l21-9L2 3v7l15 2-15 2v7z"/>
            </svg></button>
        </div>
      </div>
    </form>
  </div>


<script>
  /** socket Code */

  const postId = "{{post.post_id}}";
  const currentUserId = '{{request.user.id}}';
  const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
  const socket = new WebSocket(`${protocol}${window.location.host}/ws/comment/${postId}/`);
  const commentList = document.getElementById('comment_list');
  socket.onopen = ()=>{
    console.log(currentUserId);
  }
  socket.addEventListener('message', async function(e){
    
    const data = JSON.parse(e.data);
    const newComment=document.createElement('p');
    console.log(data.user_id);
    console.log(`${data.author_username}:${data.comment}`);
   if(data.user_id == currentUserId){
    return;
   } 
    newComment.innerHTML = `
    <div class="comment">
        <img src="${data.profile_pic}" class="avatar"> 

        <div class="comment-body">
            <a href="/${data.author_username}" class="username">
                ${data.author_first} ${data.author_last}
                ${data.is_verify ? '<img src="/static/images/verify1.jpg" width="20">' : ""}
            </a>

            <p class="text">${data.comment}</p>

            ${data.image_url ? `<img src="${data.image_url}" width="200" style="border-radius:8px;">` : ""}
            ${data.file_url ? `<audio controls src="${data.file_url}"></audio>` : ""}

            <p class="channel-name">
                <i class="far fa-clock"></i> ${data.created_at}  
                <a href="comment_repy/${data.comment_id}"> <i id="icon" class="fa-regular fa-comment action-icon"></i></a>
            </p>
        </div>
    </div>
    `;

    commentList.insertBefore(newComment, commentList.firstChild);
  })


  /*** Recording Code */
  let mediaRecord;
  let audioChucks = [];
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const audio_file = document.getElementById('audio_file');
  const status = document.getElementById('status');
  startBtn.addEventListener('click', async function(){
    try{
      const stream = await navigator.mediaDevices.getUserMedia({
      audio:true
    });
    mediaRecord = new MediaRecorder(stream);
    audioChucks = [];
    mediaRecord.ondataavailable = event =>audioChucks.push(event.data);
    mediaRecord.onstop = async () =>{
      const bob = new Blob(audioChucks, {
        type: 'audio/webm'
      });
      const file = new File([bob], 'recorded_audio.webm',{
        type: 'audio/webm'
      });
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(file);
      audio_file.files = dataTransfer.files;
    };
    mediaRecord.start();
    status.innerHTML = `<i class="fa-solid fa-circle recording"></i>`;
    startBtn.hidden = true;
    stopBtn.hidden = false;
    }catch(err){
      alert('MicroPhone acess denied')
    }

  })

  stopBtn.onclick = () =>{
    mediaRecord.stop();
    status.textContent = 'Recording Stoped';
    startBtn.hidden = false;
    stopBtn.hidden = true;
  }
</script>
</body>
</html>

