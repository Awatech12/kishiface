<!-- post_like.html -->
{% load humanize %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <link rel="stylesheet" 
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" 
          integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PNO+I+9klVjKjK4FOGQJZp+QAUU9QJxO6g4aJiHXb8k1YQkT3qO+2Cjw==" 
          crossorigin="anonymous" 
          referrerpolicy="no-referrer" />
    
    <style>
        /* ... (keep all existing styles the same) ... */
        /* ANIMATION STYLES */
        @keyframes heartBeat {
            0% { transform: scale(1); }
            15% { transform: scale(1.3); }
            30% { transform: scale(0.95); }
            45% { transform: scale(1.15); }
            60% { transform: scale(0.98); }
            75% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes bounceUp {
            0% { transform: translateY(0); }
            25% { transform: translateY(-8px); }
            50% { transform: translateY(3px); }
            75% { transform: translateY(-4px); }
            100% { transform: translateY(0); }
        }

        @keyframes pulseGlow {
            0% { box-shadow: 0 0 0 0 rgba(255, 44, 85, 0.4); }
            70% { box-shadow: 0 0 0 8px rgba(255, 44, 85, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 44, 85, 0); }
        }

        @keyframes floatUp {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(-40px) scale(0.3);
                opacity: 0;
            }
        }

        @keyframes likeCountPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        @keyframes ripple {
            0% {
                transform: scale(0);
                opacity: 0.5;
            }
            100% {
                transform: scale(4);
                opacity: 0;
            }
        }

        @keyframes countBounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); }
        }

        /* LIKERS AND ENGAGEMENT COUNTS SECTION */
        .engagement {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            padding: 12px 16px 8px;
            border-bottom: 1px solid #eee;
            margin-bottom: 0;
            gap: 12px;
        }

        .likers-container {
            display: flex;
            margin-right: 8px;
        }

        .liker-pic {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid white;
            margin-left: -5px;
            transition: transform 0.2s ease, z-index 0.2s;
            position: relative;
        }
        
        .likers-container a:first-child .liker-pic {
            margin-left: 0;
        }

        .liker-pic:hover {
            transform: translateY(-2px);
            z-index: 10;
        }

        .like-text {
            font-weight: normal;
            color: #374151;
        }

        .no-likes {
            color: #4b5563;
            font-weight: normal;
        }

        .you-text {
            font-weight: normal;
            color: #374151;
        }

        .comment-text {
            font-size: 14px;
            color: #4b5563;
        }
        
        .comment-text a {
            color: #000;
            text-decoration: none;
            font-weight: normal;
        }
        
        .comment-text a:hover {
            text-decoration: underline;
        }

        .view-text {
            font-size: 14px;
            color: #4b5563;
        }

        .separator-dot {
            color: #4b5563;
            font-size: 14px;
            margin: 0 4px;
        }

        .engagement-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* HORIZONTAL ACTIONS SECTION - ENHANCED */
        .horizontal-actions-container {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 8px 16px 16px;
            gap: 20px;
        }

        .horizontal-action-item {
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: #4b5563;
            font-size: 14px;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .horizontal-action-item::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 44, 85, 0.1);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .horizontal-action-item:active::before {
            width: 120px;
            height: 120px;
        }

        .horizontal-action-item:hover {
            background-color: #f3f4f6;
            color: #1f2937;
            transform: translateY(-2px);
        }

        .horizontal-action-icon {
            font-size: 20px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }

        /* REPOST BUTTON STYLES - Show count instead of text */
        .horizontal-action-item.repost-btn {
            position: relative;
            gap: 4px; /* Reduce gap since we're showing count next to icon */
        }

        .horizontal-action-item.repost-btn:hover {
            background-color: rgba(23, 191, 99, 0.1);
            color: #17bf63;
        }

        .horizontal-action-item.repost-btn:hover .horizontal-action-icon {
            color: #17bf63;
        }

        /* Repost count displayed next to icon (not as badge) */
        .repost-count-display {
            font-size: 14px;
            font-weight: 500;
            color: #4b5563;
            transition: all 0.3s ease;
            min-width: 20px; /* Ensure consistent spacing */
            text-align: center;
        }

        .repost-count-display.count-bounce {
            animation: countBounce 0.4s ease;
            color: #17bf63;
        }

        /* Repost badge for large counts (optional, can remove if not needed) */
        .repost-count-badge {
            position: absolute;
            bottom: -8px;
            right: -4px;
            font-size: 10px;
            background: #17bf63;
            color: white;
            border-radius: 8px;
            padding: 1px 4px;
            min-width: 16px;
            text-align: center;
            display: none;
        }

        .repost-count-badge.show {
            display: block;
        }

        /* Reposted state */
        .reposted {
            color: #17bf63 !important;
        }

        /* Like button animation classes */
        .heart-animate {
            animation: heartBeat 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            color: #ff2c55 !important;
        }

        .heart-pulse {
            position: relative;
        }

        .heart-pulse::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 40px;
            height: 40px;
            background: rgba(255, 44, 85, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: pulseGlow 1s ease-out;
            pointer-events: none;
        }

        .like-count-animate {
            display: inline-block;
            animation: likeCountPop 0.5s ease-out;
            color:  #374151;
          
        }

        /* Hover effects for social icons */
        .share-facebook:hover .horizontal-action-icon {
            color: #1877f2;
            transform: scale(1.1) rotate(5deg);
        }

        .share-twitter:hover .horizontal-action-icon {
            color: #1da1f2;
            transform: scale(1.1) rotate(5deg);
        }

        .share-whatsapp:hover .horizontal-action-icon {
            color: #25d366;
            transform: scale(1.1) rotate(5deg);
        }

        /* Comment icon animation */
        .horizontal-action-item:hover .fa-comment {
            animation: bounceUp 0.6s ease-out;
        }

        /* Ripple effect for click */
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 44, 85, 0.3);
            transform: scale(0);
            animation: ripple 0.6s linear;
            pointer-events: none;
        }

        /* HTMX transition classes */
        .htmx-swapping .horizontal-action-icon {
            opacity: 0.5;
            transform: scale(0.8);
        }

        .htmx-settling .horizontal-action-icon {
            transition: all 0.3s ease;
        }

        /* Like count color transitions */
        .horizontal-action-item span {
            transition: color 0.3s ease;
        }

        /* Mobile adjustments */
        @media (max-width: 767px) {
            .horizontal-actions-container {
                gap: 12px;
            }
            
            .horizontal-action-item {
                padding: 6px 10px;
                gap: 6px;
                font-size: 13px;
            }
            
            .horizontal-action-icon {
                font-size: 18px;
            }
            
            .repost-count-display {
                font-size: 13px;
                min-width: 18px;
            }
            
            .engagement {
                gap: 8px;
            }
        }
    </style>
</head>
<body>
<!-- Each post engagement block -->
<div id="post-engagement-{{ post.post_id }}">
  
  <!-- HORIZONTAL ACTION BUTTONS -->
  <div class="horizontal-actions-container">
    
    <!-- LIKE/UNLIKE BUTTON - ANIMATED -->
    <a href="#"
       hx-get="{% url 'like_post' post.post_id %}"
       hx-target="#post-engagement-{{ post.post_id }}"
       hx-swap="outerHTML"
       hx-trigger="click"
       hx-indicator="#like-indicator-{{ post.post_id }}"
       class="horizontal-action-item like-btn"
       id="like-btn-{{ post.post_id }}">
      
      {% if request.user in post.likes.all %}
      <i class="fa-solid fa-heart horizontal-action-icon heart-animate" 
         style="color: #ff2c55;"></i>
      <span class="like-count-display">{{ post.likes.count|intcomma }}</span>
      {% else %}
      <i class="fa-regular fa-heart horizontal-action-icon"></i>
      <span class="like-count-display">{{ post.likes.count|intcomma }}</span>
      {% endif %}
      
      <!-- Loading indicator -->
      <div id="like-indicator-{{ post.post_id }}" 
           class="htmx-indicator"
           style="display: none; margin-left: 5px;">
        <i class="fas fa-spinner fa-spin"></i>
      </div>
    </a>

    <!-- COMMENT BUTTON -->
    <a href="{% url 'post_comment' post.post_id %}" class="horizontal-action-item">
      <i class="fa-regular fa-comment horizontal-action-icon"></i>
      <span class="comment-count-display">{{ post.comments.count|intcomma }}</span>
    </a>

    <!-- REPOST BUTTON - Shows count instead of text -->
    <div class="horizontal-action-item repost-btn"
         onclick="triggerHomePageRepost('{{ post.post_id }}', this)"
         data-reposted="{% if request.user in post.reposts.all %}true{% else %}false{% endif %}"
         title="Repost"
         id="snippet-repost-btn-{{ post.post_id }}">
      <i class="fas fa-retweet horizontal-action-icon {% if request.user in post.reposts.all %}reposted{% endif %}"></i>
      <span class="repost-count-display" id="snippet-repost-count-display-{{ post.post_id }}">
        {{ post.reposts.count|intcomma }}
      </span>
      <!-- Optional badge for very large counts (hidden by default) -->
      <span class="repost-count-badge" 
            id="snippet-repost-badge-{{ post.post_id }}"
            style="display: none;">
      </span>
    </div>

    <!-- FACEBOOK -->
    <a href="https://www.facebook.com/sharer/sharer.php?u=https://kishiface.pythonanywhere.com/{{post.post_id}}" 
       target="_blank"
       class="horizontal-action-item share-facebook">
      <i class="fab fa-facebook horizontal-action-icon"></i>
    </a>

    <!-- TWITTER -->
    <a href="https://twitter.com/intent/tweet?text={{ post.message|urlencode }}%20https://kishiface.pythonanywhere.com/{{post.post_id}}" 
       target="_blank"
       class="horizontal-action-item share-twitter">
      <i class="fab fa-twitter horizontal-action-icon"></i>
    </a>

    <!-- WHATSAPP -->
    <a href="https://api.whatsapp.com/send?text={{ post.message|urlencode }}%20https://kishiface.pythonanywhere.com/comment/{{post.post_id}}" 
       target="_blank"
       class="horizontal-action-item share-whatsapp">
      <i class="fab fa-whatsapp horizontal-action-icon"></i>
    </a>
  </div>

  <!-- LIKERS AND ENGAGEMENT COUNTS SECTION -->
  <div class="engagement">
    <!-- Show liker avatars only if there are likes -->
    {% if post.likes.count > 0 %}
    <div class="likers-container">
      {% for liker in post.likes.all|slice:":3" %}
      <a href="{% url 'profile' liker.username %}" 
         class="liker-link"
         aria-label="{{ liker.username }}">
        <img src="{{ liker.profile.picture.url }}"
             onerror="this.onerror=null; this.src='https://placehold.co/24x24/cccccc/ffffff?text={{ liker.username|first|upper }}';"
             alt="{{ liker.username }}" 
             class="liker-pic">
      </a>
      {% endfor %}
    </div>
    {% endif %}

    <!-- LIKE COUNTING WITH ANIMATIONS -->
    <div class="engagement-item">
      <span class="like-text">
        {% if post.likes.count == 0 %}
          <!-- No likes -->
          <span class="no-likes">Be the first to like this</span>
        
        {% elif request.user in post.likes.all %}
          <!-- Current user HAS liked the post -->
          {% if post.likes.count == 1 %}
            <!-- Only the current user has liked -->
            <span class="you-text like-count-animate">Liked by You</span>
          
          {% elif post.likes.count == 2 %}
            <!-- You + 1 other person -->
            <span class="you-text like-count-animate">Liked by You</span> and 
            {% for liker in post.likes.all %}
              {% if liker != request.user %}
                <a href="{% url 'profile' liker.username %}" 
                   style="color: #374151; text-decoration: none; transition: color 0.3s;">
                  {{ liker.username }}
                </a>
              {% endif %}
            {% endfor %}
          
          {% else %}
            <!-- You + 2+ others -->
            {% with non_user_likers_count=post.likes.count|add:"-1" %}
              <span class="you-text like-count-animate">Liked by You</span>
              {% if non_user_likers_count == 1 %}
                <!-- You + 1 other -->
                {% for liker in post.likes.all %}
                  {% if liker != request.user %}
                    and 
                    <a href="{% url 'profile' liker.username %}" 
                       style="color: #374151; text-decoration: none;">
                      {{ liker.username }}
                    </a>
                  {% endif %}
                {% endfor %}
              {% elif non_user_likers_count == 2 %}
                <!-- You + 2 others -->
                {% for liker in post.likes.all|slice:":3" %}
                  {% if liker != request.user %}
                    {% if forloop.counter == 1 %}
                      , 
                      <a href="{% url 'profile' liker.username %}" 
                         style="font-weight: normal; color: #374151; text-decoration: none;">
                        {{ liker.username }}
                      </a>
                    {% elif forloop.counter == 2 %}
                      and 
                      <a href="{% url 'profile' liker.username %}" 
                         style="font-weight: normal; color: #374151; text-decoration: none;">
                        {{ liker.username }}
                      </a>
                    {% endif %}
                  {% endif %}
                {% endfor %}
              {% else %}
                <!-- You + 3+ others -->
                {% for liker in post.likes.all|slice:":3" %}
                  {% if liker != request.user %}
                    {% if forloop.counter == 1 %}
                      , 
                      <a href="{% url 'profile' liker.username %}" 
                         style="font-weight: normal; color: #374151; text-decoration: none;">
                        {{ liker.username }}
                      </a>
                    {% elif forloop.counter == 2 %}
                      and 
                      <a href="#" 
                         style="font-weight: normal; color: #374151; text-decoration: none;">
                        {{ non_user_likers_count|add:"-1" }} others
                      </a>
                    {% endif %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endwith %}
          {% endif %}
        
        {% else %}
          <!-- Current user has NOT liked the post -->
          {% if post.likes.count == 1 %}
            {% with liker=post.likes.first %}
              Liked by <a href="{% url 'profile' liker.username %}" 
                         style="font-weight: normal; color: #374151; text-decoration: none;">
                {{ liker.username }}
              </a>
            {% endwith %}
          
          {% elif post.likes.count == 2 %}
            {% with liker1=post.likes.all.0 liker2=post.likes.all.1 %}
              Liked by 
              <a href="{% url 'profile' liker1.username %}" 
                 style="font-weight: normal; color: #374151; text-decoration: none;">
                {{ liker1.username }}
              </a> and 
              <a href="{% url 'profile' liker2.username %}" 
                 style="font-weight: normal; color: #374151; text-decoration: none;">
                {{ liker2.username }}
              </a>
            {% endwith %}
          
          {% elif post.likes.count == 3 %}
            {% with liker1=post.likes.all.0 liker2=post.likes.all.1 liker3=post.likes.all.2 %}
              Liked by 
              <a href="{% url 'profile' liker1.username %}" 
                 style="font-weight: normal; color: #374151; text-decoration: none;">
                {{ liker1.username }}
              </a>, 
              <a href="{% url 'profile' liker2.username %}" 
                 style="font-weight: normal; color: #374151; text-decoration: none;">
                {{ liker2.username }}
              </a> and 
              <a href="{% url 'profile' liker3.username %}" 
                 style="font-weight: normal; color: #374151; text-decoration: none;">
                {{ liker3.username }}
              </a>
            {% endwith %}
          
          {% else %}
            {% with liker1=post.likes.all.0 liker2=post.likes.all.1 %}
              Liked by 
              <a href="{% url 'profile' liker1.username %}" 
                 style="font-weight: normal; color: #374151; text-decoration: none;">
                {{ liker1.username }}
              </a>, 
              <a href="{% url 'profile' liker2.username %}" 
                 style="font-weight: normal; color: #374151; text-decoration: none;">
                {{ liker2.username }}
              </a> and 
              <a href="#" 
                 style="font-weight: normal; color: #374151; text-decoration: none;">
                {{ post.likes.count|add:"-2" }} others
              </a>
            {% endwith %}
          {% endif %}
        {% endif %}
      </span>
    </div>

    <!-- VIEW COUNT (always shown) -->
    <span class="separator-dot">Â·</span>
    
    <div class="engagement-item">
      <span class="view-text">
        <i class="fa-regular fa-chart-bar"></i> {{post.view|intcomma }}
      </span>
    </div>
  </div>
</div>

<script>
// Simple function to trigger home page's repost functionality
function triggerHomePageRepost(postId, button) {
    // First, try to find and click the main post's repost button
    const mainRepostButton = document.querySelector(`.kf-repost-icon[onclick*="${postId}"]`);
    
    if (mainRepostButton) {
        // Found it! Click the main button to trigger home page functionality
        mainRepostButton.click();
        
        // Store reference to update snippet button later
        window.lastSnippetRepostButton = button;
        window.lastSnippetPostId = postId;
        
        // We'll update the count after a delay to match the home page response
        setTimeout(() => {
            updateSnippetRepostCountFromMain(postId, button);
        }, 500);
    } else {
        // Fallback: Use home page's global functions if available
        if (typeof window.parent !== 'undefined' && window.parent.kfToggleRepost) {
            window.parent.kfToggleRepost(postId, button);
        } else if (typeof kfToggleRepost !== 'undefined') {
            kfToggleRepost(postId, button);
        } else {
            // Ultimate fallback: simple prompt
            simpleRepostFallback(postId, button);
        }
    }
}

// Try to get updated count from main button
function updateSnippetRepostCountFromMain(postId, button) {
    const mainRepostButton = document.querySelector(`.kf-repost-icon[onclick*="${postId}"]`);
    if (mainRepostButton) {
        const mainCountSpan = mainRepostButton.querySelector('.kf-repost-count');
        if (mainCountSpan && mainCountSpan.textContent) {
            const count = mainCountSpan.textContent.trim();
            const countDisplay = button.querySelector('.repost-count-display');
            if (countDisplay) {
                countDisplay.textContent = count;
                countDisplay.classList.add('count-bounce');
                setTimeout(() => {
                    countDisplay.classList.remove('count-bounce');
                }, 400);
            }
        }
    }
}

// Fallback function only used if home page functions aren't available
function simpleRepostFallback(postId, button) {
    const isReposted = button.getAttribute('data-reposted') === 'true';
    const caption = prompt(isReposted ? 'Remove repost?' : 'Add a comment to your repost (optional):');
    
    if (caption !== null || isReposted) {
        // Show loading
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        button.disabled = true;
        
        // Get CSRF token
        const csrftoken = getCSRFToken();
        
        fetch(`/repost/${postId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                caption: caption || '',
                undo: isReposted
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update snippet button
                updateSnippetRepostButton(button, data);
                
                // Also try to update main button
                const mainBtn = document.querySelector(`.kf-repost-icon[onclick*="${postId}"]`);
                if (mainBtn) {
                    updateMainRepostButton(mainBtn, data);
                }
                
                // Show message and reload
                setTimeout(() => location.reload(), 800);
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Something went wrong. Please try again.');
        })
        .finally(() => {
            button.innerHTML = originalHTML;
            button.disabled = false;
        });
    }
}

// Helper to update snippet button
function updateSnippetRepostButton(button, data) {
    const icon = button.querySelector('i');
    const countDisplay = button.querySelector('.repost-count-display');
    
    if (data.reposted) {
        button.setAttribute('data-reposted', 'true');
        icon.classList.add('reposted');
        if (countDisplay) {
            countDisplay.textContent = data.repost_count || '0';
            countDisplay.classList.add('count-bounce');
            setTimeout(() => {
                countDisplay.classList.remove('count-bounce');
            }, 400);
        }
    } else {
        button.setAttribute('data-reposted', 'false');
        icon.classList.remove('reposted');
        if (countDisplay) {
            countDisplay.textContent = data.repost_count || '0';
            countDisplay.classList.add('count-bounce');
            setTimeout(() => {
                countDisplay.classList.remove('count-bounce');
            }, 400);
        }
    }
}

// Helper to update main button (matches home page styling)
function updateMainRepostButton(button, data) {
    const icon = button.querySelector('i');
    const countSpan = button.querySelector('.kf-repost-count');
    
    if (data.reposted) {
        icon.classList.add('reposted');
        button.setAttribute('data-reposted', 'true');
        if (data.repost_count > 0 && countSpan) {
            countSpan.textContent = data.repost_count;
            countSpan.classList.add('show');
        }
    } else {
        icon.classList.remove('reposted');
        button.setAttribute('data-reposted', 'false');
        if (data.repost_count > 0 && countSpan) {
            countSpan.textContent = data.repost_count;
        } else if (countSpan) {
            countSpan.classList.remove('show');
        }
    }
}

// Helper to get CSRF token
function getCSRFToken() {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, 10) === ('csrftoken=')) {
                cookieValue = decodeURIComponent(cookie.substring(10));
                break;
            }
        }
    }
    return cookieValue;
}

// Also update like and comment displays to show counts consistently
document.addEventListener('DOMContentLoaded', function() {
    // Update like button to show count
    const likeButtons = document.querySelectorAll('.like-btn');
    likeButtons.forEach(button => {
        const likeCount = button.querySelector('.like-count-display');
        if (likeCount) {
            // Already showing count
        }
    });
    
    // Update comment button to show count
    const commentButtons = document.querySelectorAll('.horizontal-action-item[href*="post_comment"]');
    commentButtons.forEach(button => {
        const commentCount = button.querySelector('.comment-count-display');
        if (commentCount) {
            // Already showing count
        }
    });
});
</script>

</body>
</html>