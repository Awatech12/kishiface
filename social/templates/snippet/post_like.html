{% load humanize %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
   
    
    <link rel="stylesheet" 
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" 
          xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMDJ8g359L5E727yL3rLw8x7e7Q6A2h9f6Jc8y5qP3f6sA7h3i5f6bN8Z6d5P8w==" 
          crossorigin="anonymous" 
          referrerpolicy="no-referrer" />
    
    <style>
       

        /* LIKERS AND ENGAGEMENT COUNTS SECTION */
        .engagement {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            padding: 12px 16px 8px;
            border-bottom: 1px solid #eee;
            margin-bottom: 0;
            gap: 12px;
        }

        .likers-container {
            display: flex;
            margin-right: 8px;
        }

        .liker-pic {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid white;
            margin-left: -5px;
            transition: transform 0.2s;
        }
        
        .likers-container a:first-child .liker-pic {
            margin-left: 0;
        }

        /* Instagram-style like text */
        .like-text {
            font-weight: 600;
            color: #374151;
        }

        .no-likes {
            color: #4b5563;
            font-weight: normal;
        }

        .you-text {
            font-weight: 600;
            color: #374151;
        }

        /* Comment text styling */
        .comment-text {
            font-size: 14px;
            color: #4b5563;
        }
        
        .comment-text a {
            color: #000;
            text-decoration: none;
            font-weight: 600;
        }
        
        .comment-text a:hover {
            text-decoration: underline;
        }
        
        .no-comments {
            color: #4b5563;
            font-weight: normal;
        }

        /* View count styling */
        .view-text {
            font-size: 14px;
            color: #4b5563;
        }

        /* Separator dots */
        .separator-dot {
            color: #4b5563;
            font-size: 14px;
            margin: 0 4px;
        }

        /* Engagement item container */
        .engagement-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* HORIZONTAL ACTIONS SECTION */
        .horizontal-actions-container {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 8px 16px 16px;
            gap: 20px;
        }

        .horizontal-action-item {
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: #4b5563;
            font-size: 14px;
            font-weight: 500;
            padding: 6px 10px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .horizontal-action-item:hover {
            background-color: #f3f4f6;
            color: #1f2937;
        }

        .horizontal-action-icon {
            font-size: 20px;
        }

        /* Social icon colors */
        .share-facebook:hover { color: #1877f2; }
        .share-twitter:hover { color: #1da1f2; }
        .share-whatsapp:hover { color: #25d366; }

        /* Like button active state */
        .horizontal-action-item .fa-heart {
            transition: color 0.2s;
        }

        /* Mobile adjustments */
        @media (max-width: 767px) {
            .horizontal-actions-container {
                gap: 15px;
            }
            
            .horizontal-action-item {
                padding: 6px 8px;
                gap: 6px;
                font-size: 13px;
            }
            
            .horizontal-action-icon {
                font-size: 18px;
            }
            
            .engagement {
                gap: 8px;
            }
        }
    </style>
</head>
<body>

<!-- Each post engagement block -->
<div id="post-engagement-{{ post.post_id }}">
  
  <!-- LIKERS AND ENGAGEMENT COUNTS SECTION -->
  <div class="engagement">
    <!-- Show liker avatars only if there are likes -->
    {% if post.likes.count > 0 %}
    <div class="likers-container">
      {% for liker in post.likes.all|slice:":3" %}
      <a href="{% url 'profile' liker.username %}">
        <img src="{{ liker.profile.picture.url }}"
             onerror="this.onerror=null; this.src='https://placehold.co/24x24/cccccc/ffffff?text=L';"
             alt="{{ liker.username }}" class="liker-pic">
      </a>
      {% endfor %}
    </div>
    {% endif %}

    <!-- LIKE COUNTING -->
    <div class="engagement-item">
      <span class="like-text">
        {% if post.likes.count == 0 %}
          <!-- No likes -->
          <span class="no-likes">Be the first to like this</span>
        
        {% elif request.user in post.likes.all %}
          <!-- Current user HAS liked the post -->
          {% if post.likes.count == 1 %}
            <!-- Only the current user has liked -->
            <span class="you-text">You</span>
          
          {% elif post.likes.count == 2 %}
            <!-- You + 1 other person -->
            {% for liker in post.likes.all %}
              {% if liker == request.user %}
                <span class="you-text">You</span> and 
              {% else %}
                <a href="{% url 'profile' liker.username %}" style="font-weight: 600; color: #374151; text-decoration: none;">
                  {{ liker.username }}
                </a>
              {% endif %}
            {% endfor %}
          
          {% elif post.likes.count == 3 %}
            <!-- You + 2 others -->
            {% for liker in post.likes.all %}
              {% if liker == request.user %}
                <span class="you-text">You</span>{% if not forloop.last %}, {% endif %}
              {% else %}
                {% if forloop.counter == 2 %}
                  <a href="{% url 'profile' liker.username %}" style="font-weight: 600; color: #374151; text-decoration: none;">
                    {{ liker.username }}
                  </a>
                  {% if not forloop.last %} and {% endif %}
                {% elif forloop.counter == 3 %}
                  <a href="{% url 'profile' liker.username %}" style="font-weight: 600; color: #374151; text-decoration: none;">
                    {{ liker.username }}
                  </a>
                {% endif %}
              {% endif %}
            {% endfor %}
          
          {% else %}
            <!-- You + 3+ others -->
            {% for liker in post.likes.all|slice:":3" %}
              {% if liker == request.user %}
                <span class="you-text">You</span>{% if not forloop.last %}, {% endif %}
              {% else %}
                {% if forloop.counter == 1 %}
                  <!-- First non-user liker -->
                  <a href="{% url 'profile' liker.username %}" style="font-weight: 600; color: #374151; text-decoration: none;">
                    {{ liker.username }}
                  </a>
                  {% if not forloop.last %}, {% endif %}
                {% elif forloop.counter == 2 %}
                  <!-- Second non-user liker - show "and X others" -->
                  and 
                  <a href="#" style="font-weight: 600; color: #374151; text-decoration: none;">
                    {{ post.likes.count|add:"-2" }} others
                  </a>
                {% endif %}
              {% endif %}
            {% endfor %}
          {% endif %}
        
        {% else %}
          <!-- Current user has NOT liked the post -->
          {% if post.likes.count == 1 %}
            {% with liker=post.likes.first %}
              Liked by <a href="{% url 'profile' liker.username %}" style="font-weight: 600; color: #374151; text-decoration: none;">
                {{ liker.username }}
              </a>
            {% endwith %}
          
          {% elif post.likes.count == 2 %}
            {% with liker1=post.likes.all.0 liker2=post.likes.all.1 %}
              Liked by 
              <a href="{% url 'profile' liker1.username %}" style="font-weight: 600; color: #374151; text-decoration: none;">
                {{ liker1.username }}
              </a> and 
              <a href="{% url 'profile' liker2.username %}" style="font-weight: 600; color: #374151; text-decoration: none;">
                {{ liker2.username }}
              </a>
            {% endwith %}
          
          {% elif post.likes.count == 3 %}
            {% with liker1=post.likes.all.0 liker2=post.likes.all.1 liker3=post.likes.all.2 %}
              Liked by 
              <a href="{% url 'profile' liker1.username %}" style="font-weight: 600; color: #374151; text-decoration: none;">
                {{ liker1.username }}
              </a>, 
              <a href="{% url 'profile' liker2.username %}" style="font-weight: 600; color: #374151; text-decoration: none;">
                {{ liker2.username }}
              </a> and 
              <a href="{% url 'profile' liker3.username %}" style="font-weight: 600; color: #374151; text-decoration: none;">
                {{ liker3.username }}
              </a>
            {% endwith %}
          
          {% else %}
            {% with liker1=post.likes.all.0 liker2=post.likes.all.1 %}
              Liked by 
              <a href="{% url 'profile' liker1.username %}" style="font-weight: 600; color: #374151; text-decoration: none;">
                {{ liker1.username }}
              </a>, 
              <a href="{% url 'profile' liker2.username %}" style="font-weight: 600; color: #374151; text-decoration: none;">
                {{ liker2.username }}
              </a> and 
              <a href="#" style="font-weight: 600; color: #374151; text-decoration: none;">
                {{ post.likes.count|add:"-2" }} others
              </a>
            {% endwith %}
          {% endif %}
        {% endif %}
      </span>
    </div>

    <!-- COMMENT COUNTING (only shown if there are likes) -->
    {% if post.likes.count > 0 %}
    <span class="separator-dot">·</span>
    {% endif %}
    
    <div class="engagement-item">
      <span class="comment-text">
        {% if post.comments.count == 0 %}
          <span class="no-comments">No comments</span>
        {% elif post.comments.count == 1 %}
          <a href="{% url 'post_comment' post.post_id %}">1 comment</a>
        {% else %}
          <a href="{% url 'post_comment' post.post_id %}">{{ post.comments.count|intcomma }} comments</a>
        {% endif %}
      </span>
    </div>

    <!-- VIEW COUNT (always shown) -->
    <span class="separator-dot">·</span>
    
    <div class="engagement-item">
      <span class="view-text">
        <i class="fa-regular fa-eye"></i> {{post.view|intcomma }}
      </span>
    </div>
  </div>

  <!-- HORIZONTAL ACTION BUTTONS -->
  <div class="horizontal-actions-container">
    
    <!-- LIKE/UNLIKE BUTTON -->
    <a href="#"
       hx-get="{% url 'like_post' post.post_id %}"
       hx-target="#post-engagement-{{ post.post_id }}"
       hx-swap="outerHTML"
       class="horizontal-action-item">
      {% if request.user in post.likes.all %}
      <i class="fa-solid fa-heart horizontal-action-icon" style="color: #ff2c55;"></i>
      <span>Liked</span>
      {% else %}
      <i class="fa-regular fa-heart horizontal-action-icon"></i>
      <span>Like</span>
      {% endif %}
    </a>

    <!-- COMMENT BUTTON -->
    <a href="{% url 'post_comment' post.post_id %}" class="horizontal-action-item">
      <i class="fa-regular fa-comment horizontal-action-icon"></i>
      {% if post.comments.count == 0 %}
      <span>Comment</span>
      {% elif post.comments.count == 1 %}
      <span>1 comment</span>
      {% else %}
      <span>{{ post.comments.count|intcomma }} comments</span>
      {% endif %}
    </a>

    <!-- FACEBOOK -->
    <a href="#" class="horizontal-action-item share-facebook"
       data-media="https://kishiface.pythonanywhere.com/{{post.post_id}}">
      <i class="fab fa-facebook horizontal-action-icon"></i>
      <span>Share</span>
    </a>

    <!-- TWITTER -->
    <a href="#" class="horizontal-action-item share-twitter"
       data-message="{{ post.message|urlencode }}"
       data-media="https://kishiface.pythonanywhere.com/{{post.post_id}}">
      <i class="fab fa-twitter horizontal-action-icon"></i>
      <span>Tweet</span>
    </a>

    <!-- WHATSAPP -->
    <a href="#" class="horizontal-action-item share-whatsapp"
       data-message="{{ post.message|urlencode }}"
       data-media="https://kishiface.pythonanywhere.com/comment/{{post.post_id}}">
      <i class="fab fa-whatsapp horizontal-action-icon"></i>
      <span>Share</span>
    </a>
  </div>
</div>

<!-- SCRIPT: Handles share buttons -->
<script>
document.addEventListener('click', function(e) {
    const whatsappBtn = e.target.closest('.share-whatsapp');
    const facebookBtn = e.target.closest('.share-facebook');
    const twitterBtn = e.target.closest('.share-twitter');

    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

    // WHATSAPP
    if (whatsappBtn) {
        e.preventDefault();
        // Use encodeURIComponent for safety
        const message = encodeURIComponent(whatsappBtn.getAttribute('data-message'));
        const media = encodeURIComponent(whatsappBtn.getAttribute('data-media'));
        
        const text = `${message}%20${media}`;
        
        // Determine URL based on device
        const url = isMobile
            ? `https://api.whatsapp.com/send?text=${text}`
            : `https://web.whatsapp.com/send?text=${text}`;
        window.open(url, '_blank');
    }

    // FACEBOOK
    if (facebookBtn) {
        e.preventDefault();
        const media = encodeURIComponent(facebookBtn.getAttribute('data-media'));
        const url = `https://www.facebook.com/sharer/sharer.php?u=${media}`;
        window.open(url, '_blank');
    }

    // TWITTER
    if (twitterBtn) {
        e.preventDefault();
        const message = encodeURIComponent(twitterBtn.getAttribute('data-message'));
        const media = encodeURIComponent(twitterBtn.getAttribute('data-media'));
        const url = `https://twitter.com/intent/tweet?text=${message}%20${media}`;
        window.open(url, '_blank');
    }
});
</script>

</body>
</html>