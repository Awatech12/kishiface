{% load humanize %}
{% load static %}
{% load time %}
{% load text_filters %}  
<div class="comment">
    
    {% if comment.author.profile.picture.url %}
        <img src="{{ comment.author.profile.picture.url }}" alt="Profile" class="avatar-img">
    {% else %}
        <div class="avatar-letter">
            {{ comment.author.first_name|default:"?"|slice:"1" }}
        </div>
    {% endif %}

    <div class="comment-body">
      
      <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 1px;">
        <a href="{% url 'profile' comment.author.username %}" class="username">
          {{ comment.author.first_name }} {{ comment.author.last_name }}
        </a>
        {% if comment.author.profile.is_verify and comment.author.first_name %}
          <img src="{% static 'images/verify1.jpg' %}" height="14" width="14" alt="" style="vertical-align: middle;">
        {% endif %}
      </div>
      
      <p class="text">{{ comment.comment|format_post_text}}</p>

      {% if comment.image %}
        <img src="{{ comment.image.url }}" alt="Comment Image" class="comment-image">
      {% endif %}

      {% if comment.file %}
        <div class="audio-container" data-src="{{ comment.file.url }}">
            <!-- Audio wave visualization -->
            <div class="audio-wave" id="wave-{{ comment.comment_id }}">
                <div class="wave-bar" style="height: 4px;"></div>
                <div class="wave-bar" style="height: 6px;"></div>
                <div class="wave-bar" style="height: 8px;"></div>
                <div class="wave-bar" style="height: 6px;"></div>
                <div class="wave-bar" style="height: 4px;"></div>
            </div>
            
            <audio class="hidden-audio" preload="metadata" id="audio-{{ comment.comment_id }}">
                <source src="{{ comment.file.url }}" type="audio/webm">
            </audio>

            <button class="play-pause-btn" data-state="paused">
                <i class="fas fa-play"></i>
            </button>

            <div class="progress-wrapper">
                <div class="progress-bar">
                    <div class="progress-filled"></div>
                </div>
                <span class="time-display">0:00</span>
            </div>
            
            <!-- Download button -->
            <button class="audio-download-btn" onclick="kfDownloadCommentAudio('{{ comment.comment_id }}', '{{ comment.file.url }}')" title="Download audio">
                <i class="fas fa-download"></i>
            </button>
        </div>
      {% endif %}

      <div class="comment-meta">
        <span>{{comment.created_at|insta_timesince}}</span>
        <a href="{% url 'comment_reply' comment.comment_id %}">Reply</a>
      </div>
    </div>
    
    <div class="comment-actions">
         <span id="comment_like-{{comment.comment_id}}">
                {% include 'snippet/comment_like.html' %}
        </span>
    </div>
</div>

<script>
// Initialize audio wave animation for Instagram-style player
function initAudioWave(container, audioId) {
    const wave = container.querySelector('.audio-wave');
    const bars = wave.querySelectorAll('.wave-bar');
    const audio = document.getElementById('audio-' + audioId);
    
    if (audio) {
        // Set initial small bars (Instagram style)
        bars.forEach((bar, index) => {
            const heights = [4, 6, 8, 6, 4];
            bar.style.height = heights[index] + 'px';
        });
        
        // Animate when playing
        audio.addEventListener('play', function() {
            container.classList.add('playing');
            let animationInterval;
            
            bars.forEach((bar, index) => {
                // Create pulsing animation
                animationInterval = setInterval(() => {
                    if (!audio.paused) {
                        const baseHeight = [4, 6, 8, 6, 4][index];
                        const variation = Math.random() * 4;
                        bar.style.height = (baseHeight + variation) + 'px';
                        bar.style.transition = 'height 0.2s ease';
                    }
                }, 200 + index * 50);
            });
            
            // Store interval for cleanup
            audio._waveInterval = animationInterval;
        });
        
        // Reset when paused
        audio.addEventListener('pause', function() {
            container.classList.remove('playing');
            if (audio._waveInterval) {
                clearInterval(audio._waveInterval);
            }
            bars.forEach((bar, index) => {
                const baseHeight = [4, 6, 8, 6, 4][index];
                bar.style.height = baseHeight + 'px';
            });
        });
        
        // Reset when ended
        audio.addEventListener('ended', function() {
            container.classList.remove('playing');
            if (audio._waveInterval) {
                clearInterval(audio._waveInterval);
            }
            bars.forEach((bar, index) => {
                const baseHeight = [4, 6, 8, 6, 4][index];
                bar.style.height = baseHeight + 'px';
            });
        });
    }
}

// Download function for comment audio
function kfDownloadCommentAudio(id, url) {
    const link = document.createElement('a');
    link.href = url;
    link.download = `voice_message_${id}.webm`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Initialize when comment is added
if (typeof htmx !== 'undefined') {
    htmx.onLoad(function(content) {
        const audioContainers = content.querySelectorAll ? content.querySelectorAll('.audio-container') : [];
        audioContainers.forEach(container => {
            if (container.dataset.src) {
                const audioId = container.dataset.src.split('/').pop().split('.')[0];
                initAudioWave(container, audioId);
                
                // Initialize audio player
                const audio = container.querySelector('.hidden-audio');
                const playPauseBtn = container.querySelector('.play-pause-btn');
                const icon = playPauseBtn.querySelector('i');
                const timeDisplay = container.querySelector('.time-display');
                const progressFilled = container.querySelector('.progress-filled');
                
                // Format time function
                const formatTime = (seconds) => {
                    if (isNaN(seconds)) return '0:00';
                    const minutes = Math.floor(seconds / 60);
                    const remainingSeconds = Math.floor(seconds % 60);
                    return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
                };
                
                // Set duration on load
                audio.onloadedmetadata = () => {
                    if (audio.duration && !isNaN(audio.duration)) {
                        timeDisplay.textContent = formatTime(audio.duration);
                    }
                };
                
                // Update progress
                audio.addEventListener('timeupdate', () => {
                    const progress = (audio.currentTime / audio.duration) * 100;
                    progressFilled.style.width = `${progress}%`;
                    timeDisplay.textContent = formatTime(audio.currentTime);
                });
                
                // Play/pause toggle
                playPauseBtn.addEventListener('click', () => {
                    if (audio.paused || audio.ended) {
                        // Pause all other audios
                        document.querySelectorAll('.hidden-audio').forEach(otherAudio => {
                            if (otherAudio !== audio && !otherAudio.paused) {
                                otherAudio.pause();
                                const otherContainer = otherAudio.closest('.audio-container');
                                if (otherContainer) {
                                    otherContainer.classList.remove('playing');
                                    const otherBtn = otherContainer.querySelector('.play-pause-btn');
                                    const otherIcon = otherBtn.querySelector('i');
                                    otherIcon.className = 'fas fa-play';
                                }
                            }
                        });
                        
                        audio.play();
                        container.classList.add('playing');
                        icon.className = 'fas fa-pause';
                    } else {
                        audio.pause();
                        container.classList.remove('playing');
                        icon.className = 'fas fa-play';
                    }
                });
                
                // Reset on end
                audio.addEventListener('ended', () => {
                    container.classList.remove('playing');
                    icon.className = 'fas fa-play';
                    progressFilled.style.width = '0%';
                    if (audio.duration && !isNaN(audio.duration)) {
                        timeDisplay.textContent = formatTime(audio.duration);
                    }
                });
            }
        });
    });
}
</script>