<!-- snippet/comment_replies.html - Full updated version with no space between like and edit/delete -->
{% load humanize %}
{% load static %}
{% load time %}
{% load text_filters %}

{% for reply in replies %}
<div class="reply-item" id="reply-{{ reply.reply_id }}" data-author="{{ reply.author.username }}" data-author-name="{{ reply.author.first_name }} {{ reply.author.last_name }}">
    <div style="display: flex; gap: 8px;">
        <!-- Reply Author Avatar -->
        {% if reply.author.profile.picture.url %}
            <img src="{{ reply.author.profile.picture.url }}" alt="" style="width: 28px; height: 28px; border-radius: 50%; object-fit: cover;">
        {% else %}
            <div style="width: 28px; height: 28px; border-radius: 50%; background: linear-gradient(45deg, #833ab4, #fd1d1d, #fcb045); color: white; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600;">
                {{ reply.author.first_name|default:"?"|slice:"1" }}
            </div>
        {% endif %}
        
        <div style="flex: 1;">
            <!-- Reply Header -->
            <div style="display: flex; align-items: center; gap: 4px; flex-wrap: wrap;">
                <a href="{% url 'profile' reply.author.username %}" style="font-weight: 600; font-size: 13px; color: #262626; text-decoration: none;">
                    {{ reply.author.first_name }} {{ reply.author.last_name }}
                    {% if reply.author.profile.is_verify %}
                        <img src="{% static 'images/verify1.jpg' %}" height="12" width="12" alt="âœ“">
                    {% endif %}
                </a>
                <span style="font-size: 11px; color: #8e8e8e;">
                    {{ reply.created_at|insta_timesince }}
                    {% if reply.is_edited %}
                        <span style="color: #8e8e8e; font-size: 10px;">(edited)</span>
                    {% endif %}
                </span>
            </div>
            
            <!-- Reply Content -->
            <div class="reply-content" id="reply-content-{{ reply.reply_id }}" style="font-size: 14px; line-height: 1.4; color: #262626; margin-top: 2px;">
                {{ reply.reply_text|format_comment_text|safe }}
            </div>
            
            <!-- Edit Form (hidden by default) -->
            <div class="edit-reply-form" id="edit-form-{{ reply.reply_id }}" style="display: none; margin-top: 8px;">
                <form class="edit-reply-form" 
                      hx-post="{% url 'edit_reply' reply.reply_id %}"
                      hx-target="#reply-content-{{ reply.reply_id }}"
                      hx-swap="outerHTML"
                      hx-on::after-request="if(event.detail.successful) { hideEditForm('{{ reply.reply_id }}'); }">
                    {% csrf_token %}
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <textarea name="reply_text" 
                                  style="width: 100%; padding: 8px 12px; border: 1px solid #dbdbdb; border-radius: 8px; font-size: 13px; resize: vertical;"
                                  rows="2">{{ reply.reply_text }}</textarea>
                        <div style="display: flex; gap: 8px; justify-content: flex-end;">
                            <button type="button" onclick="hideEditForm('{{ reply.reply_id }}')" 
                                    style="background: none; border: none; color: #8e8e8e; font-size: 12px; cursor: pointer; padding: 4px 8px;">
                                Cancel
                            </button>
                            <button type="submit" 
                                    style="background: #0095f6; border: none; color: white; font-size: 12px; font-weight: 600; cursor: pointer; padding: 4px 12px; border-radius: 4px;">
                                Save
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Reply Actions - No space between like and edit/delete -->
            <div style="display: flex; align-items: center; gap: 4px; margin-top: 4px; flex-wrap: wrap;">
                <button class="reply-action-btn like-reply-btn" data-reply-id="{{ reply.reply_id }}" style="background: none; border: none; color: #8e8e8e; font-size: 11px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px; padding: 4px 0;">
                    <i class="far fa-heart"></i>
                    <span class="reply-likes-count">{{ reply.like.count }}</span>
                </button>
                
                <!-- Edit/Delete buttons (only for author) - directly next to like button -->
                {% if request.user == reply.author %}
                    <button class="reply-action-btn" onclick="showEditForm('{{ reply.reply_id }}')" style="color: #8e8e8e; background: none; border: none; font-size: 11px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px; padding: 4px 0; margin-left: 0;">
                        <i class="far fa-edit"></i> Edit
                    </button>
                    
                    <button class="reply-action-btn" onclick="deleteReply('{{ reply.reply_id }}')" style="color: #ed4956; background: none; border: none; font-size: 11px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px; padding: 4px 0;">
                        <i class="far fa-trash-alt"></i> Delete
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- Delete Confirmation Modal -->
<div class="delete-modal" id="deleteModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 16px; padding: 24px; max-width: 320px; width: 90%; box-shadow: 0 8px 24px rgba(0,0,0,0.2);">
        <h3 style="font-size: 18px; margin-bottom: 8px; font-weight: 600;">Delete Reply?</h3>
        <p style="color: #8e8e8e; margin-bottom: 24px; font-size: 14px;">This action cannot be undone.</p>
        <div style="display: flex; gap: 12px;">
            <button onclick="closeDeleteModal()" style="flex: 1; padding: 10px; background: #efefef; border: none; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer;">Cancel</button>
            <button id="confirmDeleteBtn" style="flex: 1; padding: 10px; background: #ed4956; color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer;">Delete</button>
        </div>
    </div>
</div>

<script>
// Store current reply to delete
let currentReplyId = null;

// Delete functionality
function deleteReply(replyId) {
    currentReplyId = replyId;
    const modal = document.getElementById('deleteModal');
    modal.style.display = 'flex';
    
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    confirmBtn.onclick = function() {
        fetch(`/reply/${currentReplyId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const replyElement = document.getElementById(`reply-${currentReplyId}`);
                if (replyElement) {
                    // Fade out animation
                    replyElement.style.transition = 'opacity 0.3s ease';
                    replyElement.style.opacity = '0';
                    setTimeout(() => {
                        replyElement.remove();
                    }, 300);
                }
                closeDeleteModal();
            }
        });
    };
}

function closeDeleteModal() {
    const modal = document.getElementById('deleteModal');
    modal.style.display = 'none';
    currentReplyId = null;
}

// Edit functionality
function showEditForm(replyId) {
    const content = document.getElementById(`reply-content-${replyId}`);
    const editForm = document.getElementById(`edit-form-${replyId}`);
    
    if (content && editForm) {
        content.style.display = 'none';
        editForm.style.display = 'block';
        
        // Focus the textarea
        const textarea = editForm.querySelector('textarea');
        if (textarea) {
            textarea.focus();
            textarea.setSelectionRange(textarea.value.length, textarea.value.length);
        }
    }
}

function hideEditForm(replyId) {
    const content = document.getElementById(`reply-content-${replyId}`);
    const editForm = document.getElementById(`edit-form-${replyId}`);
    
    if (content && editForm) {
        content.style.display = 'block';
        editForm.style.display = 'none';
    }
}

// Like reply functionality
document.querySelectorAll('.like-reply-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const replyId = this.dataset.replyId;
        const icon = this.querySelector('i');
        const countSpan = this.querySelector('.reply-likes-count');
        
        fetch(`/api/like-reply/${replyId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.liked) {
                icon.className = 'fas fa-heart';
                icon.style.color = '#ed4956';
                // Add pop animation
                icon.style.transform = 'scale(1.2)';
                setTimeout(() => {
                    icon.style.transform = 'scale(1)';
                }, 200);
            } else {
                icon.className = 'far fa-heart';
                icon.style.color = '';
            }
            countSpan.textContent = data.likes_count;
        })
        .catch(error => console.error('Error liking reply:', error));
    });
});

// Auto-resize textareas
document.querySelectorAll('textarea').forEach(textarea => {
    textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });
});

// Initialize any dynamic content loaded via HTMX
if (typeof htmx !== 'undefined') {
    htmx.onLoad(function(content) {
        // Re-attach like button listeners
        content.querySelectorAll('.like-reply-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const replyId = this.dataset.replyId;
                const icon = this.querySelector('i');
                const countSpan = this.querySelector('.reply-likes-count');
                
                fetch(`/api/like-reply/${replyId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.liked) {
                        icon.className = 'fas fa-heart';
                        icon.style.color = '#ed4956';
                    } else {
                        icon.className = 'far fa-heart';
                        icon.style.color = '';
                    }
                    countSpan.textContent = data.likes_count;
                });
            });
        });
        
        // Auto-resize any new textareas
        content.querySelectorAll('textarea').forEach(textarea => {
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
        });
        
        // Re-attach edit button listeners
        content.querySelectorAll('[onclick^="showEditForm"]').forEach(btn => {
            const replyId = btn.getAttribute('onclick').match(/'([^']+)'/)[1];
            btn.onclick = () => showEditForm(replyId);
        });
        
        // Re-attach delete button listeners
        content.querySelectorAll('[onclick^="deleteReply"]').forEach(btn => {
            const replyId = btn.getAttribute('onclick').match(/'([^']+)'/)[1];
            btn.onclick = () => deleteReply(replyId);
        });
    });
}
</script>