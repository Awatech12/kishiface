{% load humanize %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KishiFace - Channel</title>

  <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.7/dist/htmx.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <style>
:root {
  --primary: #666; /* Main color */
  --white: #fff;
  --msg-bg: #f2f2f2;
  --text-dark: #111;
  --text-light: #777;
  --love-liked: #666;
  --love-unliked: #fff;
}

body {
  font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  margin: 0;
  background: var(--white);
  color: var(--text-dark);
}

main.container {
  max-width: 768px;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}

/* HEADER */
.channel-header {
  display: flex;
  align-items: center;
  padding: 12px 15px;
  border-bottom: 1px solid var(--primary); 
  background-color: var(--white); 
  color: var(--primary); 
  position: sticky;
  top: 0;
  z-index: 20;
}
.header-icon i { font-size: 1.4rem; color: var(--primary); }
.channel-avatar img { width: 42px; height: 42px; border-radius: 50%; object-fit: cover; margin: 0 12px; }
.channel-name { font-size: 1rem; font-weight: 600; color: var(--text-dark); }
.channel-stats { font-size: 0.75rem; color: var(--text-light); }

/* MESSAGE FEED */
.main-feed { flex: 1; overflow: hidden; }
#messageOutput {
  flex-grow: 1;
  overflow-y: auto;
  padding: 10px 12px;
  max-height: calc(100vh - 115px);
  /* Centering Messages CSS Change */
  display: flex;
  flex-direction: column;
  align-items: center; 
}

/* MESSAGE STRUCTURE */
.chat-message { 
  width: 100%; 
  display: flex; 
  /* Centering Messages CSS Change */
  justify-content: center; 
  margin: 6px 0; 
} 
.message-block {
  max-width: 80%;
  background: var(--msg-bg);
  padding: 10px 14px;
  border-radius: 18px;
  position: relative;
}
.message-author-name { font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; display: block; text-align: left; }
.message-text { font-size: 0.95rem; line-height: 1.4; }
.message-text .emoji-text { font-size: 1.5rem; line-height: 1.2; }

/* Styles for shared media (image, video) */
.message-media {
  max-width: 100%;
  border-radius: 10px;
  margin-top: 6px;
  display: block;
}
.message-block img.message-media {
  max-height: 280px;
  object-fit: contain;
}
/* Hide default controls */
.message-block audio,
.message-block video {
  display: none !important;
}

/* *** IMPORTANT FIX: Overrides the previous rule for the VISIBLE video element 
*** The video display element is inside .custom-video-player and has class .message-media
*/
.custom-video-player .message-media {
    display: block !important; 
    max-height: 280px; /* Reuse image max-height */
    object-fit: contain;
}

/* Custom Player Styles (Audio/Video) */
.custom-audio-player,
.custom-video-player {
  display: flex;
  align-items: center;
  gap: 10px;
  background: var(--white);
  border-radius: 12px;
  padding: 8px 12px;
  margin-top: 6px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
.custom-audio-player { 
    max-width: 250px; 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}
.custom-video-player { 
    flex-direction: column; 
    padding: 10px; 
    max-width: 320px; 
    background: #000;
} 

.player-controls {
    display: flex;
    align-items: center;
    width: 100%;
    gap: 10px;
}
.player-controls:not(:first-child) {
    margin-top: 8px;
}

.player-play-btn {
  background: var(--primary);
  color: var(--white);
  border: none;
  border-radius: 50%;
  width: 34px;
  height: 34px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  flex-shrink: 0;
  transition: background 0.2s;
}
.player-play-btn i {
  font-size: 0.8rem;
  margin-left: 2px; /* Slight shift right for play icon */
}
.player-play-btn .fa-pause {
    margin-left: 0;
}
.custom-audio-player .player-play-btn {
    background: white;
    color: #667eea;
}

.player-progress-bar {
  flex-grow: 1;
  height: 6px;
  background: #ccc;
  border-radius: 3px;
  position: relative;
  cursor: pointer;
}
.player-progress {
  height: 100%;
  width: 0%;
  background: var(--primary);
  border-radius: 3px;
}
.custom-audio-player .player-progress-bar {
    background: rgba(255,255,255,0.3);
}
.custom-audio-player .player-progress {
    background: white;
}

.player-time {
  font-size: 0.75rem;
  color: var(--text-light);
  flex-shrink: 0;
  min-width: 30px;
}
.custom-audio-player .player-time {
    color: white;
}

.player-fullscreen-btn,
.player-volume-btn {
    background: none;
    border: none;
    color: var(--primary);
    cursor: pointer;
    font-size: 1rem;
    padding: 5px;
    border-radius: 50%;
    width: 34px;
    height: 34px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.custom-audio-player .player-volume-btn {
    color: white;
}
.player-fullscreen-btn:hover,
.player-volume-btn:hover {
    background: rgba(0,0,0,0.1);
}

/* Ensure video has proper aspect ratio */
.custom-video-player .message-media {
    width: 100%;
    max-height: 280px;
    border-radius: 8px;
    background: #000;
}

/* Style for downloadable documents/files & image download container*/
.message-file-block {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 12px;
  background: var(--white); 
  border: 1px solid #ccc;
  border-radius: 10px;
  margin-top: 6px;
}
.message-file-block i { font-size: 1.8rem; color: var(--primary); } 
.message-file-details { display: flex; flex-direction: column; }
.message-file-details span.file-name {
  font-size: 0.9rem;
  font-weight: 500;
  max-width: 180px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.message-file-details a.file-download-btn {
  font-size: 0.75rem;
  color: var(--primary); 
  text-decoration: none;
  font-weight: 600;
}
.message-file-details a.file-download-btn:hover { text-decoration: underline; }

.time-and-reactions-wrapper { margin-top: 6px; display: flex; align-items: center; gap: 10px; justify-content: flex-start; }
.msg-time { font-size: 0.7rem; color: var(--text-light); }
.like-button { border: none; background: none; cursor: pointer; font-size: 1rem; }
.like-button i { color: var(--text-light); transition: color 0.2s; }
.like-button.liked i { color: var(--primary); } 
.reaction-count { font-size: 0.75rem; color: var(--text-light); }

/* DATE SEPARATOR */
.date-separator { text-align: center; margin: 10px 0; width: 100%; }
.date-separator i {
  background: #eee;
  padding: 5px 12px;
  border-radius: 12px;
  font-size: 0.7rem;
  color: var(--text-light);
}

/* INPUT BAR */
#chatInputWrapper {
  background: var(--white);
  border-top: 1px solid #ddd;
  padding: 10px 12px;
  position: sticky;
  bottom: 0;
  z-index: 30;
  display: flex;
  justify-content: center;
}
.inner-wrapper { width: 90%; display: flex; align-items: center; }

.input-box { flex: 1; position: relative; display: flex; align-items: center; }
#message {
  width: 100%;
  border-radius: 22px;
  border: 1px solid #ccc;
  padding: 10px 100px 10px 15px;
  font-size: 0.95rem;
}
#message:focus { outline: none; border-color: var(--primary); }

/* BUTTONS INSIDE INPUT */
.input-box .inside-emoji-btn,
.input-box .inside-file-btn,
.input-box .inside-send-btn {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  font-size: 1.35rem;
  cursor: pointer;
  color: var(--text-light);
}
.input-box .inside-send-btn { right: 12px; font-size: 1.25rem; color: #ccc; }
.input-box .inside-send-btn.active { color: var(--primary); } 
.input-box .inside-emoji-btn { right: 50px; }
.input-box .inside-file-btn { right: 85px; } /* Using generic class name */

/* EMOJI PICKER */
#emojiPicker {
  display: none;
  position: absolute;
  bottom: 45px;
  right: 0;
  background: var(--white);
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 10px;
  max-width: 320px;
  max-height: 200px;
  overflow-y: auto;
  z-index: 50;
}
#emojiPicker .emoji { cursor: pointer; font-size: 1.3rem; margin: 3px; display: inline-block; }
#emojiPicker .emoji:hover { background: #eee; border-radius: 5px; }
  </style>
</head>

<body>
<main class="container">

  <div class="channel-header">
    <a href="{% url 'channel_create' %}" class="header-icon"><i class="fa-solid fa-arrow-left"></i></a>
    <div class="channel-avatar"><img src="{{ channel.image.url }}" alt="{{ channel.channel_name }}"></div>
    <div>
      <h2 class="channel-name">{{ channel.channel_name }}</h2>
      <div class="channel-stats">{{ channel.subscriber.count|intcomma }} followers</div>
    </div>
  </div>

  <div class="main-feed">
    <div id="messageOutput">
      {% for date_label, msgs in grouped_messages.items %}
        <div class="date-separator"><i>{{ date_label }}</i></div>
        {% for message in msgs %}
        <div class="chat-message">
          <div class="message-block" id="msg-{{ message.channemessage_id }}">
            <span class="message-author-name">
              <a href="{% url 'profile' message.author %}" style="text-decoration:none;color:#111;">
                {{ message.author }}
              </a>
            </span>
            {% if message.message %}
              <div class="message-text">{{ message.message }}</div>
            {% endif %}

            {% if message.file %}
              {% if message.file_type == 'image' %}
                <img src="{{ message.file.url }}" class="message-media" loading="lazy">
                <div class="message-file-block">
                  <i class="fa-solid fa-file-image"></i>
                  <div class="message-file-details">
                    <span class="file-name">{{ message.file_name|default:"Image File" }}</span>
                    <a href="{{ message.file.url }}" class="file-download-btn" download="{{ message.file_name }}">Download Image</a>
                  </div>
                </div>
              {% elif message.file_type == 'video' %}
                <!-- Hidden video element for control -->
                <video id="video-{{ message.channemessage_id }}" 
                       src="{{ message.file.url }}"
                       preload="metadata"></video>
                
                <div class="custom-video-player" data-msg-id="{{ message.channemessage_id }}">
                    <!-- Visible video element -->
                    <video id="video-display-{{ message.channemessage_id }}" 
                           src="{{ message.file.url }}" 
                           class="message-media" 
                           preload="metadata"
                           playsinline
                           webkit-playsinline
                           controlslist="nodownload"
                           oncontextmenu="return false;"></video>
                    
                    <div class="player-controls">
                      <button class="player-play-btn" onclick="toggleVideoPlayback(this, '{{ message.channemessage_id }}')">
                        <i class="fa-solid fa-play"></i>
                      </button>
                      <div class="player-progress-bar" onclick="seekVideo(event, '{{ message.channemessage_id }}')">
                        <div id="progress-{{ message.channemessage_id }}" class="player-progress"></div>
                      </div>
                      <span id="time-{{ message.channemessage_id }}" class="player-time">0:00</span>
                      <button class="player-fullscreen-btn" onclick="toggleFullscreen('{{ message.channemessage_id }}')">
                        <i class="fa-solid fa-expand"></i>
                      </button>
                    </div>
                </div>

                <div class="message-file-block">
                  <i class="fa-solid fa-file-video"></i>
                  <div class="message-file-details">
                    <span class="file-name">{{ message.file_name|default:"Video File" }}</span>
                    <a href="{{ message.file.url }}" class="file-download-btn" download="{{ message.file_name }}">Download Video</a>
                  </div>
                </div>
              {% elif message.file_type == 'audio' %}
                <audio id="audio-{{ message.channemessage_id }}" 
                       src="{{ message.file.url }}"
                       preload="metadata"></audio>
                
                <div class="custom-audio-player" data-msg-id="{{ message.channemessage_id }}">
                  <button class="player-play-btn" onclick="toggleAudioPlayback(this, '{{ message.channemessage_id }}')">
                    <i class="fa-solid fa-play"></i>
                  </button>
                  <div class="player-progress-bar" onclick="seekAudio(event, '{{ message.channemessage_id }}')">
                    <div id="progress-{{ message.channemessage_id }}" class="player-progress"></div>
                  </div>
                  <span id="time-{{ message.channemessage_id }}" class="player-time">0:00</span>
                  <button class="player-volume-btn" onclick="toggleMute('{{ message.channemessage_id }}')">
                    <i class="fa-solid fa-volume-high"></i>
                  </button>
                </div>

                <div class="message-file-block">
                  <i class="fa-solid fa-file-audio"></i>
                  <div class="message-file-details">
                    <span class="file-name">{{ message.file_name|default:"Audio File" }}</span>
                    <a href="{{ message.file.url }}" class="file-download-btn" download="{{ message.file_name }}">Download Audio</a>
                  </div>
                </div>
              {% else %}
                <div class="message-file-block">
                  <i class="fa-solid fa-file"></i>
                  <div class="message-file-details">
                    <span class="file-name">{{ message.file_name|default:"Document File" }}</span>
                    <a href="{{ message.file.url }}" class="file-download-btn" download="{{ message.file_name }}">Download File</a>
                  </div>
                </div>
              {% endif %}
            {% endif %}
            <div class="time-and-reactions-wrapper">
              <span class="reaction-count" id="like-count-{{ message.channemessage_id }}">{{ message.like.count }}</span>
              <button class="like-button {% if user in message.like.all %}liked{% endif %}" data-msg-id="{{ message.channemessage_id }}" onclick="sendLikeAction(this)">
                <i class="{% if user in message.like.all %}fa-solid{% else %}fa-regular{% endif %} fa-heart"></i>
              </button>
              <span class="msg-time">{{ message.chat_time }}</span>
            </div>
          </div>
        </div>
        {% endfor %}
      {% endfor %}
      <div id="scroll-anchor"></div>
    </div>
  </div>

  <div id="chatInputWrapper">
    <div class="inner-wrapper">
      <div class="input-box">
        <input type="text" id="message" placeholder="Message {{ channel.channel_name }}...">
        <span class="inside-emoji-btn" id="emojiBtn"><i class="fa-regular fa-face-smile"></i></span>
        
        <label class="inside-file-btn" for="file-upload"><i class="fa-solid fa-paperclip"></i></label>
        <input type="file" id="file-upload" hidden 
          accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.zip,.rar">
        <span class="inside-send-btn" id="sendBtn"><i class="fa-solid fa-paper-plane"></i></span>

        <div id="emojiPicker">
          <span class="emoji">üòÄ</span><span class="emoji">üòÇ</span><span class="emoji">üòç</span>
          <span class="emoji">üòé</span><span class="emoji">üò¢</span><span class="emoji">üëç</span>
          <span class="emoji">üéâ</span><span class="emoji">‚ù§Ô∏è</span><span class="emoji">üôå</span>
          <span class="emoji">ü§î</span><span class="emoji">üëè</span>
          <span class="emoji">üò°</span><span class="emoji">ü•≥</span><span class="emoji">ü§©</span>
          <span class="emoji">üò¥</span><span class="emoji">üòá</span><span class="emoji">üíî</span>
        </div>
      </div>
    </div>
  </div>

</main>

<script>
const pictureUrl = "{{ user.profile.picture.url }}";
const user = "{{ user }}";
const channel_id = "{{ channel.channel_id }}";

const fileInput = document.getElementById('file-upload'); 
const message = document.getElementById('message');
const sendBtn = document.getElementById('sendBtn');
const messageOutput = document.getElementById('messageOutput');
const anchor = document.getElementById('scroll-anchor');

const emojiBtn = document.getElementById('emojiBtn');
const emojiPicker = document.getElementById('emojiPicker');

let currentPlayingMedia = null; // Stores reference to the current playing <audio> or <video> element

// Browser compatibility check
function isSafari() {
    return /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
}

function isIOS() {
    return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
}

// Debug logging
console.log('Production Debug Info:');
console.log('Protocol:', window.location.protocol);
console.log('Host:', window.location.host);
console.log('User:', user);
console.log('Picture URL:', pictureUrl);

/* --- UTILITY FUNCTIONS --- */

function formatTime(seconds) {
    if (isNaN(seconds) || seconds < 0) return '0:00';
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = Math.floor(seconds % 60);
    return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
}

function updateMediaControls(mediaElement, progressDiv, timeSpan, icon) {
    mediaElement.ontimeupdate = () => {
        const progress = (mediaElement.currentTime / mediaElement.duration) * 100;
        progressDiv.style.width = `${progress}%`;
        timeSpan.textContent = formatTime(mediaElement.currentTime);
    };
    mediaElement.onended = () => {
        icon.classList.replace('fa-pause', 'fa-play');
        icon.style.marginLeft = '2px';
        mediaElement.currentTime = 0;
        progressDiv.style.width = '0%';
        timeSpan.textContent = formatTime(mediaElement.duration);
        currentPlayingMedia = null;
    };
}

function handleMediaPlayback(mediaElement, button) {
    const messageId = mediaElement.id.split('-').pop();
    const progressDiv = document.getElementById(`progress-${messageId}`);
    const timeSpan = document.getElementById(`time-${messageId}`);
    const icon = button.querySelector('i');

    if (!mediaElement) return;

    // Stop and reset any currently playing media before starting a new one
    if (currentPlayingMedia && currentPlayingMedia !== mediaElement) {
        currentPlayingMedia.pause();
        currentPlayingMedia.currentTime = 0;
        const oldMessageId = currentPlayingMedia.id.split('-').pop();
        const oldButton = document.querySelector(`[data-msg-id='${oldMessageId}'] .player-play-btn`);
        if (oldButton) {
            const oldIcon = oldButton.querySelector('i');
            oldIcon.classList.replace('fa-pause', 'fa-play');
            oldIcon.style.marginLeft = '2px';
            document.getElementById(`progress-${oldMessageId}`).style.width = '0%';
            
            // If it was a video, pause the display element too
            const oldVideoDisplay = document.getElementById(`video-display-${oldMessageId}`);
            if (oldVideoDisplay) oldVideoDisplay.pause();

            currentPlayingMedia = null;
        }
    }

    if (mediaElement.paused || mediaElement.ended) {
        // Start playback
        mediaElement.play().then(() => {
            icon.classList.replace('fa-play', 'fa-pause');
            icon.style.marginLeft = '0'; 
            currentPlayingMedia = mediaElement;

            mediaElement.onloadedmetadata = () => { 
                if (timeSpan.textContent === '0:00') {
                     timeSpan.textContent = formatTime(mediaElement.duration); 
                }
            };
            updateMediaControls(mediaElement, progressDiv, timeSpan, icon);
        }).catch(error => {
            console.log("Playback failed:", error);
            // Handle autoplay restrictions
            if (error.name === 'NotAllowedError') {
                alert('Click the play button to start audio/video playback');
            }
        });

    } else {
        // Pause playback
        mediaElement.pause();
        icon.classList.replace('fa-pause', 'fa-play');
        icon.style.marginLeft = '2px';
        currentPlayingMedia = null;
    }
}

function seekMedia(event, mediaElement) {
    const progressBar = event.currentTarget;
    const rect = progressBar.getBoundingClientRect();
    const clickX = event.clientX - rect.left;
    const percentage = clickX / rect.width;
    
    if (mediaElement && !isNaN(mediaElement.duration)) {
        mediaElement.currentTime = mediaElement.duration * percentage;
    }
}

// Ensure HTTPS for Cloudinary URLs in production
function ensureSecureUrl(url) {
    if (!url) return url;
    
    // If in production and URL is HTTP, convert to HTTPS
    if (window.location.protocol === 'https:' && url.startsWith('http://')) {
        return url.replace('http://', 'https://');
    }
    
    // Specifically for Cloudinary
    if (url.includes('res.cloudinary.com') && url.startsWith('http://')) {
        return url.replace('http://', 'https://');
    }
    
    return url;
}

/* --- AUDIO / VIDEO SPECIFIC FUNCTIONS --- */

function toggleAudioPlayback(button, messageId) {
    const audio = document.getElementById(`audio-${messageId}`);
    
    // Handle Safari/IOS restrictions
    if ((isSafari() || isIOS()) && audio.paused) {
        // iOS/Safari requires user gesture to play audio
        const playPromise = audio.play();
        if (playPromise !== undefined) {
            playPromise.catch(error => {
                console.log("Autoplay prevented:", error);
                // Show play button that user must click
                button.innerHTML = '<i class="fa-solid fa-play"></i>';
                button.onclick = () => {
                    audio.play();
                    button.innerHTML = '<i class="fa-solid fa-pause"></i>';
                    button.onclick = () => toggleAudioPlayback(button, messageId);
                };
            });
        }
    } else {
        handleMediaPlayback(audio, button);
    }
}

function seekAudio(event, messageId) {
    const audio = document.getElementById(`audio-${messageId}`);
    seekMedia(event, audio);
}

function toggleVideoPlayback(button, messageId) {
    const video = document.getElementById(`video-${messageId}`);
    const videoDisplay = document.getElementById(`video-display-${messageId}`);
    
    // Handle Safari/IOS restrictions
    if ((isSafari() || isIOS()) && video.paused) {
        const playPromise = video.play();
        if (playPromise !== undefined) {
            playPromise.catch(error => {
                console.log("Video autoplay prevented:", error);
                videoDisplay.controls = true; // Show native controls on iOS
            });
        }
    }
    
    handleMediaPlayback(video, button);
    
    // Sync display
    if (video.paused) {
        videoDisplay.pause();
    } else {
        videoDisplay.play();
    }
}

function seekVideo(event, messageId) {
    const video = document.getElementById(`video-${messageId}`);
    const videoDisplay = document.getElementById(`video-display-${messageId}`);
    seekMedia(event, video);
    // Synchronize the display element's time
    videoDisplay.currentTime = video.currentTime;
}

function toggleMute(messageId) {
    const audio = document.getElementById(`audio-${messageId}`);
    const btn = document.querySelector(`[data-msg-id='${messageId}'] .player-volume-btn i`);
    
    if (audio.muted) {
        audio.muted = false;
        btn.classList.remove('fa-volume-xmark');
        btn.classList.add('fa-volume-high');
    } else {
        audio.muted = true;
        btn.classList.remove('fa-volume-high');
        btn.classList.add('fa-volume-xmark');
    }
}

// Add fullscreen for video
function toggleFullscreen(messageId) {
    const videoDisplay = document.getElementById(`video-display-${messageId}`);
    
    if (!document.fullscreenElement) {
        if (videoDisplay.requestFullscreen) {
            videoDisplay.requestFullscreen();
        } else if (videoDisplay.webkitRequestFullscreen) {
            videoDisplay.webkitRequestFullscreen();
        } else if (videoDisplay.mozRequestFullScreen) {
            videoDisplay.mozRequestFullScreen();
        }
    } else {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
        }
    }
}

/* --- CHAT FUNCTIONS --- */

emojiBtn.addEventListener('click', () => {
  emojiPicker.style.display = emojiPicker.style.display === 'none' ? 'block' : 'none';
});

emojiPicker.querySelectorAll('.emoji').forEach(emoji => {
  emoji.addEventListener('click', () => {
    message.value += emoji.textContent;
    message.focus();
    updateSendIconState();
  });
});

document.addEventListener('click', (e) => {
  if (!emojiPicker.contains(e.target) && !emojiBtn.contains(e.target)) emojiPicker.style.display = 'none';
});

function scrollToBottom() { anchor.scrollIntoView({ behavior: 'smooth' }); }

function renderEmojis(text) {
  const emojiRegex = /([\u231A-\u231B]|[\u23E9-\u23EC]|[\u23F0]|[\u23F3]|[\u25FD-\u25FE]|[\u2614-\u2615]|[\u2648-\u2653]|[\u267F]|[\u2693]|[\u26A1]|[\u26AA-\u26AB]|[\u26BD-\u26BE]|[\u26C4-\u26C5]|[\u26CE]|[\u26D4]|[\u26EA]|[\u26F2-\u26F3]|[\u26F5]|[\u26FA]|[\u26FD]|[\u2702]|[\u2705]|[\u2708-\u2709]|[\u270A-\u270B]|[\u2728]|[\u2733-\u2734]|[\u2744]|[\u2747]|[\u2753-\u2755]|[\u2757]|[\u2764]|[\u27A1]|[\u2B05-\u2B07]|[\u2B1B-\u2B1C]|[\u2B50]|[\u2B55]|[\u3030]|[\u303D]|[\u3297]|[\u3299]|[\uD83C-\uDBFF\uDC00-\uDFFF])/g;
  return text.replace(emojiRegex, '<span class="emoji-text">$1</span>');
}

function getFileType(fileName) {
    const name = fileName.toLowerCase();
    if (name.match(/\.(jpg|jpeg|png|gif|webp|bmp)$/)) return 'image';
    if (name.match(/\.(mp4|mov|avi|mkv|webm)$/)) return 'video';
    if (name.match(/\.(mp3|wav|ogg|m4a|flac)$/)) return 'audio';
    return 'document';
}

// Function to generate the appropriate HTML for the file type 
function renderFileHtml(fileUrl, fileType, fileName, messageId) {
  if (!fileUrl) return '';

  // Ensure secure URL
  const secureUrl = ensureSecureUrl(fileUrl);
  
  let mediaHtml = '';
  let fileIcon = '';
  let downloadLabel = 'Download File';

  if (fileType === 'image') {
    mediaHtml = `<img src="${secureUrl}" class="message-media" loading="lazy">`;
    fileIcon = 'fa-solid fa-file-image';
    downloadLabel = 'Download Image';
  } else if (fileType === 'video') {
    mediaHtml = `
      <video id="video-${messageId}" src="${secureUrl}" preload="metadata" crossorigin="anonymous"></video>
      <div class="custom-video-player" data-msg-id="${messageId}">
          <video id="video-display-${messageId}" 
                 src="${secureUrl}" 
                 class="message-media" 
                 preload="metadata"
                 playsinline
                 webkit-playsinline
                 crossorigin="anonymous"
                 oncontextmenu="return false;"></video>
          <div class="player-controls">
              <button class="player-play-btn" onclick="toggleVideoPlayback(this, '${messageId}')">
                  <i class="fa-solid fa-play"></i>
              </button>
              <div class="player-progress-bar" onclick="seekVideo(event, '${messageId}')">
                  <div id="progress-${messageId}" class="player-progress"></div>
              </div>
              <span id="time-${messageId}" class="player-time">0:00</span>
              <button class="player-fullscreen-btn" onclick="toggleFullscreen('${messageId}')">
                  <i class="fa-solid fa-expand"></i>
              </button>
          </div>
      </div>`;
    fileIcon = 'fa-solid fa-file-video';
    downloadLabel = 'Download Video';
  } else if (fileType === 'audio') {
    mediaHtml = `
      <audio id="audio-${messageId}" src="${secureUrl}" preload="metadata" crossorigin="anonymous"></audio>
      <div class="custom-audio-player" data-msg-id="${messageId}">
        <button class="player-play-btn" onclick="toggleAudioPlayback(this, '${messageId}')">
          <i class="fa-solid fa-play"></i>
        </button>
        <div class="player-progress-bar" onclick="seekAudio(event, '${messageId}')">
          <div id="progress-${messageId}" class="player-progress"></div>
        </div>
        <span id="time-${messageId}" class="player-time">0:00</span>
        <button class="player-volume-btn" onclick="toggleMute('${messageId}')">
          <i class="fa-solid fa-volume-high"></i>
        </button>
      </div>`;
    fileIcon = 'fa-solid fa-file-audio';
    downloadLabel = 'Download Audio';
  } else { 
    fileIcon = 'fa-solid fa-file';
    downloadLabel = 'Download File';
  }

  const downloadBlockHtml = `
    <div class="message-file-block">
      <i class="${fileIcon}"></i>
      <div class="message-file-details">
        <span class="file-name" title="${fileName}">${fileName}</span>
        <a href="${secureUrl}" class="file-download-btn" download="${fileName}">${downloadLabel}</a>
      </div>
    </div>`;

  return mediaHtml + downloadBlockHtml;
}


// WebSocket connection
function getWebSocketProtocol() {
    if (window.location.protocol === "https:") {
        return "wss://";
    } else {
        // Check if we're in production (non-localhost)
        if (window.location.hostname !== "localhost" && window.location.hostname !== "127.0.0.1") {
            return "wss://"; // Production should use wss
        }
        return "ws://";
    }
}

const protocol = getWebSocketProtocol();
const socket = new WebSocket(`${protocol}${location.host}/ws/${channel_id}/`);

// WebSocket event listeners
socket.addEventListener("open", () => {
    console.log("WebSocket connected successfully");
});

socket.addEventListener("error", (error) => {
    console.error("WebSocket error:", error);
});

socket.addEventListener("close", () => {
    console.log("WebSocket disconnected");
});

function sendLikeAction(btn) {
  socket.send(JSON.stringify({ action: "like_unlike", username: user, message_id: btn.getAttribute("data-msg-id") }));
}

function updateSendIconState() {
  if (message.value.trim() || fileInput.files.length > 0) sendBtn.classList.add('active');
  else sendBtn.classList.remove('active');
}

message.addEventListener('input', updateSendIconState);
fileInput.addEventListener('change', updateSendIconState);

socket.addEventListener("message", (e) => {
  console.log("WebSocket message received:", e.data);
  const data = JSON.parse(e.data);
  
  if (data.type === "Response") {
    console.log("New message data:", {
        message_id: data.message_id,
        file_url: data.file_url,
        file_type: data.file_type,
        file_name: data.file_name,
        has_file: !!data.file_url
    });
    
    const block = document.createElement("div");
    block.className = "chat-message";

    // Pass all necessary file data to the rendering function
    const fileHtml = renderFileHtml(data.file_url, data.file_type, data.file_name, data.message_id);

    block.innerHTML = `
      <div class="message-block" id="msg-${data.message_id}">
        <span class="message-author-name">
          <a href="/profile/${data.username}" style="text-decoration:none;color:#111;">${data.username}</a>
        </span>
        ${data.message ? `<div class="message-text">${renderEmojis(data.message)}</div>` : ""}
        ${fileHtml}
        <div class="time-and-reactions-wrapper">
          <span class="reaction-count" id="like-count-${data.message_id}">0</span>
          <button class="like-button" data-msg-id="${data.message_id}" onclick="sendLikeAction(this)">
            <i class="fa-regular fa-heart"></i>
          </button>
          <span class="msg-time">${data.time}</span>
        </div>
      </div>`;
    messageOutput.appendChild(block);
    scrollToBottom();

    // Initialize media duration if it was just added
    if (data.file_type === 'audio' || data.file_type === 'video') {
        const media = document.getElementById(`${data.file_type}-${data.message_id}`);
        const timeSpan = document.getElementById(`time-${data.message_id}`);
        if (media && timeSpan) {
            media.onloadedmetadata = () => { 
                console.log(`${data.file_type} metadata loaded:`, media.duration);
                timeSpan.textContent = formatTime(media.duration); 
            };
            media.onerror = (error) => {
                console.error(`${data.file_type} load error:`, error);
            };
        }
    }
  }
  if (data.type === "like_response") {
    document.getElementById(`like-count-${data.message_id}`).textContent = data.like_count;
    const btn = document.querySelector(`[data-msg-id='${data.message_id}']`);
    const icon = btn.querySelector("i");
    if (data.user_liked) { btn.classList.add("liked"); icon.classList.replace("fa-regular","fa-solid"); }
    else { btn.classList.remove("liked"); icon.classList.replace("fa-solid","fa-regular"); }
  }
});

sendBtn.addEventListener("click", () => {
  const text = message.value;
  const file = fileInput.files[0];
  if (!text.trim() && !file) return;
  sendBtn.classList.remove('active');

  if (file) {
    const reader = new FileReader();
    reader.onload = () => {
      // CRITICAL: Ensure the base64 data is properly formatted
      const base64Data = reader.result;
      console.log("DEBUG: Sending file:", file.name, "Size:", file.size, "Type:", file.type);
      
      socket.send(JSON.stringify({
        message: text,
        file: base64Data,       // Base64 file data with data: prefix
        file_name: file.name,   // Original file name
        username: user,
        pictureUrl: pictureUrl
      }));
    };
    reader.onerror = (error) => {
      console.error("FileReader error:", error);
      alert("Error reading file. Please try again.");
    };
    reader.readAsDataURL(file);  // This creates data: URL
  } else {
    // Send only text message
    socket.send(JSON.stringify({ 
        message: text, 
        file: null, 
        file_name: null, 
        username: user, 
        pictureUrl: pictureUrl 
    }));
  }

  message.value = '';
  fileInput.value = ''; 
});

document.addEventListener("DOMContentLoaded", () => setTimeout(scrollToBottom, 200));

// Test Cloudinary Directly
function testCloudinaryMedia() {
    // Test a known Cloudinary video URL
    const testVideo = document.createElement('video');
    testVideo.src = 'https://res.cloudinary.com/demo/video/upload/sample.mp4';
    testVideo.preload = 'metadata';
    
    testVideo.onloadedmetadata = () => {
        console.log('Test video metadata loaded:', testVideo.duration, 'seconds');
    };
    
    testVideo.onerror = (e) => {
        console.error('Test video error:', e);
    };
    
    // Test a known Cloudinary audio URL
    const testAudio = document.createElement('audio');
    testAudio.src = 'https://res.cloudinary.com/demo/video/upload/sample.mp3';
    testAudio.preload = 'metadata';
    
    testAudio.onloadedmetadata = () => {
        console.log('Test audio metadata loaded:', testAudio.duration, 'seconds');
    };
    
    testAudio.onerror = (e) => {
        console.error('Test audio error:', e);
    };
}

// Run the test on load
setTimeout(testCloudinaryMedia, 1000);
</script>
</body>
</html>