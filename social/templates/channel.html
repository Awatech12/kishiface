{% load humanize %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KishiFace - Channel</title>

  <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.7/dist/htmx.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <style>
:root {
  --primary: #666;
  --white: #fff;
  --msg-bg: #f2f2f2;
  --text-dark: #111;
  --text-light: #777;
  --love-liked: #666;
  --love-unliked: #fff;
}

body {
  font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  margin: 0;
  background: var(--white);
  color: var(--text-dark);
}

main.container {
  max-width: 768px;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}

/* HEADER */
.channel-header {
  display: flex;
  align-items: center;
  padding: 12px 15px;
  border-bottom: 1px solid #ddd;
  background-color: white;
  color: var(--primary);
  position: sticky;
  top: 0;
  z-index: 20;
}
.header-icon i { font-size: 1.4rem; color: var(--primary); }
.channel-avatar img { width: 42px; height: 42px; border-radius: 50%; object-fit: cover; margin: 0 12px; }
.channel-name { font-size: 1rem; font-weight: 600; }
.channel-stats { font-size: 0.75rem; color: var(--primary); }

/* MESSAGE FEED */
.main-feed { flex: 1; overflow: hidden; }
#messageOutput {
  flex-grow: 1;
  overflow-y: auto;
  padding: 10px 12px;
  max-height: calc(100vh - 115px);
}

/* MESSAGE STRUCTURE */
.chat-message { width: 100%; display: flex; justify-content: center; margin: 6px 0; }
.message-block {
  max-width: 80%;
  background: var(--msg-bg);
  padding: 10px 14px;
  min-width:70%;
  min-height: auto;
  border-radius: 18px;
  position: relative;
}
.message-author-name { font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; display: block; text-align: left; }
.message-text { font-size: 0.95rem; line-height: 1.4; }
.message-text .emoji-text { font-size: 1.5rem; line-height: 1.2; }
.message-block img { width: 100%; max-height: 280px; border-radius: 10px; margin-top: 6px; }

.time-and-reactions-wrapper { margin-top: 6px; display: flex; align-items: center; gap: 10px; justify-content: flex-start; }
.msg-time { font-size: 0.7rem; color: var(--text-light); }
.like-button { border: none; background: none; cursor: pointer; font-size: 1rem; }
.like-button i { color: var(--love-unliked); transition: color 0.2s; }
.like-button.liked i { color: var(--love-liked); }
.reaction-count { font-size: 0.75rem; color: var(--text-light); }

/* DATE SEPARATOR */
.date-separator { text-align: center; margin: 10px 0; }
.date-separator i {
  background: #eee;
  padding: 5px 12px;
  border-radius: 12px;
  font-size: 0.7rem;
  color: var(--text-light);
}

/* INPUT BAR */
#chatInputWrapper {
  background: var(--white);
  border-top: 1px solid #ddd;
  padding: 10px 12px;
  position: sticky;
  bottom: 0;
  z-index: 30;
  display: flex;
  justify-content: center;
}
.inner-wrapper { width: 90%; display: flex; align-items: center; }

.input-box { flex: 1; position: relative; display: flex; align-items: center; }
#message {
  width: 100%;
  border-radius: 22px;
  border: 1px solid #ccc;
  padding: 10px 100px 10px 15px;
  font-size: 0.95rem;
}
#message:focus { outline: none; border-color: var(--primary); }

/* BUTTONS INSIDE INPUT */
.input-box .inside-emoji-btn,
.input-box .inside-image-btn,
.input-box .inside-send-btn {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  font-size: 1.35rem;
  cursor: pointer;
  color: var(--text-light);
}
.input-box .inside-send-btn { right: 12px; font-size: 1.25rem; color: #ccc; }
.input-box .inside-send-btn.active { color: var(--primary); }
.input-box .inside-emoji-btn { right: 50px; }
.input-box .inside-image-btn { right: 85px; }

/* EMOJI PICKER */
#emojiPicker {
  display: none;
  position: absolute;
  bottom: 45px;
  right: 0;
  background: white;
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 10px;
  max-width: 320px;
  max-height: 200px;
  overflow-y: auto;
  z-index: 50;
}
#emojiPicker .emoji { cursor: pointer; font-size: 1.3rem; margin: 3px; display: inline-block; }
#emojiPicker .emoji:hover { background: #eee; border-radius: 5px; }
  </style>
</head>

<body>
<main class="container">

  <!-- HEADER -->
  <div class="channel-header">
    <a href="{% url 'channel_create' %}" class="header-icon"><i class="fa-solid fa-arrow-left"></i></a>
    <div class="channel-avatar"><img src="{{ channel.image.url }}" alt="{{ channel.channel_name }}"></div>
    <div>
      <h2 class="channel-name">{{ channel.channel_name }}</h2>
      <div class="channel-stats">{{ channel.subscriber.count|intcomma }} followers</div>
    </div>
  </div>

  <!-- MESSAGE FEED -->
  <div class="main-feed">
    <div id="messageOutput">
      {% for date_label, msgs in grouped_messages.items %}
        <div class="date-separator"><i>{{ date_label }}</i></div>
        {% for message in msgs %}
        <div class="chat-message">
          <div class="message-block" id="msg-{{ message.channemessage_id }}">
            <span class="message-author-name">
              <a href="{% url 'profile' message.author %}" style="text-decoration:none;color:#111;">
                {{ message.author }}
              </a>
            </span>
            {% if message.message %}
              <div class="message-text">{{ message.message }}</div>
            {% endif %}
            {% if message.image %}
              <img src="{{ message.image.url }}">
            {% endif %}
            <div class="time-and-reactions-wrapper">
              <span class="reaction-count" id="like-count-{{ message.channemessage_id }}">{{ message.like.count }}</span>
              <button class="like-button {% if user in message.like.all %}liked{% endif %}" data-msg-id="{{ message.channemessage_id }}" onclick="sendLikeAction(this)">
                <i class="{% if user in message.like.all %}fa-solid{% else %}fa-regular{% endif %} fa-heart"></i>
              </button>
              <span class="msg-time">{{ message.chat_time }}</span>
            </div>
          </div>
        </div>
        {% endfor %}
      {% endfor %}
      <div id="scroll-anchor"></div>
    </div>
  </div>

  <!-- INPUT BAR -->
  <div id="chatInputWrapper">
    <div class="inner-wrapper">
      <div class="input-box">
        <input type="text" id="message" placeholder="Message {{ channel.channel_name }}...">
        <span class="inside-emoji-btn" id="emojiBtn"><i class="fa-regular fa-face-smile"></i></span>
        <label class="inside-image-btn" for="image"><i class="fa-regular fa-image"></i></label>
        <input type="file" id="image" hidden>
        <span class="inside-send-btn" id="sendBtn"><i class="fa-solid fa-paper-plane"></i></span>

        <!-- EMOJI PICKER -->
        <div id="emojiPicker">
          <span class="emoji">üòÄ</span><span class="emoji">üòÇ</span><span class="emoji">üòç</span>
          <span class="emoji">üòé</span><span class="emoji">üò¢</span><span class="emoji">üëç</span>
          <span class="emoji">üéâ</span><span class="emoji">‚ù§Ô∏è</span><span class="emoji">üôå</span>
          <span class="emoji">ü§î</span><span class="emoji">üëè</span>
          <span class="emoji">üò°</span><span class="emoji">ü•≥</span><span class="emoji">ü§©</span>
          <span class="emoji">üò¥</span><span class="emoji">üòá</span><span class="emoji">üíî</span>
        </div>
      </div>
    </div>
  </div>

</main>

<script>
const pictureUrl = "{{ user.profile.picture.url }}";
const user = "{{ user }}";
const channel_id = "{{ channel.channel_id }}";

const image = document.getElementById('image');
const message = document.getElementById('message');
const sendBtn = document.getElementById('sendBtn');
const messageOutput = document.getElementById('messageOutput');
const anchor = document.getElementById('scroll-anchor');

const emojiBtn = document.getElementById('emojiBtn');
const emojiPicker = document.getElementById('emojiPicker');

emojiBtn.addEventListener('click', () => {
  emojiPicker.style.display = emojiPicker.style.display === 'none' ? 'block' : 'none';
});

emojiPicker.querySelectorAll('.emoji').forEach(emoji => {
  emoji.addEventListener('click', () => {
    message.value += emoji.textContent;
    message.focus();
    updateSendIconState();
  });
});

document.addEventListener('click', (e) => {
  if (!emojiPicker.contains(e.target) && !emojiBtn.contains(e.target)) emojiPicker.style.display = 'none';
});

function scrollToBottom() { anchor.scrollIntoView({ behavior: 'smooth' }); }

function renderEmojis(text) {
  const emojiRegex = /([\u231A-\u231B]|[\u23E9-\u23EC]|[\u23F0]|[\u23F3]|[\u25FD-\u25FE]|[\u2614-\u2615]|[\u2648-\u2653]|[\u267F]|[\u2693]|[\u26A1]|[\u26AA-\u26AB]|[\u26BD-\u26BE]|[\u26C4-\u26C5]|[\u26CE]|[\u26D4]|[\u26EA]|[\u26F2-\u26F3]|[\u26F5]|[\u26FA]|[\u26FD]|[\u2702]|[\u2705]|[\u2708-\u2709]|[\u270A-\u270B]|[\u2728]|[\u2733-\u2734]|[\u2744]|[\u2747]|[\u2753-\u2755]|[\u2757]|[\u2764]|[\u27A1]|[\u2B05-\u2B07]|[\u2B1B-\u2B1C]|[\u2B50]|[\u2B55]|[\u3030]|[\u303D]|[\u3297]|[\u3299]|[\uD83C-\uDBFF\uDC00-\uDFFF])/g;
  return text.replace(emojiRegex, '<span class="emoji-text">$1</span>');
}

const protocol = location.protocol === "https:" ? "wss://" : "ws://";
const socket = new WebSocket(`${protocol}${location.host}/ws/${channel_id}/`);

function sendLikeAction(btn) {
  socket.send(JSON.stringify({ action: "like_unlike", username: user, message_id: btn.getAttribute("data-msg-id") }));
}

function updateSendIconState() {
  if (message.value.trim() || image.files.length > 0) sendBtn.classList.add('active');
  else sendBtn.classList.remove('active');
}

message.addEventListener('input', updateSendIconState);
image.addEventListener('change', updateSendIconState);

socket.addEventListener("message", (e) => {
  const data = JSON.parse(e.data);
  if (data.type === "Response") {
    const block = document.createElement("div");
    block.className = "chat-message";
    block.innerHTML = `
      <div class="message-block" id="msg-${data.message_id}">
        <span class="message-author-name">
          <a href="/profile/${data.username}" style="text-decoration:none;color:#111;">${data.username}</a>
        </span>
        ${data.message ? `<div class="message-text">${renderEmojis(data.message)}</div>` : ""}
        ${data.image ? `<img src="${data.image}">` : ""}
        <div class="time-and-reactions-wrapper">
          <span class="reaction-count" id="like-count-${data.message_id}">0</span>
          <button class="like-button" data-msg-id="${data.message_id}" onclick="sendLikeAction(this)">
            <i class="fa-regular fa-heart"></i>
          </button>
          <span class="msg-time">${data.time}</span>
        </div>
      </div>`;
    messageOutput.appendChild(block);
    scrollToBottom();
  }
  if (data.type === "like_response") {
    document.getElementById(`like-count-${data.message_id}`).textContent = data.like_count;
    const btn = document.querySelector(`[data-msg-id='${data.message_id}']`);
    const icon = btn.querySelector("i");
    if (data.user_liked) { btn.classList.add("liked"); icon.classList.replace("fa-regular","fa-solid"); }
    else { btn.classList.remove("liked"); icon.classList.replace("fa-solid","fa-regular"); }
  }
});

sendBtn.addEventListener("click", () => {
  const text = message.value;
  const file = image.files[0];
  if (!text && !file) return;
  sendBtn.classList.remove('active');

  if (file) {
    const reader = new FileReader();
    reader.onload = () => {
      socket.send(JSON.stringify({ message: text, image: reader.result, username: user, pictureUrl }));
    };
    reader.readAsDataURL(file);
  } else {
    socket.send(JSON.stringify({ message: text, image: null, username: user, pictureUrl }));
  }

  message.value = '';
  image.value = '';
});

document.addEventListener("DOMContentLoaded", () => setTimeout(scrollToBottom, 200));
</script>
</body>
</html>