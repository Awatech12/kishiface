<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
     <meta name='csrf-token' content="{{csrf_token}}" >
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <style>
        #formData{
            position: fixed;
            bottom: 0;
            margin-left: 0;
            margin-right: 0;
            z-index: 1000;
        }
    </style>
</head>
<body>
     {% for message in messages %}
    {{message}}
    {% endfor %}

    <h2>message</h2>
   
    <form id="formData">
        <input 
            type="file" 
            name="file_upload" 
            id="file_upload" 
            accept="image/*, video/*, audio/*, .pdf, .doc, .docx, .txt" hidden> <br>
        <input type="text" name="message" id="message">
        <button type="submit">Send</button> <label for="file_upload">File</label>
    </form>
    <div id="comments">
       {% for label, msgs in grouped_messages.items %}
            <div class="message-group-label">
                <span>{{ label }}</span>
            </div>
            {% for message in msgs %}
        {{message.author.username}} : {{message.message}} <br>
        {% if message.file_type == 'image' %}
        <img src="{{message.file.url}}" height="200" width="200" alt=""> <a href="{{message.file.url}}" target="_blank" download>
            Download
        </a><br>
        {% endif %}
        {% if message.file_type == 'video' %}
        <video src="{{message.file.url}}" height="200" width="200" controls>  </video> <a href="{{message.file.url}}" target="_blank" download>
            Download
        </a> <br>
        {% endif %}
        {% if message.file_type == 'audio' %}
        <audio src="{{message.file.url}}"  controls>  </audio> <a href="{{message.file.url}}" target="_blank" download>
            Download
        </a> <br>
        {% endif %}
        {{message.chat_time}} <br>
        <form action="{% url 'channelmessage_like' message.channelmessage_id %}" method="post">
            {% csrf_token %}
             <button type="submit">
             {% if request.user in message.like.all %}
           
                Unlike {% else %} Like
                 {% endif %}
            </button>
            {{message.like.count}}
        </form>
        <hr style="width: 50%" color="bisque;">
        {% empty %}
        <h3>No message Yet</h3>
        {% endfor %}
        {% endfor %}
    </div>
   
    <script>
        // ===== csrf token ====
    const getCSRFToken = ()=>{
        return document.cookie
        .split('; ')
        .map(cookie => cookie.split('='))
        .find(([key]) => key === 'csrftoken')?.[1];

    };
    const csrftoken = getCSRFToken();
    const form = document.getElementById('formData');
    const channel_id = '{{channel_id}}';
    form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const formData = new FormData(form);
        const response = await fetch(`/channel_message/${channel_id}/`, {
                method: 'POST',
                headers:{
                    'X-CSRFToken': csrftoken
                },
                body: formData
            });
            const data = await response.json();
                form.reset();
        })
    
    const protocol = window.location.protocol === 'https:' ? "wss://" : "ws://";
    const socket = new WebSocket(`${protocol}${window.location.host}/ws/${channel_id}/`);
    socket.addEventListener('message', function(e){
        const data = JSON.parse(e.data);
         const commentDiv = document.getElementById('comments');
         const notify = document.getElementById('notify');
            const p = document.createElement('p');
            console.log(data.author);
            if(data.file_type && data.file_url){
                if(data.file_type === 'image'){
                    p.innerHTML =`${data.author} : ${data.message} <br> ${data.time}
                    <img src='${data.file_url}' height='100px', width='100px'>`;
                }
                else if(data.file_type === 'video'){
                    p.innerHTML =`${data.author} : ${data.message} <br> ${data.time}
                    <video src='${data.file_url}' height='200px', width='200px' controls> your  </video>`;
                }
                 else if(data.file_type === 'audio'){
                    p.innerHTML =`${data.author} : ${data.message} <br> ${data.time}
                    <audio src='${data.file_url}' height='200px', width='200px' controls> your  </audio>`;
                }
            }else{
                p.innerHTML =`${data.author} : ${data.message} <br> ${data.time}
             `;
            }
            commentDiv.appendChild(p);
            notify.innerHTML = data.count;
            console.log(data.message_id);
        

    })

    
    </script>
</body>
</html>