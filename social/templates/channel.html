<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{{ channel.channel_name }} | KishiFace</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* ===== KISHIFACE INSTAGRAM STYLE ===== */
        :root {
            --kf-primary: #0095f6;
            --kf-bg: #ffffff;
            --kf-border: #dbdbdb;
            --kf-text: #262626;
            --kf-text-light: #8e8e8e;
            --kf-sent-bg: #0095f6;
            --kf-received-bg: #efefef;
            --kf-reply-bg: rgba(0, 0, 0, 0.05);
            --kf-danger: #ed4956;
        }

        * {
            margin: 0; padding: 0; box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body, html {
            background-color: var(--kf-bg);
            height: 100dvh; overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        .kishiface-container {
            display: flex; flex-direction: column; height: 100%; width: 100%; position: relative;
        }

        /* ===== HEADER ===== */
        .kishiface-header {
            padding: 8px 16px; background: var(--kf-bg); border-bottom: 1px solid var(--kf-border);
            display: flex; align-items: center; height: 60px; z-index: 100; flex-shrink: 0;
        }
        .kishiface-back-btn { background: none; border: none; color: var(--kf-text); font-size: 22px; cursor: pointer; padding: 8px; margin-right: 8px; }
        .kishiface-channel-info { display: flex; align-items: center; flex: 1; cursor: pointer; min-width: 0; }
        .kishiface-avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; margin-right: 12px; flex-shrink: 0; }
        .kishiface-channel-details h3 { font-size: 16px; font-weight: 600; color: var(--kf-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .kishiface-channel-subscribers { font-size: 12px; color: var(--kf-text-light); }
        .kishiface-icon-btn { background: none; border: none; font-size: 20px; color: var(--kf-text); cursor: pointer; padding: 8px 4px; display: flex; align-items: center; }

        /* ===== MESSAGES ===== */
        .kishiface-messages-scroll { flex: 1; padding: 16px; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; }
        .kishiface-date-separator { text-align: center; margin: 20px 0 10px; }
        .kishiface-date-label { font-size: 12px; color: var(--kf-text-light); font-weight: 600; }
        .kishiface-msg-wrapper { display: flex; flex-direction: column; margin-bottom: 8px; max-width: 85%; }
        .kishiface-msg-wrapper.outgoing { align-self: flex-end; align-items: flex-end; }
        .kishiface-msg-wrapper.incoming { align-self: flex-start; align-items: flex-start; }
        .kishiface-sender-name { font-size: 11px; color: var(--kf-text-light); margin-bottom: 2px; margin-left: 12px; font-weight: 600; text-decoration: none; }
        
        .kishiface-message-bubble { padding: 10px 14px; border-radius: 22px; font-size: 14px; line-height: 1.4; position: relative; word-wrap: break-word; cursor: pointer; transition: transform 0.1s; }
        .kishiface-message-bubble.outgoing { background: var(--kf-sent-bg); color: #ffffff; }
        .kishiface-message-bubble.incoming { background: var(--kf-received-bg); color: var(--kf-text); }

        /* READ MORE STYLES */
        .read-more-btn { background: none; border: none; color: inherit; font-size: 13px; cursor: pointer; font-weight: 700; opacity: 0.8; margin-left: 4px; }
        .content-truncated { display: none; }

        /* REPLIES & MEDIA */
        .reply-indicator { background: var(--kf-reply-bg); border-left: 3px solid var(--kf-primary); padding: 6px 10px; border-radius: 8px; margin-bottom: 8px; font-size: 12px; display: block; }
        .outgoing .reply-indicator { background: rgba(255, 255, 255, 0.2); border-left-color: #ffffff; color: #ffffff; }
        .kishiface-media-content { border-radius: 18px; overflow: hidden; margin-bottom: 4px; }
        .kishiface-media-content img, .kishiface-media-content video { width: 100%; max-width: 280px; display: block; border-radius: 18px; }
        
        /* AUDIO PLAYER */
        .kishiface-audio-player { display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 22px; min-width: 200px; }
        .kishiface-audio-play-btn { width: 32px; height: 32px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; background: rgba(0,0,0,0.1); flex-shrink: 0; }
        .outgoing .kishiface-audio-play-btn { background: rgba(255,255,255,0.2); color: white; }
        .kishiface-audio-waveform { flex: 1; height: 24px; display: flex; align-items: center; gap: 2px; overflow: hidden; }
        .kishiface-wave-bar { width: 2px; background: rgba(0,0,0,0.15); border-radius: 1px; }
        .kishiface-wave-bar.active { background: var(--kf-text); }
        .outgoing .kishiface-wave-bar.active { background: #ffffff; }

        /* INPUT AREA */
        .kishiface-input-container { padding: 8px 12px; background: var(--kf-bg); border-top: 1px solid var(--kf-border); width: 100%; flex-shrink: 0; }
        .kishiface-input-wrapper { display: flex; align-items: flex-end; gap: 8px; background: var(--kf-bg); border: 1px solid var(--kf-border); border-radius: 24px; padding: 6px 12px; }
        .kishiface-message-input { flex: 1; border: none; outline: none; font-size: 15px; max-height: 120px; padding: 8px 0; resize: none; background: transparent; }
        .recording-status { display: none; flex: 1; align-items: center; gap: 12px; color: #ed4956; font-weight: 600; font-size: 14px; padding: 8px 0; }
        .recording-pulse { animation: pulse 1.5s infinite; color: #ed4956 !important; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .kishiface-send-btn { color: var(--kf-primary); font-weight: 700; background: none; border: none; cursor: pointer; font-size: 15px; padding: 8px 4px; display: none; }
        .broadcast-notice { text-align: center; color: var(--kf-text-light); font-size: 13px; padding: 10px; font-weight: 500; }

        /* MODALS (INSTAGRAM STYLE) */
        .kf-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; justify-content: center; align-items: center; padding: 20px; }
        .kf-modal { background: #fff; width: 100%; max-width: 400px; border-radius: 15px; overflow: hidden; animation: modalPop 0.2s ease-out; max-height: 85vh; display: flex; flex-direction: column; }
        @keyframes modalPop { from { transform: scale(1.1); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .kf-modal-header { padding: 14px; border-bottom: 1px solid var(--kf-border); text-align: center; font-weight: 600; position: relative; }
        .kf-modal-close { position: absolute; right: 15px; top: 14px; color: var(--kf-primary); cursor: pointer; font-size: 14px; font-weight: 600; border: none; background: none; outline: none; }
        .kf-modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        .kf-info-profile-section { display: flex; flex-direction: column; align-items: center; margin-bottom: 25px; }
        .kf-large-avatar { width: 90px; height: 90px; border-radius: 50%; object-fit: cover; margin-bottom: 15px; border: 1px solid var(--kf-border); }
        .kf-info-name { font-size: 18px; font-weight: 700; color: var(--kf-text); margin-bottom: 4px; }
        .kf-info-subs { font-size: 13px; color: var(--kf-text-light); margin-bottom: 10px; }

        .member-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #fafafa; }
        .member-avatar { width: 44px; height: 44px; border-radius: 50%; object-fit: cover; margin-right: 12px; }
        .member-info { flex: 1; min-width: 0; }
        .member-name { font-size: 14px; font-weight: 600; color: var(--kf-text); text-decoration: none; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .member-action-btn { background: none; border: 1px solid var(--kf-border); padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; margin-left: 5px; }
        .member-action-btn.danger { color: var(--kf-danger); border-color: var(--kf-danger); }
        .admin-badge { font-size: 10px; background: #e0f1ff; color: var(--kf-primary); padding: 2px 6px; border-radius: 4px; margin-left: 5px; font-weight: bold; }

        .kf-form-group { margin-bottom: 15px; }
        .kf-form-group label { display: block; font-size: 11px; color: var(--kf-text-light); font-weight: 700; text-transform: uppercase; margin-bottom: 6px; letter-spacing: 0.5px; }
        .kf-form-input { width: 100%; padding: 10px; border: 1px solid var(--kf-border); border-radius: 8px; font-size: 14px; outline: none; }
        .kf-submit-btn { width: 100%; background: var(--kf-primary); color: white; padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 10px; }

        /* CONTEXT MENU */
        .kf-context-menu { position: fixed; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 3000; display: none; min-width: 160px; overflow: hidden; border: 1px solid var(--kf-border); }
        .kf-context-item { padding: 12px 16px; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: var(--kf-text); }
        .kf-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2999; display: none; }
        
        .reply-preview-container { display: none; background: #f8f9fa; border-top: 1px solid var(--kf-border); padding: 10px 16px; border-left: 4px solid var(--kf-primary); position: relative; }
        .highlight-flash { animation: flash-animation 2s ease; }
        @keyframes flash-animation { 0% { background-color: #e3f2fd; } 100% { background-color: transparent; } }
    </style>
</head>
<body>

<div class="kishiface-container">
    <header class="kishiface-header">
        <button class="kishiface-back-btn" onclick="window.history.back()"><i class="fas fa-chevron-left"></i></button>
        <div class="kishiface-channel-info" onclick="openModal('infoModal')">
            <img src="{{ channel.image.url }}" class="kishiface-avatar">
            <div class="kishiface-channel-details">
                <h3>{{ channel.channel_name }}</h3>
                <div class="kishiface-channel-subscribers">{{ channel.subscriber.count }} members</div>
            </div>
        </div>
        <button class="kishiface-icon-btn" onclick="openModal('membersModal')"><i class="fas fa-info-circle"></i></button>
    </header>

    <main class="kishiface-messages-scroll" id="messagesList">
        {% for label, msgs in grouped_messages.items %}
            <div class="kishiface-date-separator"><span class="kishiface-date-label">{{ label }}</span></div>
            {% for message in msgs %}
                <div id="msg-{{ message.channelmessage_id }}" class="kishiface-msg-wrapper {% if message.author == request.user %}outgoing{% else %}incoming{% endif %}" data-message-id="{{ message.channelmessage_id }}">
                    {% if message.author != request.user %}<a href="{% url 'profile' message.author.username %}" class="kishiface-sender-name">{{ message.author.username }}</a>{% endif %}
                    <div class="kishiface-message-bubble {% if message.author == request.user %}outgoing{% else %}incoming{% endif %}" 
                         oncontextmenu="handleContextMenu(event, '{{ message.channelmessage_id }}', '{% if is_admin or message.author == request.user %}true{% else %}false{% endif %}')" 
                         ondblclick="initiateReply('{{ message.channelmessage_id }}')">
                        
                        {% if message.reply_to %}<div class="reply-indicator" onclick="scrollToMessage('{{ message.reply_to.channelmessage_id }}')"><span class="reply-author">{{ message.reply_to.author.username }}</span><span class="reply-text">{{ message.reply_to.message|truncatechars:30 }}</span></div>{% endif %}
                        
                        {% if message.file %}
                            <div class="kishiface-media-content">
                                {% if message.file_type == 'image' %}<img src="{{ message.file.url }}">
                                {% elif message.file_type == 'video' %}<video src="{{ message.file.url }}" controls></video>
                                {% elif message.file_type == 'audio' %}
                                    <div class="kishiface-audio-player">
                                        <button class="kishiface-audio-play-btn" onclick="toggleAudioPlay('{{ message.channelmessage_id }}')"><i class="fas fa-play" id="audio-play-icon-{{ message.channelmessage_id }}"></i></button>
                                        <div class="kishiface-audio-waveform" id="waveform-{{ message.channelmessage_id }}"></div>
                                        <audio id="audio-player-{{ message.channelmessage_id }}" src="{{ message.file.url }}" ontimeupdate="updateAudioProgress('{{ message.channelmessage_id }}')" onended="resetAudioIcon('{{ message.channelmessage_id }}')"></audio>
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                        
                        {% if message.message %}<div class="message-text-container"><span class="text-content">{{ message.message }}</span></div>{% endif %}
                        
                        <div style="font-size: 10px; opacity: 0.7; text-align: right; margin-top: 4px;">{{ message.chat_time }}</div>
                    </div>
                </div>
            {% endfor %}
        {% endfor %}
    </main>

    <!-- Reply Preview -->
    <div id="replyPreview" class="reply-preview-container">
        <div style="position: absolute; right: 16px; top: 12px; cursor: pointer; color: var(--kf-text-light);" onclick="cancelReply()"><i class="fas fa-times"></i></div>
        <div id="replyAuthor" style="font-size: 13px; font-weight: 700; color: var(--kf-primary);">Author</div>
        <div id="replyText" style="font-size: 12px; color: var(--kf-text-light); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Message...</div>
    </div>

    <div class="kishiface-input-container">
        {% if not channel.is_broadcast_only or is_admin %}
        <div class="kishiface-input-wrapper">
            <button class="kishiface-icon-btn" id="attachBtn" onclick="document.getElementById('fileInput').click()"><i class="fas fa-paperclip"></i></button>
            <textarea class="kishiface-message-input" id="messageInput" placeholder="Message..." rows="1"></textarea>
            <div id="recordingStatus" class="recording-status"><i class="fas fa-microphone recording-pulse"></i><span id="recordingTimer">0:00</span></div>
            <button class="kishiface-send-btn" id="sendButton" onclick="sendMessage()">Send</button>
            <button class="kishiface-icon-btn" id="micButton" onmousedown="startRecording(event)" onmouseup="stopRecording()" ontouchstart="startRecording(event)" ontouchend="stopRecording()"><i class="fas fa-microphone"></i></button>
            <input type="file" id="fileInput" hidden accept="image/*,video/*,audio/*">
        </div>
        {% else %}<div class="broadcast-notice">Only admins can send messages.</div>{% endif %}
    </div>
</div>

<!-- MODALS -->
<div class="kf-modal-overlay" id="infoModal" onclick="closeModal('infoModal')">
    <div class="kf-modal" onclick="event.stopPropagation()">
        <div class="kf-modal-header">Channel Details <button class="kf-modal-close" onclick="closeModal('infoModal')">Done</button></div>
        <div class="kf-modal-body">
            <div class="kf-info-profile-section">
                <img src="{{ channel.image.url }}" class="kf-large-avatar">
                <div class="kf-info-name">{{ channel.channel_name }}</div>
                <div class="kf-info-subs">{{ channel.subscriber.count }} Members</div>
            </div>
            {% if is_admin %}
            <form method="POST" action="{% url 'update_channel' channel.channel_id %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="kf-form-group"><label>Name</label><input type="text" name="name" class="kf-form-input" value="{{ channel.channel_name }}"></div>
                <div class="kf-form-group"><label>About</label><textarea name="about" class="kf-form-input" rows="3">{{ channel.about }}</textarea></div>
                <div class="kf-form-group"><label>Broadcast Mode</label>
                    <select name="broadcast" class="kf-form-input">
                        <option value="false" {% if not channel.is_broadcast_only %}selected{% endif %}>Public Chat</option>
                        <option value="true" {% if channel.is_broadcast_only %}selected{% endif %}>Broadcast Only</option>
                    </select>
                </div>
                <div class="kf-form-group"><label>Update Icon</label><input type="file" name="image" class="kf-form-input"></div>
                <button type="submit" class="kf-submit-btn">Save Changes</button>
            </form>
            {% else %}
            <div class="kf-form-group"><label>About</label><p style="font-size:14px; color:var(--kf-text);">{{ channel.about|default:"No description." }}</p></div>
            <div class="kf-form-group"><label>Admin</label><p style="font-size:14px; color:var(--kf-text);">@{{ channel.channel_owner.username }}</p></div>
            <button class="kf-submit-btn" style="background:var(--kf-danger);" onclick="alert('Unsubscribe clicked')">Unsubscribe</button>
            {% endif %}
        </div>
    </div>
</div>

<div class="kf-modal-overlay" id="membersModal" onclick="closeModal('membersModal')">
    <div class="kf-modal" onclick="event.stopPropagation()">
        <div class="kf-modal-header">Members <button class="kf-modal-close" onclick="closeModal('membersModal')">Close</button></div>
        <div class="kf-modal-body">
            <div class="member-item">
                <img src="{{ channel.channel_owner.profile.picture.url|default:'/media/male.png' }}" class="member-avatar">
                <div class="member-info"><b>{{ channel.channel_owner.username }}</b> <span class="admin-badge">Owner</span></div>
            </div>
            {% for sub in channel.subscriber.all %}
            {% if sub != channel.channel_owner %}
            <div class="member-item" id="member-{{ sub.id }}">
                <img src="{{ sub.profile.picture.url|default:'/media/male.png' }}" class="member-avatar">
                <div class="member-info">
                    <a href="{% url 'profile' sub.username %}" class="member-name">{{ sub.username }}</a>
                    {% if sub in channel.admins.all %}<span class="admin-badge">Admin</span>{% endif %}
                </div>
                {% if is_admin %}
                <div style="display:flex;">
                    {% if is_owner %}
                    <button class="member-action-btn" onclick="toggleAdmin('{{ sub.id }}')">{% if sub in channel.admins.all %}Demote{% else %}Admin{% endif %}</button>
                    {% endif %}
                    {% if is_owner or sub not in channel.admins.all %}
                    <button class="member-action-btn danger" onclick="manageMember('remove', '{{ sub.id }}')">Remove</button>
                    <button class="member-action-btn danger" onclick="manageMember('block', '{{ sub.id }}')">Block</button>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
</div>

<div class="kf-overlay" id="kfOverlay" onclick="hideContextMenu()"></div>
<div class="kf-context-menu" id="kfContextMenu">
    <div class="kf-context-item" id="ctxReply"><i class="fas fa-reply"></i> Reply</div>
    <div class="kf-context-item" id="ctxDelete" style="color:red; display:none;"><i class="fas fa-trash"></i> Delete</div>
</div>

<script>
    const csrftoken = '{{ csrf_token }}';
    const channelId = '{{ channel.channel_id }}';
    const currentUser = '{{ request.user.username }}';
    let replyToId = null;

    const messagesList = document.getElementById('messagesList');
    const messageInput = document.getElementById('messageInput');
    const fileInput = document.getElementById('fileInput');
    const micButton = document.getElementById('micButton');
    const sendButton = document.getElementById('sendButton');

    // --- READ MORE LOGIC ---
    function applyReadMore(el) {
        if (!el || el.querySelector('.read-more-btn')) return;
        const limit = 300, text = el.innerText;
        if (text.length <= limit) return;
        el.innerHTML = `<span class="content-visible">${text.substring(0, limit)}</span><span class="content-truncated">${text.substring(limit)}</span><button class="read-more-btn" onclick="toggleReadMore(this)">...read more</button>`;
    }

    function toggleReadMore(btn) {
        const truncated = btn.previousElementSibling;
        const isHidden = truncated.style.display === 'none' || truncated.style.display === '';
        truncated.style.display = isHidden ? 'inline' : 'none';
        btn.innerText = isHidden ? ' show less' : '...read more';
    }

    // --- INPUT UI LOGIC ---
    function updateInputVisibility() {
        const hasText = messageInput.value.trim().length > 0;
        const hasFile = fileInput.files.length > 0;
        const showSend = hasText || hasFile;
        sendButton.style.display = showSend ? 'block' : 'none';
        micButton.style.display = showSend ? 'none' : 'block';
    }

    if(messageInput){
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto'; this.style.height = this.scrollHeight + 'px';
            updateInputVisibility();
        });
    }
    if(fileInput) fileInput.addEventListener('change', updateInputVisibility);

    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    const scrollToBottom = () => { messagesList.scrollTop = messagesList.scrollHeight; };

    function scrollToMessage(id) {
        const target = document.querySelector(`[data-message-id="${id}"]`);
        if (target) {
            target.scrollIntoView({ behavior: 'smooth', block: 'center' });
            target.classList.add('highlight-flash');
            setTimeout(() => target.classList.remove('highlight-flash'), 2000);
        }
    }

    // --- ADMIN ACTIONS ---
    function toggleAdmin(uid) {
        fetch(`/channel/toggle-admin/${channelId}/${uid}/`, { method: 'POST', headers: {'X-CSRFToken': csrftoken} })
        .then(res => res.json()).then(data => { if(data.success) location.reload(); });
    }

    function manageMember(action, uid) {
        if(!confirm(`Confirm ${action}?`)) return;
        fetch(`/channel/manage-member/${channelId}/${uid}/`, { method: 'POST', headers: {'X-CSRFToken': csrftoken}, body: JSON.stringify({action}) })
        .then(res => res.json()).then(data => { if(data.success) document.getElementById(`member-${uid}`).remove(); });
    }

    function deleteMessage(mid) {
        if(!confirm("Delete this message?")) return;
        fetch(`/channel/delete-message/${channelId}/${mid}/`, { method: 'POST', headers: {'X-CSRFToken': csrftoken} });
    }

    // --- REPLIES ---
    function initiateReply(mid) {
        const wrap = document.querySelector(`[data-message-id="${mid}"]`);
        replyToId = mid;
        document.getElementById('replyAuthor').innerText = wrap.querySelector('.kishiface-sender-name')?.innerText || 'Member';
        document.getElementById('replyText').innerText = wrap.querySelector('.text-content')?.innerText || 'Media';
        document.getElementById('replyPreview').style.display = 'block';
        if(messageInput) messageInput.focus();
    }
    function cancelReply() { replyToId = null; document.getElementById('replyPreview').style.display = 'none'; }

    // --- CONTEXT MENU ---
    function handleContextMenu(e, mid, canDelete) {
        e.preventDefault();
        const menu = document.getElementById('kfContextMenu');
        menu.style.display = 'block'; menu.style.left = e.pageX + 'px'; menu.style.top = e.pageY + 'px';
        document.getElementById('kfOverlay').style.display = 'block';
        document.getElementById('ctxDelete').style.display = (canDelete === 'true') ? 'flex' : 'none';
        document.getElementById('ctxReply').onclick = () => { initiateReply(mid); hideContextMenu(); };
        document.getElementById('ctxDelete').onclick = () => { deleteMessage(mid); hideContextMenu(); };
    }
    function hideContextMenu() { document.getElementById('kfContextMenu').style.display = 'none'; document.getElementById('kfOverlay').style.display = 'none'; }

    // --- WEBSOCKET ---
    const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    const socket = new WebSocket(`${protocol}${window.location.host}/ws/${channelId}/`);
    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        if (data.type === 'new_message') appendNewMessage(data);
        else if (data.type === 'delete_broadcast') {
            const el = document.getElementById(`msg-${data.message_id}`);
            if(el) el.remove();
        }
    };

    function appendNewMessage(data) {
        const isOut = data.author === currentUser;
        const mid = data.message_id;
        const html = `
            <div id="msg-${mid}" class="kishiface-msg-wrapper ${isOut ? 'outgoing' : 'incoming'}" data-message-id="${mid}">
                ${!isOut ? `<a href="/${data.author}/" class="kishiface-sender-name">${data.author}</a>` : ''}
                <div class="kishiface-message-bubble ${isOut ? 'outgoing' : 'incoming'}" oncontextmenu="handleContextMenu(event, '${mid}', '${isOut || '{{ is_admin }}' === 'True' ? 'true' : 'false'}')" ondblclick="initiateReply('${mid}')">
                    ${data.reply_to ? `<div class="reply-indicator"><b>${data.reply_to.author}</b>: ${data.reply_to.message}</div>` : ''}
                    ${data.file_url ? `<div class="kishiface-media-content">
                        ${data.file_type === 'image' ? `<img src="${data.file_url}">` : ''}
                        ${data.file_type === 'audio' ? `<div class="kishiface-audio-player">
                            <button class="kishiface-audio-play-btn" onclick="toggleAudioPlay('${mid}')"><i class="fas fa-play" id="audio-play-icon-${mid}"></i></button>
                            <div class="kishiface-audio-waveform" id="waveform-${mid}"></div>
                            <audio id="audio-player-${mid}" src="${data.file_url}" ontimeupdate="updateAudioProgress('${mid}')" onended="resetAudioIcon('${mid}')"></audio>
                        </div>` : ''}
                    </div>` : ''}
                    ${data.message ? `<div class="message-text-container"><span class="text-content" id="text-${mid}">${data.message}</span></div>` : ''}
                    <div style="font-size: 10px; opacity: 0.7; text-align: right; margin-top: 4px;">${data.time}</div>
                </div>
            </div>`;
        messagesList.insertAdjacentHTML('beforeend', html);
        if(data.message) applyReadMore(document.getElementById(`text-${mid}`));
        if(data.file_type === 'audio') generateWaveform(document.getElementById(`waveform-${mid}`));
        scrollToBottom();
    }

    async function sendMessage() {
        const text = messageInput.value.trim();
        const file = fileInput.files[0];
        if(!text && !file) return;
        const fd = new FormData();
        fd.append('message', text); fd.append('channel_id', channelId);
        if(file) fd.append('file_upload', file);
        if(replyToId) fd.append('reply_to', replyToId);

        messageInput.value = ''; messageInput.style.height = 'auto'; fileInput.value = '';
        cancelReply(); updateInputVisibility();
        await fetch(`/channel_message/${channelId}/`, { method: 'POST', headers: {'X-CSRFToken': csrftoken}, body: fd });
    }

    // --- AUDIO SYSTEM ---
    function generateWaveform(c) {
        if(!c) return; c.innerHTML = '';
        for(let i=0; i<35; i++){ const b = document.createElement('div'); b.className = 'kishiface-wave-bar'; b.style.height = Math.random()*16+4+'px'; c.appendChild(b); }
    }
    function toggleAudioPlay(id) {
        const p = document.getElementById(`audio-player-${id}`), i = document.getElementById(`audio-play-icon-${id}`);
        if(p.paused) { p.play(); i.className = 'fas fa-pause'; } else { p.pause(); i.className = 'fas fa-play'; }
    }
    function updateAudioProgress(id) {
        const p = document.getElementById(`audio-player-${id}`), w = document.getElementById(`waveform-${id}`);
        if(!w) return;
        const bars = w.querySelectorAll('.kishiface-wave-bar'), prog = (p.currentTime/p.duration)*bars.length;
        bars.forEach((b, i) => b.classList.toggle('active', i < prog));
    }
    function resetAudioIcon(id) { document.getElementById(`audio-play-icon-${id}`).className = 'fas fa-play'; }

    let mediaRecorder, audioChunks = [];
    async function startRecording(e) {
        e.preventDefault();
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
            mediaRecorder.onstop = sendAudio;
            messageInput.style.display = 'none'; document.getElementById('attachBtn').style.display = 'none';
            document.getElementById('recordingStatus').style.display = 'flex';
            micButton.classList.add('recording-pulse');
            mediaRecorder.start();
        } catch (err) { console.error(err); }
    }
    function stopRecording() {
        if(mediaRecorder?.state !== 'inactive') mediaRecorder.stop();
        messageInput.style.display = 'block'; document.getElementById('attachBtn').style.display = 'block';
        document.getElementById('recordingStatus').style.display = 'none';
        micButton.classList.remove('recording-pulse');
        updateInputVisibility();
    }
    async function sendAudio() {
        if(audioChunks.length === 0) return;
        const blob = new Blob(audioChunks, { type: 'audio/webm' });
        const fd = new FormData(); fd.append('file_upload', blob, 'rec.webm');
        fd.append('channel_id', channelId); if(replyToId) fd.append('reply_to', replyToId);
        audioChunks = []; cancelReply();
        await fetch(`/channel_message/${channelId}/`, { method: 'POST', headers: {'X-CSRFToken': csrftoken}, body: fd });
    }

    window.onload = () => {
        document.querySelectorAll('.kishiface-audio-waveform').forEach(generateWaveform);
        document.querySelectorAll('.text-content').forEach(applyReadMore);
        messagesList.scrollTop = messagesList.scrollHeight;
    };
</script>
</body>
</html>