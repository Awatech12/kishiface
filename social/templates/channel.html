<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{{ channel.name }} | KishiFace</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* ===== KISHIFACE INSTAGRAM-DM STYLE FOR CHANNELS ===== */
        :root {
            --kf-primary: #0095f6;
            --kf-bg: #ffffff;
            --kf-border: #dbdbdb;
            --kf-text: #262626;
            --kf-text-light: #8e8e8e;
            --kf-sent-bg: #0095f6;
            --kf-received-bg: #efefef;
            --kf-input-bg: #ffffff;
            --kf-reply-bg: rgba(0, 0, 0, 0.05);
        }

        * {
            margin: 0; padding: 0; box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body, html {
            background-color: var(--kf-bg);
            height: 100dvh; overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        .kishiface-container {
            display: flex; flex-direction: column; height: 100%; width: 100%; position: relative;
        }

        /* ===== HEADER ===== */
        .kishiface-header {
            padding: 8px 16px; background: var(--kf-bg); border-bottom: 1px solid var(--kf-border);
            display: flex; align-items: center; height: 60px; z-index: 100; flex-shrink: 0;
        }

        .kishiface-back-btn { background: none; border: none; color: var(--kf-text); font-size: 22px; cursor: pointer; padding: 8px; margin-right: 8px; }
        .kishiface-channel-info { display: flex; align-items: center; flex: 1; cursor: pointer; min-width: 0; }
        .kishiface-avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; margin-right: 12px; flex-shrink: 0; }
        .kishiface-avatar-placeholder { width: 36px; height: 36px; border-radius: 50%; margin-right: 12px; background: var(--kf-primary); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 16px; flex-shrink: 0; }
        .kishiface-channel-details h3 { font-size: 16px; font-weight: 600; color: var(--kf-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .kishiface-channel-subscribers { font-size: 12px; color: var(--kf-text-light); }

        /* ===== MESSAGES CONTAINER ===== */
        .kishiface-messages-scroll {
            flex: 1; padding: 16px; overflow-y: auto; display: flex; flex-direction: column; gap: 4px;
        }

        .kishiface-date-separator { text-align: center; margin: 20px 0 10px; }
        .kishiface-date-label { font-size: 12px; color: var(--kf-text-light); font-weight: 600; }

        .kishiface-msg-wrapper { display: flex; flex-direction: column; margin-bottom: 8px; max-width: 85%; }
        .kishiface-msg-wrapper.outgoing { align-self: flex-end; align-items: flex-end; }
        .kishiface-msg-wrapper.incoming { align-self: flex-start; align-items: flex-start; }

        .kishiface-sender-name { font-size: 11px; color: var(--kf-text-light); margin-bottom: 2px; margin-left: 12px; font-weight: 600; }

        .kishiface-message-bubble {
            padding: 10px 14px; border-radius: 22px; font-size: 14px; line-height: 1.4;
            position: relative; word-wrap: break-word; cursor: pointer; transition: transform 0.1s;
        }
        .kishiface-message-bubble:active { transform: scale(0.98); }
        .kishiface-message-bubble.outgoing { background: var(--kf-sent-bg); color: #ffffff; }
        .kishiface-message-bubble.incoming { background: var(--kf-received-bg); color: var(--kf-text); }

        /* ===== WHATSAPP STYLE REPLY IN BUBBLE ===== */
        .reply-indicator {
            background: var(--kf-reply-bg); border-left: 3px solid var(--kf-primary);
            padding: 6px 10px; border-radius: 8px; margin-bottom: 8px; font-size: 12px; display: block;
        }
        .outgoing .reply-indicator { background: rgba(255, 255, 255, 0.2); border-left-color: #ffffff; color: #ffffff; }
        .reply-author { font-weight: 700; display: block; margin-bottom: 2px; }
        .reply-text { opacity: 0.9; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }

        /* ===== MEDIA & AUDIO ===== */
        .kishiface-media-content { border-radius: 18px; overflow: hidden; margin-bottom: 4px; }
        .kishiface-media-content img, .kishiface-media-content video { width: 100%; max-width: 280px; display: block; border-radius: 18px; }
        
        .kishiface-audio-player { display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 22px; min-width: 200px; }
        .kishiface-audio-play-btn { width: 32px; height: 32px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; background: rgba(0,0,0,0.1); flex-shrink: 0; }
        .outgoing .kishiface-audio-play-btn { background: rgba(255,255,255,0.2); color: white; }
        .kishiface-audio-waveform { flex: 1; height: 24px; display: flex; align-items: center; gap: 2px; overflow: hidden; }
        .kishiface-wave-bar { width: 2px; background: rgba(0,0,0,0.15); border-radius: 1px; }
        .outgoing .kishiface-wave-bar { background: rgba(255,255,255,0.3); }
        .kishiface-wave-bar.active { background: var(--kf-text); }
        .outgoing .kishiface-wave-bar.active { background: #ffffff; }

        /* ===== INPUT AREA & REPLY PREVIEW ===== */
        .reply-preview-container {
            display: none; background: #f8f9fa; border-top: 1px solid var(--kf-border);
            padding: 10px 16px; border-left: 4px solid var(--kf-primary); position: relative;
        }
        .reply-preview-author { font-size: 13px; font-weight: 700; color: var(--kf-primary); }
        .reply-preview-content { font-size: 12px; color: var(--kf-text-light); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .reply-preview-close { position: absolute; right: 16px; top: 12px; cursor: pointer; color: var(--kf-text-light); }

        .kishiface-input-container { padding: 8px 12px; background: var(--kf-bg); border-top: 1px solid var(--kf-border); width: 100%; flex-shrink: 0; }
        .kishiface-input-wrapper { display: flex; align-items: flex-end; gap: 8px; background: var(--kf-bg); border: 1px solid var(--kf-border); border-radius: 24px; padding: 6px 12px; }
        .kishiface-message-input { flex: 1; border: none; outline: none; font-size: 15px; max-height: 120px; padding: 8px 0; resize: none; background: transparent; }
        
        .recording-status { display: none; flex: 1; align-items: center; gap: 12px; color: #ed4956; font-weight: 600; font-size: 14px; padding: 8px 0; }
        .kishiface-send-btn { color: var(--kf-primary); font-weight: 600; background: none; border: none; cursor: pointer; font-size: 15px; padding: 8px 4px; }
        .kishiface-icon-btn { background: none; border: none; font-size: 20px; color: var(--kf-text); cursor: pointer; padding: 8px 4px; display: flex; align-items: center; }

        /* ===== CONTEXT MENU ===== */
        .kf-context-menu {
            position: fixed; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 2000; display: none; min-width: 160px; overflow: hidden; border: 1px solid var(--kf-border);
        }
        .kf-context-item { padding: 12px 16px; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: var(--kf-text); }
        .kf-context-item:hover { background: #f5f5f5; }
        .kf-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1999; display: none; }

        /* ===== MODALS & ANIMATIONS ===== */
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .recording-pulse { animation: pulse 1.5s infinite; color: #ed4956 !important; }
        .highlight-flash { animation: flash-animation 2s ease; }
        @keyframes flash-animation { 0% { background-color: #e3f2fd; } 100% { background-color: transparent; } }

        .kishiface-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .kishiface-modal.show { display: flex; }
        .kishiface-modal-content img { max-width: 95%; max-height: 85vh; border-radius: 8px; }
        
        .read-more-btn { background: none; border: none; color: var(--kf-text-light); font-size: 13px; cursor: pointer; font-weight: 600; }
        .content-truncated { display: none; }
    </style>
</head>
<body>

<div class="kishiface-container">
    <header class="kishiface-header">
        <button class="kishiface-back-btn" onclick="window.history.back()">
            <i class="fas fa-chevron-left"></i>
        </button>
        <div class="kishiface-channel-info">
            {% if channel.image %}<img src="{{ channel.image.url }}" class="kishiface-avatar">{% else %}
            <div class="kishiface-avatar-placeholder">{{ channel.name|slice:":1"|upper }}</div>{% endif %}
            <div class="kishiface-channel-details">
                <h3>{{ channel.name }}</h3>
                <div class="kishiface-channel-subscribers">{{ channel.subscriber.count }} members</div>
            </div>
        </div>
        <button class="kishiface-icon-btn"><i class="fas fa-info-circle"></i></button>
    </header>

    <main class="kishiface-messages-scroll" id="messagesList">
        {% for label, msgs in grouped_messages.items %}
            <div class="kishiface-date-separator"><span class="kishiface-date-label">{{ label }}</span></div>
            {% for message in msgs %}
                <div class="kishiface-msg-wrapper {% if message.author == request.user %}outgoing{% else %}incoming{% endif %}" data-message-id="{{ message.channelmessage_id }}">
                    {% if message.author != request.user %}
                        <span class="kishiface-sender-name">{{ message.author.username }}</span>
                    {% endif %}

                    <div class="kishiface-message-bubble {% if message.author == request.user %}outgoing{% else %}incoming{% endif %}"
                         oncontextmenu="handleContextMenu(event, '{{ message.channelmessage_id }}')"
                         ondblclick="initiateReply('{{ message.channelmessage_id }}')">
                        
                        {% if message.reply_to %}
                        <div class="reply-indicator" onclick="scrollToMessage('{{ message.reply_to.channelmessage_id }}')">
                            <span class="reply-author">{{ message.reply_to.author.username }}</span>
                            <span class="reply-text">{{ message.reply_to.message|truncatechars:50|default:"Media file" }}</span>
                        </div>
                        {% endif %}

                        {% if message.file %}
                            <div class="kishiface-media-content">
                                {% if message.file_type == 'image' %}<img src="{{ message.file.url }}" onclick="openMediaModal('{{ message.file.url }}')">
                                {% elif message.file_type == 'video' %}<video src="{{ message.file.url }}" controls onplay="stopOtherMedia(this)"></video>
                                {% elif message.file_type == 'audio' %}
                                    <div class="kishiface-audio-player">
                                        <button class="kishiface-audio-play-btn" onclick="toggleAudioPlay('{{ message.channelmessage_id }}')">
                                            <i class="fas fa-play" id="audio-play-icon-{{ message.channelmessage_id }}"></i>
                                        </button>
                                        <div class="kishiface-audio-waveform" id="waveform-{{ message.channelmessage_id }}"></div>
                                        <audio id="audio-player-{{ message.channelmessage_id }}" src="{{ message.file.url }}" onplay="stopOtherMedia(this)" ontimeupdate="updateAudioProgress('{{ message.channelmessage_id }}')" onended="resetAudioIcon('{{ message.channelmessage_id }}')"></audio>
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}

                        {% if message.message %}
                            <div class="message-text-container"><span class="text-content" id="text-{{ message.channelmessage_id }}">{{ message.message }}</span></div>
                        {% endif %}

                        <div style="font-size: 10px; opacity: 0.7; text-align: right; margin-top: 4px;">
                            {{ message.chat_time }}
                            {% if message.author == request.user %}<i class="fas fa-check-double" style="margin-left:3px;"></i>{% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% endfor %}
    </main>

    <!-- Reply Preview -->
    <div id="replyPreview" class="reply-preview-container">
        <div class="reply-preview-close" onclick="cancelReply()"><i class="fas fa-times"></i></div>
        <div class="reply-preview-author" id="replyAuthor">Author</div>
        <div class="reply-preview-content" id="replyText">Message...</div>
    </div>

    <div class="kishiface-input-container">
        <div class="kishiface-input-wrapper">
            <button class="kishiface-icon-btn" id="attachButton" onclick="document.getElementById('fileInput').click()"><i class="fas fa-paperclip"></i></button>
            <textarea class="kishiface-message-input" id="messageInput" placeholder="Message..." rows="1"></textarea>
            <div id="recordingStatus" class="recording-status"><i class="fas fa-microphone recording-pulse"></i><span id="recordingTimer">0:00</span></div>
            <button class="kishiface-send-btn" id="sendButton" onclick="sendMessage()" style="display: none;">Send</button>
            <button class="kishiface-icon-btn" id="micButton" onmousedown="startRecording(event)" onmouseup="stopRecording()" ontouchstart="startRecording(event)" ontouchend="stopRecording()"><i class="fas fa-microphone"></i></button>
            <input type="file" id="fileInput" hidden accept="image/*,video/*,audio/*">
        </div>
    </div>
</div>

<!-- Context Menu & Overlays -->
<div class="kf-overlay" id="kfOverlay" onclick="hideContextMenu()"></div>
<div class="kf-context-menu" id="kfContextMenu">
    <div class="kf-context-item" id="ctxReply"><i class="fas fa-reply"></i> Reply</div>
    <div class="kf-context-item" id="ctxCopy"><i class="fas fa-copy"></i> Copy Text</div>
</div>

<div class="kishiface-modal" id="mediaModal" onclick="closeMediaModal()"><div class="kishiface-modal-content"><img id="modalImage" src=""></div></div>

<script>
    const csrftoken = '{{ csrf_token }}';
    const channelId = '{{ channel.channel_id }}';
    const currentUser = '{{ request.user.username }}';
    let replyToId = null;
    let currentlyPlaying = null;

    const messageInput = document.getElementById('messageInput');
    const messagesList = document.getElementById('messagesList');
    const sendButton = document.getElementById('sendButton');
    const micButton = document.getElementById('micButton');
    const fileInput = document.getElementById('fileInput');

    // --- SCROLLING ---
    const scrollToBottom = () => { messagesList.scrollTop = messagesList.scrollHeight; };

    function scrollToMessage(id) {
        const target = document.querySelector(`[data-message-id="${id}"]`);
        if (target) {
            target.scrollIntoView({ behavior: 'smooth', block: 'center' });
            target.classList.add('highlight-flash');
            setTimeout(() => target.classList.remove('highlight-flash'), 2000);
        }
    }

    // --- INPUT & UI ---
    function updateInputVisibility() {
        const hasInput = messageInput.value.trim().length > 0 || fileInput.files.length > 0;
        sendButton.style.display = hasInput ? 'block' : 'none';
        micButton.style.display = hasInput ? 'none' : 'block';
    }

    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
        updateInputVisibility();
    });

    fileInput.addEventListener('change', updateInputVisibility);

    // --- REPLY & CONTEXT MENU ---
    function initiateReply(msgId) {
        const wrapper = document.querySelector(`[data-message-id="${msgId}"]`);
        const author = wrapper.querySelector('.kishiface-sender-name')?.innerText || 'You';
        const text = wrapper.querySelector('.text-content')?.innerText || 'Media file';
        replyToId = msgId;
        document.getElementById('replyAuthor').innerText = author;
        document.getElementById('replyText').innerText = text;
        document.getElementById('replyPreview').style.display = 'block';
        messageInput.focus();
    }

    function cancelReply() { replyToId = null; document.getElementById('replyPreview').style.display = 'none'; }

    function handleContextMenu(e, msgId) {
        e.preventDefault();
        const menu = document.getElementById('kfContextMenu');
        const overlay = document.getElementById('kfOverlay');
        menu.style.display = 'block';
        menu.style.left = Math.min(e.pageX, window.innerWidth - 170) + 'px';
        menu.style.top = Math.min(e.pageY, window.innerHeight - 120) + 'px';
        overlay.style.display = 'block';
        document.getElementById('ctxReply').onclick = () => { initiateReply(msgId); hideContextMenu(); };
        document.getElementById('ctxCopy').onclick = () => {
            const text = document.querySelector(`[data-message-id="${msgId}"] .text-content`)?.innerText;
            if (text) navigator.clipboard.writeText(text);
            hideContextMenu();
        };
    }

    function hideContextMenu() {
        document.getElementById('kfContextMenu').style.display = 'none';
        document.getElementById('kfOverlay').style.display = 'none';
    }

    // --- WEBSOCKET ---
    const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    const socket = new WebSocket(`${protocol}${window.location.host}/ws/${channelId}/`);

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        if (data.type === 'new_message') appendNewMessage(data);
    };

    function appendNewMessage(data) {
        const isOutgoing = data.author === currentUser;
        const msgId = data.message_id || Math.random().toString(36).substr(2, 9);
        
        const replyHtml = data.reply_to ? `
            <div class="reply-indicator" onclick="scrollToMessage('${data.reply_to.id}')">
                <span class="reply-author">${data.reply_to.author}</span>
                <span class="reply-text">${data.reply_to.message}</span>
            </div>` : '';

        const msgHtml = `
            <div class="kishiface-msg-wrapper ${isOutgoing ? 'outgoing' : 'incoming'}" data-message-id="${msgId}">
                ${!isOutgoing ? `<span class="kishiface-sender-name">${data.author}</span>` : ''}
                <div class="kishiface-message-bubble ${isOutgoing ? 'outgoing' : 'incoming'}" 
                     oncontextmenu="handleContextMenu(event, '${msgId}')" ondblclick="initiateReply('${msgId}')">
                    ${replyHtml}
                    ${data.file_url ? `
                        <div class="kishiface-media-content">
                            ${data.file_type === 'image' ? `<img src="${data.file_url}" onclick="openMediaModal('${data.file_url}')">` : ''}
                            ${data.file_type === 'video' ? `<video src="${data.file_url}" controls onplay="stopOtherMedia(this)"></video>` : ''}
                            ${data.file_type === 'audio' ? `
                                <div class="kishiface-audio-player">
                                    <button class="kishiface-audio-play-btn" onclick="toggleAudioPlay('${msgId}')"><i class="fas fa-play" id="audio-play-icon-${msgId}"></i></button>
                                    <div class="kishiface-audio-waveform" id="waveform-${msgId}"></div>
                                    <audio id="audio-player-${msgId}" src="${data.file_url}" onplay="stopOtherMedia(this)" ontimeupdate="updateAudioProgress('${msgId}')" onended="resetAudioIcon('${msgId}')"></audio>
                                </div>` : ''}
                        </div>` : ''}
                    ${data.message ? `<div class="message-text-container"><span class="text-content" id="text-${msgId}">${data.message}</span></div>` : ''}
                    <div style="font-size: 10px; opacity: 0.7; text-align: right; margin-top: 4px;">${data.time} ${isOutgoing ? '<i class="fas fa-check-double"></i>' : ''}</div>
                </div>
            </div>`;
        
        messagesList.insertAdjacentHTML('beforeend', msgHtml);
        if (data.message) applyReadMore(document.getElementById(`text-${msgId}`));
        if (data.file_type === 'audio') generateWaveform(document.getElementById(`waveform-${msgId}`));
        scrollToBottom();
    }

    // --- MESSAGING API ---
    async function sendMessage() {
        const message = messageInput.value.trim();
        const file = fileInput.files[0];
        if (!message && !file) return;

        const formData = new FormData();
        formData.append('message', message);
        formData.append('channel_id', channelId);
        if (file) formData.append('file_upload', file);
        if (replyToId) formData.append('reply_to', replyToId);

        messageInput.value = ''; messageInput.style.height = 'auto';
        fileInput.value = ''; cancelReply(); updateInputVisibility();

        await fetch(`/channel_message/${channelId}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrftoken },
            body: formData
        });
    }

    // --- AUDIO & RECORDING ---
    function generateWaveform(container) {
        if (!container) return;
        container.innerHTML = '';
        for(let i=0; i<35; i++) {
            const bar = document.createElement('div');
            bar.className = 'kishiface-wave-bar';
            bar.style.height = Math.random() * 16 + 4 + 'px';
            container.appendChild(bar);
        }
    }

    function toggleAudioPlay(id) {
        const player = document.getElementById(`audio-player-${id}`);
        const icon = document.getElementById(`audio-play-icon-${id}`);
        if (player.paused) { stopOtherMedia(player); player.play(); icon.className = 'fas fa-pause'; }
        else { player.pause(); icon.className = 'fas fa-play'; }
    }

    function updateAudioProgress(id) {
        const player = document.getElementById(`audio-player-${id}`);
        const waveform = document.getElementById(`waveform-${id}`);
        if (!player || !waveform) return;
        const bars = waveform.querySelectorAll('.kishiface-wave-bar');
        const progress = (player.currentTime / player.duration) * bars.length;
        bars.forEach((bar, index) => {
            if (index < progress) bar.classList.add('active');
            else bar.classList.remove('active');
        });
    }

    function resetAudioIcon(id) { document.getElementById(`audio-play-icon-${id}`).className = 'fas fa-play'; }
    function stopOtherMedia(currentMedia) {
        if (currentlyPlaying && currentlyPlaying !== currentMedia) {
            currentlyPlaying.pause();
            if (currentlyPlaying.id.startsWith('audio-player-')) resetAudioIcon(currentlyPlaying.id.replace('audio-player-', ''));
        }
        currentlyPlaying = currentMedia;
    }

    let mediaRecorder, audioChunks = [], recordInterval, seconds = 0;
    async function startRecording(e) {
        e.preventDefault();
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
            mediaRecorder.onstop = sendAudio;
            messageInput.style.display = 'none'; document.getElementById('attachButton').style.display = 'none';
            document.getElementById('recordingStatus').style.display = 'flex';
            micButton.classList.add('recording-pulse');
            seconds = 0;
            recordInterval = setInterval(() => {
                seconds++;
                const mins = Math.floor(seconds / 60), secs = seconds % 60;
                document.getElementById('recordingTimer').innerText = `${mins}:${secs.toString().padStart(2, '0')}`;
            }, 1000);
            mediaRecorder.start();
        } catch (err) { console.error("Mic access denied", err); }
    }

    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
        clearInterval(recordInterval);
        messageInput.style.display = 'block'; document.getElementById('attachButton').style.display = 'flex';
        document.getElementById('recordingStatus').style.display = 'none';
        micButton.classList.remove('recording-pulse');
    }

    async function sendAudio() {
        if (audioChunks.length === 0) return;
        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        const formData = new FormData();
        formData.append('file_upload', audioBlob, 'recording.webm');
        formData.append('channel_id', channelId);
        if (replyToId) formData.append('reply_to', replyToId);
        audioChunks = []; cancelReply();
        await fetch(`/channel_message/${channelId}/`, { method: 'POST', headers: { 'X-CSRFToken': csrftoken }, body: formData });
    }

    // --- UTILS ---
    function applyReadMore(el) {
        if (!el) return;
        const limit = 300, text = el.innerText;
        if (text.length <= limit) return;
        el.innerHTML = `<span class="content-visible">${text.substring(0, limit)}</span><span class="content-truncated">${text.substring(limit)}</span><button class="read-more-btn" onclick="toggleReadMore(this)">...read more</button>`;
    }

    function toggleReadMore(btn) {
        const truncated = btn.previousElementSibling;
        const isHidden = truncated.style.display === 'none' || truncated.style.display === '';
        truncated.style.display = isHidden ? 'inline' : 'none';
        btn.innerText = isHidden ? ' show less' : '...read more';
    }

    function openMediaModal(url) { document.getElementById('modalImage').src = url; document.getElementById('mediaModal').classList.add('show'); }
    function closeMediaModal() { document.getElementById('mediaModal').classList.remove('show'); }

    window.onload = () => {
        document.querySelectorAll('.text-content').forEach(applyReadMore);
        document.querySelectorAll('.kishiface-audio-waveform').forEach(generateWaveform);
        scrollToBottom();
    };
</script>

</body>
</html>