{% load humanize %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KishiFace - Home</title>
  <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.7/dist/htmx.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="stylesheet" href="{% static 'css/home.css' %}">
  <style>
    /* ========================= */
    /* GENERAL STYLES */
    /* ========================= */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f8f9fa;
    }

    main.container {
      display: flex;
      gap: 20px;
      padding: 0;
    }

    .desktop-only { display: block; }
    .mobile-only { display: none; }

    /* ========================= */
    /* LEFT SIDEBAR */
    /* ========================= */
    .left-sidebar {
      width: 220px;
    }

    .left-sidebar .card {
      background: #fff;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .sidebar-link {
      display: block;
      margin: 10px 0;
      color: #333;
      text-decoration: none;
    }

    .sidebar-link.logout {
      color: #e74c3c;
    }

    /* ========================= */
    /* RIGHT SIDEBAR */
    /* ========================= */
    .right-sidebar {
      width: 260px;
    }

    .desktop-member-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .desktop-member-item img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }

    .btn-follow {
      background: #0095f6;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 4px 10px;
      cursor: pointer;
    }

    /* ========================= */
    /* MAIN FEED */
    /* ========================= */
    .main-feed {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    /* ========================= */
    /* CHANNEL HEADER */
    /* ========================= */
    .channel-header {
        display: flex;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid #ddd;
        background: #fff;
        position: sticky;
        top: 0;
        z-index: 100;
    }

    .channel-avatar img {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #ddd;
        margin-right: 20px;
    }

    .channel-info {
        display: flex;
        flex-direction: column;
    }

    .channel-name-row {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 8px;
    }

    .channel-name {
        font-size: 24px;
        font-weight: 600;
        margin: 0;
    }

    .btn-subscribe {
        background-color: #0095f6;
        color: white;
        padding: 6px 16px;
        border: none;
        border-radius: 4px;
        font-weight: bold;
        cursor: pointer;
    }

    .btn-subscribe:hover {
        background-color: #007bb5;
    }

    .channel-stats {
        display: flex;
        gap: 20px;
        font-size: 14px;
        color: #555;
        margin-bottom: 4px;
    }

    .channel-id {
        font-size: 14px;
        color: #888;
    }

    /* ========================= */
    /* CHAT SECTION */
    /* ========================= */

    .chat-message {
      display: flex;
      margin: 10px 0;
      width: 100%;
    }

    .chat-left { justify-content: flex-start; }
    .chat-right { justify-content: flex-end; }

    .chat-right .avatar { display: none; }

    .avatar {
      width: 25px;
      height: 25px;
      border-radius: 50%;
      margin-right: 8px;
      object-fit: cover;
    }

    .bubble {
      max-width: 70%;
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 14px;
      line-height: 1.0;
      position: relative;
    }

    .bubble-left {
      background: #ffffff;
      border: 1px solid #eee;
      border-top-left-radius: 1px;
    }

    .bubble-right {
      background: #dcf8c6;
      border-top-right-radius: 1px;
    }

    .message-text { margin-top: 5px; white-space: pre-wrap; }

    .bubble img {
      width: 200px;
      border-radius: 12px;
      margin-top: 8px;
    }

    .msg-time {
      font-size: 11px;
      color: #777;
      margin-top: 4px;
      text-align: right;
    }

    /* ========================= */
    /* MESSAGE INPUT */
    /* ========================= */
    #chatInputWrapper {
      position: sticky;
      bottom: 0;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 0;
      background: #fff;
      border-top: 1px solid #ddd;
      z-index: 120;
    }

    #message {
      flex: 1;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid #ccc;
    }

    #sendBtn {
      padding: 10px 15px;
      border: none;
      background: #25d366;
      border-radius: 10px;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }

    .file-label {
      font-size: 24px;
      color: #555;
      cursor: pointer;
    }

    #image { display: none; }

    /* ========================= */
    /* RESPONSIVE */
    /* ========================= */
    @media (max-width: 768px) {
      .desktop-only { display: none; }
      .mobile-only { display: block; }
      main.container { flex-direction: column; }

      .channel-stats, .btn-subscribe, .channel-id{
        display: none;
      }

      .channel-avatar img{
        width: 45px;
        height: 45px;
      }
      .channel-name{
        font-size: 20px;
      }
      .channel-header{
        padding: 10px;
        gap: 10px;
      }
    }
  </style>
</head>
<body></body>

<main class="container">

    <!-- LEFT SIDEBAR -->
    <div class="left-sidebar desktop-only">
        <div class="card">
            <div class="sidebar-content">
                <h4 class="sidebar-title">My Account</h4>
                <a href="{% url 'profile' request.user.username %}" class="sidebar-link">
                    <i class="fa-solid fa-user-circle"></i> Profile
                </a>
                <a href="" class="sidebar-link">
                    <i class="fa-solid fa-cog"></i> Settings
                </a>
                <a href="{% url 'channel_create' %}" class="sidebar-link">
                    <i class="fa-solid fa-cog"></i> Channels
                </a>
                <a href="{% url 'post' %}" class="sidebar-link">
                  <i><svg fill="none" stroke="currentColor" height="20" width="20" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10" stroke-width="2"/>
                    <line x1="12" y1="8" x2="12" y2="16" stroke-width="2"/>
                    <line x1="8" y1="12" x2="16" y2="12" stroke-width="2"/>
                  </svg></i> Post
                </a>
                <hr class="sidebar-divider">
                <a href="{% url 'logout' %}" class="sidebar-link logout">
                    <i class="fa-solid fa-right-from-bracket"></i> Logout
                </a>
            </div>
        </div>
    </div>

    <!-- MAIN FEED -->
    <div class="main-feed">

        <!-- CHANNEL HEADER -->
        <div class="channel-header">
          <a href="{% url 'channel_create' %}" class="header-icon"><i class="fa-solid fa-arrow-left"></i></a> <br>
            <div class="channel-avatar">
                <img src="{{ channel.image.url }}" alt="{{ channel.channel_name }}">
            </div>
            <div class="channel-info">
                <div class="channel-name-row">
                    <h2 class="channel-name">{{ channel.channel_name }}</h2>
                    <button class="btn-subscribe">Subscribe</button>
                </div>
                <div class="channel-stats">
                    <span><strong>{{ messages.count }}</strong> Posts</span>
                    <span><strong>{{ channel.subscriber.count }}</strong> Subscribers</span>
                </div>
                <div class="channel-id">@{{ channel.channel_id }}</div>
            </div>
        </div>

        <!-- CHAT MESSAGES -->
        <div id="messageOutput">
          {% for label, msgs in grouped_messages.items %}
            <center><b><i>{{label}}</i></b></center>
            {% for message in msgs %}
            <div class="chat-message {% if message.author == user %}chat-right{% else %}chat-left{% endif %}">
                {% if message.author != user %}
                <img src="{{ message.pictureUrl }}" class="avatar">
                {% endif %}
                <div class="bubble {% if message.author == user %}bubble-right{% else %}bubble-left{% endif %}">
                   {% if message.author != user %}
                    <a  style="text-decoration: none; color: #333;" href="{% url 'profile' message.author %}"><strong>{{ message.author }}</strong></a>
                    {% endif %}
                    {% if message.message %}
                    <div class="message-text">{{ message.message }}</div>
                    {% endif %}
                    {% if message.image %}
                    <img src="{{ message.image }}" alt="">
                    {% endif %}
                    <div class="msg-time">{{ message.chat_time}}</div>
                </div>
            </div>
            {% endfor %}
          {% endfor %}
        </div>

        <!-- MESSAGE INPUT -->
        <div id="chatInputWrapper">
            <input type="text" name="message" id="message" placeholder="Type a message...">
            <button id="sendBtn">Send</button>
            <label for="image" class="file-label"><i class="fa-solid fa-camera"></i></label>
            <input type="file" name="image" id="image">
        </div>

    </div> <!-- End main-feed -->

    <!-- RIGHT SIDEBAR -->
    <div class="right-sidebar desktop-only">
        <div class="card">
            <div class="sidebar-content">
                <h4 class="desktop-member-title">Faces You May Know</h4>
                <div class="desktop-member-list">
                    {% for member in members %}
                        {% if request.user != member %}
                            <div class="desktop-member-item">
                                <a href="{% url 'profile' member.username %}">
                                    <div class="member-pic-wrapper" style="background: var(--border-color); padding: 0;">
                                        <img src="{{ member.profile.picture.url }}" alt="{{ member.username }}" class="member-pic">
                                    </div>
                                    <div>
                                        <span class="member-username block">{{ member.first_name }} {{ member.last_name }}</span>
                                        <br><span class="member-title block">@{{ member.username }}</span>
                                    </div>
                                </a>
                                <button class="btn btn-blue btn-follow">Follow</button>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

</main>

<footer class="mobile-only">
   
</footer>

<!-- ========================= -->
<!-- WEBSOCKET CHAT SCRIPT -->
<!-- ========================= -->
<script>
const pictureUrl = "{{ user.profile.picture.url }}";
const user = "{{ user }}";
const channel_id = "{{ channel.channel_id }}";

const image = document.getElementById('image');
const message = document.getElementById('message');
const sendBtn = document.getElementById('sendBtn');
const messageOutput = document.getElementById('messageOutput');

const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
const socket = new WebSocket(`${protocol}${window.location.host}/ws/${channel_id}/`);

function scrollToBottom(){
  messageOutput.scrollTop = messageOutput.scrollHeight;
}

socket.addEventListener('message', function(e) {
  scrollToBottom();
  const data = JSON.parse(e.data);
  const wrapper = document.createElement('div');
  let side = (data.username === user) ? "chat-right" : "chat-left";
 

  wrapper.className = `chat-message ${side}`;
  wrapper.innerHTML = `
        ${ side === "chat-left" ? `<img src="${data.pictureUrl}" class="avatar"> ` : "" }
        <div class="bubble ${ side === "chat-right" ? "bubble-right" : "bubble-left" }">
            ${side == "chat-left" ? `<strong>${data.username}</strong>` : ""}
            ${data.message ? `<div class="message-text">${data.message}</div>` : ""}
            ${data.image ? `<img src="${data.image}">` : ""}
            <div class="msg-time">${data.time}</div>
        </div>
    `;
  messageOutput.appendChild(wrapper);

});

sendBtn.addEventListener('click', function() {
  scrollToBottom();
  const typedMessage = message.value;
  const imageFile = image.files[0];

  if (!typedMessage && !imageFile) return;

  if (imageFile) {
    const reader = new FileReader();
    reader.onload = () => {
      socket.send(JSON.stringify({
        'message': typedMessage,
        'image': reader.result,
        'pictureUrl': pictureUrl,
        'username': user
      }));
    };
    reader.readAsDataURL(imageFile);
  } else {
    socket.send(JSON.stringify({
      'message': typedMessage,
      'image': null,
      'pictureUrl': pictureUrl,
      'username': user
    }));
  }

  message.value = '';
  image.value = '';
});
</script>

</body>
</html>