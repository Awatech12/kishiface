{% load humanize %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KishiFace - Home</title>
  <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.7/dist/htmx.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="stylesheet" href="{% static 'css/home.css' %}">
  <style>
      .comment {
      display: flex;
      align-items: flex-start;
      margin: 15px 0;
      position: relative;
    }

    .avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      margin-right: 10px;
      object-fit: cover;
    }

    .comment-body {
      background: #f2f3f5;
      padding: 8px 12px;
      border-radius: 12px;
      position: relative;
      min-height: 70px;
      min-width: 400px;
      max-width: 500px;
    }

    .username {
      font-weight: bold;
      color: #050505;
      margin-bottom: 2px;
      text-decoration: none;
    }

    .text {
      margin: 0;
      font-size: 14px;
      color: #1c1e21;
    }

    .comment::before {
      content: "";
      position: absolute;
      left: 20px;
      top: 45px;
      width: 2px;
      height: calc(100% - 45px);
      background-color: #d3d3d3;
    }
        #image{
            display: none;
        }
        #video{
            display: none;
        }
  </style>
</head>
<body>

{% include 'header.html' %}

<main class="container">
    
    <!-- ============================================== -->
    <!-- 1. LEFT SIDEBAR (Desktop Only: Profile, Settings, etc.) -->
    <!-- Uses desktop-only class -->
    <!-- ============================================== -->
    <div class="left-sidebar desktop-only">
        <div class="card">
            <div class="sidebar-content">
                <h4 class="sidebar-title">My Account</h4>
                
                <a href="{% url 'profile' request.user.username %}" class="sidebar-link">
                    <i class="fa-solid fa-user-circle"></i> Profile
                </a>
                <a href="" class="sidebar-link">
                    <i class="fa-solid fa-cog"></i> Settings
                </a>
                <a href="{% url 'channel_create' %}" class="sidebar-link">
                    <i class="fa-solid fa-cog"></i> Channels
                </a>
                <a href="{% url 'post' %}" class="sidebar-link">
                <i><svg fill="none" stroke="currentColor" height="20" width="20" viewBox="0 0 24 24">
                  <circle cx="12" cy="12" r="10" stroke-width="2"/>
                  <line x1="12" y1="8" x2="12" y2="16" stroke-width="2"/>
                  <line x1="8" y1="12" x2="16" y2="12" stroke-width="2"/>
                </svg></i> Post
              </a>
                <hr class="sidebar-divider">
                <a href="{% url 'logout' %}" class="sidebar-link logout">
                    <i class="fa-solid fa-right-from-bracket"></i> Logout
                </a>
            </div>
        </div>
    </div>

    <!-- ============================================== -->
    <!-- 2. MAIN FEED (Center Column) -->
    <!-- ============================================== -->
    <div class="main-feed">

    <img src="{{channel.image.url}}" height="500" width="100%" alt="">
    <div>Channel_ID: {{channel.channel_id}}</div>
    <div>Channel Name: {{channel.channel_name}}</div>
    <div>Subscribers: {{channel.subscriber.count}}</div>
    
    <div id="messageOutput">
      {% for message in messages %}
<div class="comment">
    <!-- Profile Picture -->
    <img src="{{message.pictureUrl}}" alt="Profile" class="avatar">

    <!-- Comment Content -->
    <div class="comment-body">
      <a href="{% url 'profile' message.author.username %}" class="username">
        {{message.author}} &bull;<i style="margin: 5px;" class="far fa-clock"></i>{{message.created_at}} 
      </a>
      <p class="text">{{ message.message }}</p>

      {% if message.image %}
        <img src="{{message.image}}" alt="" style="width:200px; height:200px; border-radius:8px;">
      {% endif %}
     
    </div>
  </div>
  {% endfor %}
    </div>
    <input type="file" name="image" id="image"><br>
    <label for="message">Message:</label><br>
    <input type="text" name="message" id="message"><br>
    <button id="sendBtn">Send</button>  <label for="image" class="file-label">
          <i class="fa-solid fa-camera"></i>
        </label>
    </div> <!-- End main-feed -->

    <!-- ============================================== -->
    <!-- 3. RIGHT SIDEBAR (Desktop Only: Faces You May Know) -->
    <!-- Uses desktop-only class -->
    <!-- ============================================== -->
    <div class="right-sidebar desktop-only">
        <div class="card">
            <div class="sidebar-content">
                <h4 class="desktop-member-title">Faces You May Know</h4>
                <div class="desktop-member-list">
                    {% for member in members %}
                        {% if request.user != member %}
                            <div class="desktop-member-item">
                                <a href="{% url 'profile' member.username %}">
                                    <div class="member-pic-wrapper" style="background: var(--border-color); padding: 0;">
                                        <img src="{{member.profile.picture.url}}" 
                                             
                                             alt="{{member.username}}" 
                                             class="member-pic">
                                    </div>
                                    <div>
                                        <span class="member-username block">{{member.first_name}} {{member.last_name}}</span>
                                        <br><span class="member-title block">@{{member.username}}</span>
                                    </div>
                                </a>
                                <!-- Placeholder follow button -->
                                <button class="btn btn-blue btn-follow">Follow</button>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div> <!-- End right-sidebar -->

</main>

<!-- MOBILE-ONLY FOOTER (Uses mobile-only class) -->
<footer class="mobile-only">
    {% include 'footer.html' %}
</footer>

<script>
   const pictureUrl = '{{user.profile.picture.url}}';
        const user = '{{user}}';
        const channel_owner = '{{channel.channel_owner}}';
        const channel_id = '{{channel.channel_id}}';
        const image = document.getElementById('image');
        const message = document.getElementById('message');
        const sendBtn = document.getElementById('sendBtn');
        const messageOutput = document.getElementById('messageOutput');
        const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
        const socket = new WebSocket(`${protocol}${window.location.host}/ws/${channel_id}/`);
    
        console.log(user)
        console.log(channel_owner)
        socket.addEventListener('message',function(e){
           
            const p = document.createElement('p');
            const data = JSON.parse(e.data);
            if(data.image && data.message){
    p.innerHTML=`<div class="comment">
    <img src="${data.pictureUrl}" alt="Profile" class="avatar">
    <div class="comment-body">
      <a href="" class="username">
        ${data.username}
      </a>
      <p class="text">${data.message}</p>
        <img src="${data.image}" alt="" style="width:200px; height:200px; border-radius:8px;">
      </div>
  </div>`
                messageOutput.appendChild(p);
           
            }
           if(data.message){
            p.innerHTML=`<div class="comment">
    <img src="${data.pictureUrl}" alt="Profile" class="avatar">
    <div class="comment-body">
      <a href="" class="username">
        ${data.username}
      </a>
      <p class="text">${data.message}</p>
      </div>
  </div>`
            messageOutput.appendChild(p);
          
           }
           if(data.image){
            p.innerHTML=`<div class="comment">
    <img src="${data.pictureUrl}" alt="Profile" class="avatar">
    <div class="comment-body">
      <a href="" class="username">
        ${data.username}
      </a>
        <img src="${data.image}" alt="" style="width:200px; height:200px; border-radius:8px;">
      </div>
  </div>`
                messageOutput.appendChild(p);
               
           }

             messageOutput.scrollTop = messageOutput.scrollHeight;
        })

        sendBtn.addEventListener('click', function(){
            const inputMessage = message.value;
            const imageInput = image.files[0];
            if(!inputMessage && !imageInput) return;
            if(imageInput){
                const reader = new FileReader();
                reader.onload = ()=>{
                    socket.send(JSON.stringify({
                        'message': inputMessage,
                        'image':reader.result,
                        'pictureUrl':pictureUrl
                    }))
                    message.value ='';
                    image.value = '';
                }
                reader.readAsDataURL(imageInput);
            }else{
                    socket.send(JSON.stringify({
                        'message': inputMessage,
                        'pictureUrl':pictureUrl,
                        'image': null
                    }))
                    message.value='';

            }
            
         })

        
        
        
    
</script>
</body>
</html>

