{% include 'header.html' %}
{% load humanize %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <style>
        .comment {
      display: flex;
      align-items: flex-start;
      margin: 15px 0;
      position: relative;
    }

    .avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      margin-right: 10px;
      object-fit: cover;
    }

    .comment-body {
      background: #f2f3f5;
      padding: 8px 12px;
      border-radius: 12px;
      position: relative;
      min-height: 70px;
      min-width: 400px;
      max-width: 500px;
    }

    .username {
      font-weight: bold;
      color: #050505;
      margin-bottom: 2px;
      text-decoration: none;
    }

    .text {
      margin: 0;
      font-size: 14px;
      color: #1c1e21;
    }

    .comment::before {
      content: "";
      position: absolute;
      left: 20px;
      top: 45px;
      width: 2px;
      height: calc(100% - 45px);
      background-color: #d3d3d3;
    }
        #image{
            display: none;
        }
        #video{
            display: none;
        }
    </style>
</head>
<body>
   
    
    <div>Channel_ID: {{channel.channel_id}}</div>
    <div>Channel Name: {{channel.channel_name}}</div>
    
    <div id="messageOutput">
      {% for message in messages %}
<div class="comment">
    <!-- Profile Picture -->
    <img src="{{message.pictureUrl}}" alt="Profile" class="avatar">

    <!-- Comment Content -->
    <div class="comment-body">
      <a href="{% url 'profile' message.author.username %}" class="username">
        {{message.author}} &bull;<i style="margin: 5px;" class="far fa-clock"></i>{{message.created_at}} 
      </a>
      <p class="text">{{ message.message }}</p>

      {% if message.image %}
        <img src="{{message.image}}" alt="" style="width:200px; height:200px; border-radius:8px;">
      {% endif %}
     
    </div>
  </div>
  {% endfor %}
    </div>
    <input type="file" name="image" id="image"><br>
    <label for="message">Message:</label><br>
    <input type="text" name="message" id="message"><br>
    <button id="sendBtn">Send</button>  <label for="image" class="file-label">
          <i class="fa-solid fa-camera"></i>
        </label>
    <script>
        const pictureUrl = '{{user.profile.picture.url}}';
        const user = '{{user}}';
        const channel_owner = '{{channel.channel_owner}}';
        const channel_id = '{{channel.channel_id}}';
        const image = document.getElementById('image');
        const message = document.getElementById('message');
        const sendBtn = document.getElementById('sendBtn');
        const messageOutput = document.getElementById('messageOutput');
        const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
        const socket = new WebSocket(`${protocol}${window.location.host}/ws/${channel_id}/`);
    
        console.log(user)
        console.log(channel_owner)
        socket.addEventListener('message',function(e){
           
            const p = document.createElement('p');
            const data = JSON.parse(e.data);
            if(data.image && data.message){
    p.innerHTML=`<div class="comment">
    <img src="${data.pictureUrl}" alt="Profile" class="avatar">
    <div class="comment-body">
      <a href="" class="username">
        ${data.username}
      </a>
      <p class="text">${data.message}</p>
        <img src="${data.image}" alt="" style="width:200px; height:200px; border-radius:8px;">
      </div>
  </div>`
                messageOutput.appendChild(p);
           
            }
           if(data.message){
            p.innerHTML=`<div class="comment">
    <img src="${data.pictureUrl}" alt="Profile" class="avatar">
    <div class="comment-body">
      <a href="" class="username">
        ${data.username}
      </a>
      <p class="text">${data.message}</p>
      </div>
  </div>`
            messageOutput.appendChild(p);
          
           }
           if(data.image){
            p.innerHTML=`<div class="comment">
    <img src="${data.pictureUrl}" alt="Profile" class="avatar">
    <div class="comment-body">
      <a href="" class="username">
        ${data.username}
      </a>
        <img src="${data.image}" alt="" style="width:200px; height:200px; border-radius:8px;">
      </div>
  </div>`
                messageOutput.appendChild(p);
               
           }

             messageOutput.scrollTop = messageOutput.scrollHeight;
        })

        sendBtn.addEventListener('click', function(){
            const inputMessage = message.value;
            const imageInput = image.files[0];
            if(!inputMessage && !imageInput) return;
            if(imageInput){
                const reader = new FileReader();
                reader.onload = ()=>{
                    socket.send(JSON.stringify({
                        'message': inputMessage,
                        'image':reader.result,
                        'pictureUrl':pictureUrl
                    }))
                    message.value ='';
                    image.value = '';
                }
                reader.readAsDataURL(imageInput);
            }else{
                    socket.send(JSON.stringify({
                        'message': inputMessage,
                        'pictureUrl':pictureUrl,
                        'image': null
                    }))
                    message.value='';

            }
            
         })

        
        
        
    </script>
</body>
</html>
{% include 'footer.html' %}