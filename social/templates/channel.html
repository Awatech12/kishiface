<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{{ channel.name }} | KishiFace</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* ===== KISHIFACE INSTAGRAM-DM STYLE FOR CHANNELS ===== */
        :root {
            --kf-primary: #0095f6;
            --kf-bg: #ffffff;
            --kf-border: #dbdbdb;
            --kf-text: #262626;
            --kf-text-light: #8e8e8e;
            --kf-sent-bg: #0095f6;
            --kf-received-bg: #efefef;
            --kf-input-bg: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body, html {
            background-color: var(--kf-bg);
            height: 100%;
            height: 100dvh; 
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        .kishiface-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            height: 100dvh;
            width: 100%;
            position: relative;
        }

        /* ===== HEADER ===== */
        .kishiface-header {
            padding: 8px 16px;
            background: var(--kf-bg);
            border-bottom: 1px solid var(--kf-border);
            display: flex;
            align-items: center;
            height: 60px;
            z-index: 100;
            flex-shrink: 0;
        }

        .kishiface-back-btn {
            background: none; border: none; color: var(--kf-text);
            font-size: 22px; cursor: pointer; padding: 8px; margin-right: 8px;
        }

        .kishiface-channel-info { display: flex; align-items: center; flex: 1; cursor: pointer; min-width: 0; }

        .kishiface-avatar {
            width: 36px; height: 36px; border-radius: 50%;
            object-fit: cover; margin-right: 12px; flex-shrink: 0;
        }

        .kishiface-avatar-placeholder {
            width: 36px; height: 36px; border-radius: 50%;
            margin-right: 12px; background: var(--kf-primary);
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: 600; font-size: 16px; flex-shrink: 0;
        }

        .kishiface-channel-details h3 {
            font-size: 16px; font-weight: 600; color: var(--kf-text);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .kishiface-channel-subscribers { font-size: 12px; color: var(--kf-text-light); }

        /* ===== MESSAGES CONTAINER ===== */
        .kishiface-messages-scroll {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .kishiface-date-separator { text-align: center; margin: 20px 0 10px; }
        .kishiface-date-label { font-size: 12px; color: var(--kf-text-light); font-weight: 600; }

        /* ===== MESSAGE ROWS ===== */
        .kishiface-msg-wrapper { display: flex; flex-direction: column; margin-bottom: 8px; max-width: 85%; }
        .kishiface-msg-wrapper.outgoing { align-self: flex-end; align-items: flex-end; }
        .kishiface-msg-wrapper.incoming { align-self: flex-start; align-items: flex-start; }

        .kishiface-sender-name {
            font-size: 11px;
            color: var(--kf-text-light);
            margin-bottom: 2px;
            margin-left: 12px;
            text-decoration: none;
            font-weight: 600;
        }
        .kishiface-sender-name:hover { text-decoration: underline; }

        .kishiface-message-bubble {
            padding: 10px 14px; border-radius: 22px;
            font-size: 14px; line-height: 1.4; position: relative; word-wrap: break-word;
        }
        .kishiface-message-bubble.outgoing { background: var(--kf-sent-bg); color: #ffffff; }
        .kishiface-message-bubble.incoming { background: var(--kf-received-bg); color: var(--kf-text); }

        .kishiface-media-content { border-radius: 18px; overflow: hidden; margin-bottom: 4px; cursor: pointer; }
        .kishiface-media-content img, .kishiface-media-content video { width: 100%; max-width: 280px; display: block; border-radius: 18px; }
        .kishiface-text-padding { padding: 6px 10px 8px 10px; }
        .kishiface-message-meta { font-size: 10px; margin-top: 2px; opacity: 0.7; display: flex; align-items: center; gap: 4px; }

        /* ===== AUDIO PLAYER ===== */
        .kishiface-audio-player { display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 22px; min-width: 200px; }
        .kishiface-audio-play-btn {
            width: 32px; height: 32px; border-radius: 50%; border: none;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; background: rgba(0,0,0,0.1); flex-shrink: 0;
        }
        .outgoing .kishiface-audio-play-btn { background: rgba(255,255,255,0.2); color: white; }
        .kishiface-audio-waveform { flex: 1; height: 24px; display: flex; align-items: center; gap: 2px; overflow: hidden; }
        .kishiface-wave-bar { width: 2px; background: rgba(0,0,0,0.15); border-radius: 1px; transition: background 0.1s; }
        .outgoing .kishiface-wave-bar { background: rgba(255,255,255,0.3); }
        .kishiface-wave-bar.active { background: var(--kf-text); }
        .outgoing .kishiface-wave-bar.active { background: #ffffff; }

        /* ===== INPUT AREA (RESPONSIVE FIX) ===== */
        .kishiface-input-container {
            padding: 8px 12px;
            background: var(--kf-bg);
            border-top: 1px solid var(--kf-border);
            width: 100%;
            flex-shrink: 0; /* Ensures it stays visible on small screens */
            padding-bottom: calc(8px + env(safe-area-inset-bottom));
        }

        .kishiface-input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            background: var(--kf-bg);
            border: 1px solid var(--kf-border);
            border-radius: 24px;
            padding: 6px 12px;
            width: 100%;
            min-width: 0;
        }

        .kishiface-message-input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 15px;
            max-height: 120px;
            padding: 8px 0;
            resize: none;
            background: transparent;
            min-width: 0;
        }

        .recording-status {
            display: none;
            flex: 1;
            align-items: center;
            gap: 12px;
            color: #ed4956;
            font-weight: 600;
            font-size: 14px;
            padding: 8px 0;
            min-width: 0;
        }

        .kishiface-send-btn {
            color: var(--kf-primary); font-weight: 600; background: none;
            border: none; cursor: pointer; font-size: 15px; padding: 8px 4px; flex-shrink: 0;
        }

        .kishiface-icon-btn {
            background: none; border: none; font-size: 20px; color: var(--kf-text);
            cursor: pointer; padding: 8px 4px; flex-shrink: 0; display: flex; align-items: center; justify-content: center;
        }

        /* ===== MODALS & ANIMATIONS ===== */
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .recording-pulse { animation: pulse 1.5s infinite; color: #ed4956 !important; }

        .kishiface-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: none; justify-content: center;
            align-items: center; z-index: 1000;
        }
        .kishiface-modal.show { display: flex; }
        .kishiface-modal-content img { max-width: 95%; max-height: 85vh; border-radius: 8px; }
    </style>
</head>
<body>

<div class="kishiface-container">
    <header class="kishiface-header">
        <button class="kishiface-back-btn" onclick="window.history.back()">
            <i class="fas fa-chevron-left"></i>
        </button>
        
        <div class="kishiface-channel-info">
            {% if channel.image %}
                <img src="{{ channel.image.url }}" alt="{{ channel.name }}" class="kishiface-avatar">
            {% else %}
                <div class="kishiface-avatar-placeholder">{{ channel.name|slice:":1"|upper }}</div>
            {% endif %}
            
            <div class="kishiface-channel-details">
                <h3>{{ channel.name }}</h3>
                <div class="kishiface-channel-subscribers">{{ channel.subscriber.count }} members</div>
            </div>
        </div>
        <button class="kishiface-icon-btn"><i class="fas fa-info-circle"></i></button>
    </header>

    <main class="kishiface-messages-scroll" id="messagesList">
        {% for label, msgs in grouped_messages.items %}
            <div class="kishiface-date-separator">
                <span class="kishiface-date-label">{{ label }}</span>
            </div>
            
            {% for message in msgs %}
                <div class="kishiface-msg-wrapper {% if message.author == request.user %}outgoing{% else %}incoming{% endif %}" data-message-id="{{ message.channelmessage_id }}">
                    
                    {% if message.author != request.user %}
                        <a href="{% url 'profile' message.author.username %}" class="kishiface-sender-name">
                            {{ message.author.username }}
                        </a>
                    {% endif %}

                    <div class="kishiface-message-bubble {% if message.author == request.user %}outgoing{% else %}incoming{% endif %} {% if message.file %}has-media{% endif %}">
                        
                        {% if message.file %}
                            <div class="kishiface-media-content">
                                {% if message.file_type == 'image' %}
                                    <img src="{{ message.file.url }}" onclick="openMediaModal('{{ message.file.url }}')">
                                {% elif message.file_type == 'video' %}
                                    <video src="{{ message.file.url }}" controls onplay="stopOtherMedia(this)"></video>
                                {% elif message.file_type == 'audio' %}
                                    <div class="kishiface-audio-player">
                                        <button class="kishiface-audio-play-btn" onclick="toggleAudioPlay('{{ message.channelmessage_id }}')">
                                            <i class="fas fa-play" id="audio-play-icon-{{ message.channelmessage_id }}"></i>
                                        </button>
                                        <div class="kishiface-audio-waveform" id="waveform-{{ message.channelmessage_id }}"></div>
                                        <audio id="audio-player-{{ message.channelmessage_id }}" src="{{ message.file.url }}" onplay="stopOtherMedia(this)" ontimeupdate="updateAudioProgress('{{ message.channelmessage_id }}')" onended="resetAudioIcon('{{ message.channelmessage_id }}')"></audio>
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}

                        {% if message.message %}
                            <div class="message-text-container {% if message.file %}kishiface-text-padding{% endif %}">
                                <span class="text-content" id="text-{{ message.channelmessage_id }}">{{ message.message }}</span>
                            </div>
                        {% endif %}

                        <div class="kishiface-message-meta">
                            {{ message.chat_time }}
                            {% if message.author == request.user %}
                                <i class="fas fa-check-double"></i>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% endfor %}
    </main>

    <div class="kishiface-input-container">
        <div class="kishiface-input-wrapper">
            <button class="kishiface-icon-btn" id="attachButton" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-paperclip"></i>
            </button>
            
            <textarea class="kishiface-message-input" id="messageInput" placeholder="Message..." rows="1"></textarea>
            
            <div id="recordingStatus" class="recording-status">
                <i class="fas fa-microphone recording-pulse"></i>
                <span id="recordingTimer">0:00</span>
            </div>

            <button class="kishiface-send-btn" id="sendButton" onclick="sendMessage()" style="display: none;">Send</button>
            
            <button class="kishiface-icon-btn" id="micButton" 
                    onmousedown="startRecording(event)" 
                    onmouseup="stopRecording()"
                    ontouchstart="startRecording(event)"
                    ontouchend="stopRecording()">
                <i class="fas fa-microphone"></i>
            </button>
            
            <input type="file" id="fileInput" hidden accept="image/*,video/*,audio/*">
        </div>
    </div>

    <div class="kishiface-modal" id="mediaModal" onclick="closeMediaModal()">
        <div class="kishiface-modal-content">
            <img id="modalImage" src="">
        </div>
    </div>
</div>

<script>
    const csrftoken = '{{ csrf_token }}';
    const channelId = '{{ channel.channel_id }}';
    const currentUserUsername = '{{ request.user.username }}';

    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const micButton = document.getElementById('micButton');
    const messagesList = document.getElementById('messagesList');
    const fileInput = document.getElementById('fileInput');
    const recordingStatus = document.getElementById('recordingStatus');
    const recordingTimer = document.getElementById('recordingTimer');
    const attachButton = document.getElementById('attachButton');

    let currentlyPlaying = null;

    // --- Media Controller (Prevents simultaneous play) ---
    function stopOtherMedia(currentMedia) {
        if (currentlyPlaying && currentlyPlaying !== currentMedia) {
            currentlyPlaying.pause();
            if (currentlyPlaying.id && currentlyPlaying.id.startsWith('audio-player-')) {
                const id = currentlyPlaying.id.replace('audio-player-', '');
                resetAudioIcon(id);
            }
        }
        currentlyPlaying = currentMedia;
    }

    // --- Input Handling ---
    function updateInputVisibility() {
        const hasText = messageInput.value.trim().length > 0;
        const hasFile = fileInput.files.length > 0;
        
        if (hasText || hasFile) {
            sendButton.style.display = 'block';
            micButton.style.display = 'none';
        } else {
            sendButton.style.display = 'none';
            micButton.style.display = 'block';
        }
    }

    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
        updateInputVisibility();
    });

    fileInput.addEventListener('change', updateInputVisibility);

    // --- WebSocket ---
    const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    const socket = new WebSocket(`${protocol}${window.location.host}/ws/${channelId}/`);

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        if (data.type === 'new_message') {
            appendNewMessage(data);
        }
    };

    function appendNewMessage(data) {
        const isOutgoing = data.author == currentUserUsername;
        const msgId = data.message_id || Math.random().toString(36).substr(2, 9);
        
        const msgHtml = `
            <div class="kishiface-msg-wrapper ${isOutgoing ? 'outgoing' : 'incoming'}" data-message-id="${msgId}">
                ${!isOutgoing ? `<a href="/profile/${data.author}/" class="kishiface-sender-name">${data.author}</a>` : ''}
                <div class="kishiface-message-bubble ${isOutgoing ? 'outgoing' : 'incoming'}">
                    ${data.file_url ? `
                        <div class="kishiface-media-content">
                            ${data.file_type === 'image' ? `<img src="${data.file_url}" onclick="openMediaModal('${data.file_url}')">` : ''}
                            ${data.file_type === 'video' ? `<video src="${data.file_url}" controls onplay="stopOtherMedia(this)"></video>` : ''}
                            ${data.file_type === 'audio' ? `
                                <div class="kishiface-audio-player">
                                    <button class="kishiface-audio-play-btn" onclick="toggleAudioPlay('${msgId}')">
                                        <i class="fas fa-play" id="audio-play-icon-${msgId}"></i>
                                    </button>
                                    <div class="kishiface-audio-waveform" id="waveform-${msgId}"></div>
                                    <audio id="audio-player-${msgId}" src="${data.file_url}" onplay="stopOtherMedia(this)" ontimeupdate="updateAudioProgress('${msgId}')" onended="resetAudioIcon('${msgId}')"></audio>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                    ${data.message ? `<div class="message-text-container ${data.file_url ? 'kishiface-text-padding' : ''}"><span class="text-content" id="text-${msgId}">${data.message}</span></div>` : ''}
                    <div class="kishiface-message-meta">${data.time} ${isOutgoing ? '<i class="fas fa-check-double"></i>' : ''}</div>
                </div>
            </div>
        `;
        messagesList.insertAdjacentHTML('beforeend', msgHtml);
        
        if (data.message) applyReadMore(document.getElementById(`text-${msgId}`));
        if (data.file_type === 'audio') generateWaveform(document.getElementById(`waveform-${msgId}`));
        
        messagesList.scrollTop = messagesList.scrollHeight;
    }

    // --- Messaging ---
    async function sendMessage() {
        const message = messageInput.value.trim();
        const file = fileInput.files[0];
        if (!message && !file) return;

        const formData = new FormData();
        formData.append('message', message);
        formData.append('channel_id', channelId);
        if (file) formData.append('file_upload', file);

        messageInput.value = '';
        messageInput.style.height = 'auto';
        fileInput.value = '';
        updateInputVisibility();

        await fetch(`/channel_message/${channelId}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrftoken },
            body: formData
        });
    }

    // --- Read More / Less ---
    function applyReadMore(el) {
        if (!el) return;
        const limit = 300;
        const text = el.innerText;
        if (text.length <= limit) return;

        const visibleText = text.substring(0, limit);
        const hiddenText = text.substring(limit);

        el.innerHTML = `
            <span class="content-visible">${visibleText}</span>
            <span class="content-truncated">${hiddenText}</span>
            <button class="read-more-btn" onclick="toggleReadMore(this)">...read more</button>
        `;
    }

    function toggleReadMore(btn) {
        const truncatedSpan = btn.previousElementSibling;
        const isHidden = truncatedSpan.style.display === 'none' || truncatedSpan.style.display === '';
        
        if (isHidden) {
            truncatedSpan.style.display = 'inline';
            btn.innerText = ' show less';
        } else {
            truncatedSpan.style.display = 'none';
            btn.innerText = ' ...read more';
        }
    }

    // --- Audio Player Logic ---
    function generateWaveform(container) {
        if (!container) return;
        container.innerHTML = '';
        for(let i=0; i<35; i++) {
            const bar = document.createElement('div');
            bar.className = 'kishiface-wave-bar';
            bar.style.height = Math.random() * 16 + 4 + 'px';
            container.appendChild(bar);
        }
    }

    function toggleAudioPlay(id) {
        const player = document.getElementById(`audio-player-${id}`);
        const icon = document.getElementById(`audio-play-icon-${id}`);
        if (player.paused) {
            stopOtherMedia(player);
            player.play();
            icon.className = 'fas fa-pause';
        } else {
            player.pause();
            icon.className = 'fas fa-play';
        }
    }

    function updateAudioProgress(id) {
        const player = document.getElementById(`audio-player-${id}`);
        const waveform = document.getElementById(`waveform-${id}`);
        if (!player || !waveform) return;

        const bars = waveform.querySelectorAll('.kishiface-wave-bar');
        const progress = (player.currentTime / player.duration) * bars.length;

        bars.forEach((bar, index) => {
            if (index < progress) bar.classList.add('active');
            else bar.classList.remove('active');
        });
    }

    function resetAudioIcon(id) {
        const icon = document.getElementById(`audio-play-icon-${id}`);
        if(icon) icon.className = 'fas fa-play';
    }

    // --- Recording Logic ---
    let mediaRecorder, audioChunks = [], recordInterval, seconds = 0;

    async function startRecording(e) {
        e.preventDefault();
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
            mediaRecorder.onstop = sendAudio;
            
            // UI Toggle
            messageInput.style.display = 'none';
            attachButton.style.display = 'none';
            recordingStatus.style.display = 'flex';
            micButton.classList.add('recording-pulse');
            
            // Timer logic
            seconds = 0;
            recordingTimer.innerText = "0:00";
            recordInterval = setInterval(() => {
                seconds++;
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                recordingTimer.innerText = `${mins}:${secs.toString().padStart(2, '0')}`;
            }, 1000);

            mediaRecorder.start();
        } catch (err) {
            console.error("Mic access denied", err);
        }
    }

    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
        clearInterval(recordInterval);
        
        // UI Reset
        messageInput.style.display = 'block';
        attachButton.style.display = 'flex';
        recordingStatus.style.display = 'none';
        micButton.classList.remove('recording-pulse');
    }

    async function sendAudio() {
        if (audioChunks.length === 0) return;
        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        const formData = new FormData();
        formData.append('file_upload', audioBlob, 'recording.webm');
        formData.append('channel_id', channelId);
        audioChunks = [];
        await fetch(`/channel_message/${channelId}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrftoken },
            body: formData
        });
    }

    // --- Initialization ---
    window.onload = () => {
        document.querySelectorAll('.text-content').forEach(applyReadMore);
        document.querySelectorAll('.kishiface-audio-waveform').forEach(generateWaveform);
        messagesList.scrollTop = messagesList.scrollHeight;
    };

    function openMediaModal(url) {
        document.getElementById('modalImage').src = url;
        document.getElementById('mediaModal').classList.add('show');
    }
    function closeMediaModal() {
        document.getElementById('mediaModal').classList.remove('show');
    }
</script>

</body>
</html>
