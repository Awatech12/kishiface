{% load humanize %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KishiFace - Channel</title>
  <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.7/dist/htmx.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="stylesheet" href="{% static 'css/home.css' %}">
  <style>
    /* ========================= */
    /* GLOBAL STYLES & VARIABLES (WhatsApp/Telegram Channel Base) */
    /* ========================= */
    :root {
      --primary-green: #666; 
      --secondary-text: #8696a0;
      --background-chat: #ece5dd; 
      --message-bg: #fff; 
      --red-liked: #ed4956;
    }

    body {
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: var(--background-chat);
      color: #111b21;
    }

    /* Main Container - Mobile First Focus */
    main.container {
      max-width: 768px; /* Max width to keep it chat-like */
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      background: var(--background-chat);
    }
    
    /* Hide all sidebars and unrelated desktop elements */
    .desktop-only, .right-sidebar, .left-sidebar {
        display: none !important;
    }

    /* ========================= */
    /* CHANNEL HEADER (Fixed Top) */
    /* ========================= */
    .channel-header {
        display: flex;
        align-items: center;
        padding: 10px 15px;
        background: var(--primary-green);
        color: white;
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .header-icon {
        color: white;
        font-size: 1.4rem;
        margin-right: 15px;
    }
    .channel-avatar img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 10px;
    }
    .channel-name {
        font-size: 1.1rem;
        font-weight: 600;
        margin: 0;
    }
    .channel-stats {
        font-size: 0.8rem;
        color: #ddd;
    }
    .notification-icon {
        margin-left: auto;
        font-size: 1.2rem;
    }


    /* ========================= */
    /* CHAT MESSAGES (Feed) */
    /* ========================= */
    .main-feed {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden; /* Hide main feed overflow */
    }

    #messageOutput {
      flex-grow: 1;
      padding: 0 10px;
      overflow-y: auto;
      max-height: calc(100vh - 120px); /* Height between header and input */
    }

    .chat-message {
      display: flex;
      justify-content: center; /* Center the whole message block */
      width: 100%;
      padding: 8px 0;
    }
    
    .message-block {
        min-width: 85%;
        max-width: 95%; /* Messages don't fill the whole width */
        background: var(--message-bg);
        padding: 10px 12px;
        border-radius: 10px;
        box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
        position: relative;
        /* Padding bottom increased to accommodate the time/reaction row */
        padding-bottom: 35px; 
    }
    
    /* Author name/indicator */
    .message-author-name {
        display: block;
        font-weight: 700;
        color: #000; /* Author name is bold black/dark */
        margin-bottom: 5px;
    }
    
    .message-text {
        font-size: 0.95rem;
        line-height: 1.35;
        white-space: pre-wrap;
        color: #111b21;
    }
    
    .message-block img {
        max-width: 100%;
        max-height: 300px;
        border-radius: 8px;
        margin: 5px 0;
    }

    /* **FIX: TIMESTAMPS AND REACTIONS MOVED TO ABSOLUTE BOTTOM RIGHT** */
    .time-and-reactions-wrapper {
        position: absolute;
        bottom: 8px; /* Offset from the very bottom of the message block */
        right: 12px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* Reaction/Action Row */
    .reaction-row {
        display: flex;
        align-items: center;
        font-size: 0.8rem;
        position: relative; /* Make it a positioning context for the likes bubble */
    }

   
    
    .reaction-count {
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--secondary-text);
        margin-left: 4px;
    }
    
    .like-button {
        background: none;
        border: none;
        color: var(--secondary-text);
        cursor: pointer;
        font-size: 1rem;
        padding: 0;
        margin-left: 5px;
    }
    .like-button i {
        font-size: 0.85rem;
    }
    .like-button.liked {
        color: var(--primary-green); /* Changed to primary green for distinction */
    }
    
    /* Timestamp (Small and contained) */
    .msg-time {
        font-size: 0.7rem;
        color: var(--secondary-text);
        text-align: right;
        display: flex;
        align-items: center;
        gap: 3px;
    }
    
    /* Date Separator */
    .date-separator {
        text-align: center;
        padding: 10px 0;
    }
    .date-separator i {
        display: inline-block;
        background: #dde5eb; /* Light grayish blue */
        color: #4a637a;
        font-size: 0.7rem;
        padding: 5px 10px;
        border-radius: 8px;
        font-style: normal;
        font-weight: 600;
        text-transform: uppercase;
    }

    /* ========================= */
    /* MESSAGE INPUT (Fixed Bottom) */
    /* ========================= */
    #chatInputWrapper {
      position: sticky;
      bottom: 0;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px 10px;
      background: var(--background-chat);
      border-top: 1px solid rgba(0,0,0,0.1);
      z-index: 120;
    }
    
    #chatInputWrapper .inner-wrapper {
        display: flex;
        width: 100%;
        max-width: 600px; /* Constrain input width */
        gap: 8px;
    }

    #message {
      flex: 1;
      padding: 10px 15px;
      border-radius: 20px;
      border: 1px solid #ddd;
      font-size: 0.95rem;
      background-color: #fff;
    }

    #message:focus {
        outline: none;
        box-shadow: 0 0 0 1px var(--primary-green);
    }

    #sendBtn {
      padding: 10px 15px;
      border: none;
      background: var(--primary-green);
      border-radius: 20px;
      color: white;
      font-weight: 500;
      cursor: pointer;
      font-size: 0.95rem;
      flex-shrink: 0;
    }
    
    .file-label {
      font-size: 1.4rem;
      color: var(--secondary-text);
      cursor: pointer;
      display: flex;
      align-items: center;
    }
    .file-label:hover {
        color: #000;
    }
    #image { display: none; }
    
    .read-receipt {
        color: #4fc3f7; /* Blue ticks for read status */
        font-size: 0.7rem;
        margin-left: 2px;
    }

  </style>
</head>
<body>

<main class="container">

    <div class="channel-header">
        <a href="{% url 'channel_create' %}" class="header-icon"><i class="fa-solid fa-arrow-left"></i></a> 
        <div class="channel-avatar">
            <img src="{{ channel.image.url }}" alt="{{ channel.channel_name }}">
        </div>
        <div class="channel-info">
            <h2 class="channel-name">{{ channel.channel_name }}</h2>
            <div class="channel-stats">{{ channel.subscriber.count|intcomma }} followers</div>
        </div>
        <div class="notification-icon"><i class="fa-regular fa-bell"></i></div>
    </div>

    <div class="main-feed">
        <div id="messageOutput">
          {% for label, msgs in grouped_messages.items %}
            <div class="date-separator"><i>{{label}}</i></div>
            {% for message in msgs %}
            <div class="chat-message">
                <div class="message-block" id="msg-{{ message.channemessage_id }}">
                    <span class="message-author-name">
                       {% if message.author != user %}
                            <a style="text-decoration: none; color: #111b21;" href="{% url 'profile' message.author %}">{{ message.author }}</a>
                            {% endif %}
                      
                    </span>

                    {% if message.message %}
                    <div class="message-text">{{ message.message }}</div>
                    {% endif %}
                    
                    {% if message.image %}
                    <img src="{{ message.image.url }}" alt="Posted Image">
                    {% endif %}
                    
                    <div class="time-and-reactions-wrapper">
                        
                        <div class="reaction-row">
                            
                            <span class="reaction-count" id="like-count-{{ message.channemessage_id }}">{{ message.like.count }}</span>
                            
                            <button class="like-button {% if user in message.like.all %}liked{% endif %}"
                                    data-msg-id="{{ message.channemessage_id }}"
                                    onclick="sendLikeAction(this)">
                                <i class="{% if user in message.like.all %}fa-solid{% else %}fa-regular{% endif %} fa-thumbs-up"></i>
                            </button>
                        </div>

                        <div class="msg-time">
                            {{ message.chat_time}} 
                            {% if message.author == user %}
                            <i class="fa-solid fa-check-double read-receipt"></i>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
          {% endfor %}
          
          <div id="scroll-anchor" style="height: 1px;"></div>
        </div>
    </div> 


    <div id="chatInputWrapper">
        <div class="inner-wrapper">
            <input type="text" name="message" id="message" placeholder="Message {{ channel.channel_name }}...">
            <label for="image" class="file-label"><i class="fa-regular fa-image"></i></label>
            <input type="file" name="image" id="image">
            <button id="sendBtn">Send</button>
        </div>
    </div>

</main>

<script>
const pictureUrl = "{{ user.profile.picture.url }}";
const user = "{{ user }}";
const channel_id = "{{ channel.channel_id }}";

const image = document.getElementById('image');
const message = document.getElementById('message');
const sendBtn = document.getElementById('sendBtn');
const messageOutput = document.getElementById('messageOutput');
const scrollAnchor = document.getElementById('scroll-anchor');

const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
const socket = new WebSocket(`${protocol}${window.location.host}/ws/${channel_id}/`);

function scrollToBottom() {
  // Use smooth scrolling to the anchor element at the bottom
  scrollAnchor.scrollIntoView({ behavior: 'smooth', block: 'end' });
}

// Function to handle like/unlike action
function sendLikeAction(buttonElement) {
    const messageId = buttonElement.getAttribute('data-msg-id');
    socket.send(JSON.stringify({
        'action': 'like_unlike',
        'message_id': messageId,
        'username': user
    }));
}

socket.addEventListener('message', function(e) {
  const data = JSON.parse(e.data);

  if (data.type === 'Response') {
      
      const isUser = (data.username === user);
      const readReceipt = isUser ? '<i class="fa-solid fa-check-double read-receipt"></i>' : '';
      
      const chatMessage = document.createElement('div');
      chatMessage.className = `chat-message`;
      
      const imageHtml = data.image ? `<img src="${data.image}" alt="Channel Post">` : '';
      
      chatMessage.innerHTML = `
        <div class="message-block" id="msg-${data.message_id}">
            <span class="message-author-name">
                <a style="text-decoration: none; color: #111b21;" href="/profile/${data.username}">${data.username}</a>
            </span>
            
            ${data.message ? `<div class="message-text">${data.message}</div>` : ''}
            
            ${imageHtml}
            
            <div class="time-and-reactions-wrapper">
                
                <div class="reaction-row">
                    <div class="reactions">
                        <i class="fa-regular fa-face-grin-squint"></i>
                    </div>
                    <span class="reaction-count" id="like-count-${data.message_id}">0</span>
                    
                    <button class="like-button"
                            data-msg-id="${data.message_id}"
                            onclick="sendLikeAction(this)">
                        <i class="fa-regular fa-thumbs-up"></i>
                    </button>
                </div>

                <div class="msg-time">
                    ${data.time}
                    ${readReceipt}
                </div>
            </div>
        </div>
      `;
      
      messageOutput.appendChild(chatMessage);
      scrollToBottom(); // Scroll after adding new message

  } else if (data.type === 'like_response') {
      const likeCountElement = document.getElementById(`like-count-${data.message_id}`);
      const likeButtonElement = document.querySelector(`[data-msg-id='${data.message_id}']`);

      if (likeCountElement) {
          likeCountElement.textContent = data.like_count;
      }
      
      if (likeButtonElement) {
          const thumbIcon = likeButtonElement.querySelector('i');
          if (data.user_liked) {
              likeButtonElement.classList.add('liked');
              thumbIcon.classList.replace('fa-regular', 'fa-solid');
          } else {
              likeButtonElement.classList.remove('liked');
              thumbIcon.classList.replace('fa-solid', 'fa-regular');
          }
      }
  }

});

sendBtn.addEventListener('click', function() {
  const typedMessage = message.value;
  const imageFile = image.files[0];

  if (!typedMessage && !imageFile) return;

  if (imageFile) {
    const reader = new FileReader();
    reader.onload = () => {
      socket.send(JSON.stringify({
        'message': typedMessage,
        'image': reader.result,
        'pictureUrl': pictureUrl,
        'username': user
      }));
    };
    reader.readAsDataURL(imageFile);
  } else {
    socket.send(JSON.stringify({
      'message': typedMessage,
      'image': null,
      'pictureUrl': pictureUrl,
      'username': user
    }));
  }

  message.value = '';
  image.value = '';
});

// Initial scroll to bottom when page loads
document.addEventListener('DOMContentLoaded', () => {
    // Scroll needs a slight delay to ensure all DOM elements and images have rendered
    setTimeout(scrollToBottom, 100); 
});

</script>


</body>
</html>
