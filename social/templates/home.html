{% load humanize %}
{% load static %}
{% load time %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" href="{% static 'images/logo.jpg' %}" type="image/x-icon">
  <title>KishiFace - Home</title>
  <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.7/dist/htmx.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="stylesheet" href="{% static 'css/home.css' %}">
  <style>
    
    /* New/Updated Audio Styles for Cover Image Design */
    .audio-post-container {
        /* Main container for the cover and controls */
        display: flex;
        flex-direction: column;
        border: 1px solid var(--divider-color);
        border-radius: 8px;
        overflow: hidden; 
        margin-top: 10px;
    }
    
    .audio-cover-area {
        /* Styles for the background poster image */
        width: 100%;
        height: 250px; 
        background-size: cover;
        background-position: center;
        background-color: var(--text-dark); /* Fallback dark color */
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.4);
        filter: blur(8px);
        transform: scale(1.05);
        transition: filter 0.3s ease-in-out;
    }
    
    .audio-control {
        /* Styles for the standard HTML audio player */
        width: 100%;
        outline: none;
        border-radius: 0;
        background-color: var(--white);
        padding: 0; 
        border: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
    }
    
    /* Existing styles from the original file (kept for compatibility) */
    .cover{
        width: 100%;
        height: 250px;
        /*background-image: url('https://placehold.co/600x400/999999/ffffff?text=KishiFace+Post');*/
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 10px;
    }
    .cover i{
        font-size: 50px;
        color: #bdbdbd;
        margin-right: 40px;
    }
    .audio{
        width: 100%;
        outline: none;
    }
    
     /* Pop up design */

     #sidePanel{
        position: fixed;
        top: 0;
        right: -400px;
        width: 400px;
        height: 100%;
        background: white;
        box-shadow: -2px 0px 6px rgba(0, 0, 0, 0.2);
        border-left: 1px solid #ccc;
        transition:  right 0.3s ease;
        z-index: 9999;
        overflow: auto;
     }

      #sidePanel2{
        position: fixed;
        top: 0;
        left: -400px;
        width: 400px;
        height: 100%;
        background: white;
        box-shadow: -2px 0px 6px rgba(0, 0, 0, 0.2);
        border-left: 1px solid #ccc;
        transition:  left 0.4s ease;
        z-index: 9999;
        overflow: auto;
     }
    
    
  </style>
</head>
<body>

{% include 'header.html' %}

<main class="container">
    
    <div class="left-sidebar desktop-only">
        <div class="card">
            <div class="sidebar-content">
                <h4 class="sidebar-title">My Account</h4>
        
                <a href="{% url 'profile' user.username %}" class="sidebar-link" data-id="{{user.username}}">
                  <img src="{{user.profile.picture.url}}" height="30" width="30" style="border-radius: 50%;" alt="">  
                  {{user.profile.full_name}}
                </a>
                <a href="" class="sidebar-link">
                    <i class="fa-solid fa-cog"></i> Settings
                </a>
                <a href="{% url 'channel_create' %}" class="sidebar-link">
                    <i class="fa-solid fa-cog"></i> Channels
                </a>
                <a href="{% url 'post' %}" class="sidebar-link">
                <i><svg fill="none" stroke="currentColor" height="20" width="20" viewBox="0 0 24 24">
                  <circle cx="12" cy="12" r="10" stroke-width="2"/>
                  <line x1="12" y1="8" x2="12" y2="16" stroke-width="2"/>
                  <line x1="8" y1="12" x2="16" y2="12" stroke-width="2"/>
                </svg></i> Post
              </a>
                <hr class="sidebar-divider">
                <a href="{% url 'logout' %}" class="sidebar-link logout">
                    <i class="fa-solid fa-right-from-bracket"></i> Logout
                </a>
            </div>
           
        </div>
         Hello my people of Kishiface. We have to find something to this place
    </div>

    <div id="sidePanel">
        <div id="panelContent"></div>
    </div>
<div id="sidePanel2">
        <div id="panelContent2"></div>
    </div>

    <div class="main-feed">

        <div class="member-suggest-card mobile-only" id="mobile-member-section">
            <h4>Faces You May Know</h4>
            <div class="member-list-horizontal">
                {% for member in members %}
                    {% if request.user != member %}
                        <div class="member-item">
                            <a href="{% url 'profile' member.username %}" style="text-decoration: none;">
                                <div class="member-pic-wrapper">
                                    <img src="{{member.profile.picture.url}}" 
                                         
                                         alt="{{member.username}}" 
                                         class="member-pic">
                                </div>
                           
                            </a>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        {% for post in page_obj.object_list %}
        <article class="card">
            <div class="post-header">
                <div class="post-user">
                    <img src="{{post.author.profile.picture.url}}" onerror="this.onerror=null; this.src='https://placehold.co/40x40/cccccc/ffffff?text=P';" alt="{{post.author.username}}" class="profile-pic">
                    <div class="user-details">
                        <a href="{% url 'profile' post.author.username %}" class="username-link"  data-id="{{post.author.username}}">{{post.author.first_name}} {{post.author.last_name}} 
                          {% if post.author.profile.is_verify and post.author.first_name %} <img src="{% static 'images/verify1.jpg' %}" height="20" width="20" alt="">{% endif %}
                        </a>
                        <div class="post-meta">
                            @{{post.author.username}}Â· {{post.created_at|insta_timesince}}
                        </div>
                    </div>
                </div>
                 
                <div class="action-buttons">
                    {% if request.user == post.author %}
                    <a href="{% url 'editpost' post.post_id %}" 
                       title="Edit Post"
                       class="post-icon-button">
                        <i class="fa-solid fa-pen-to-square"></i>
                    </a>
                    <a href="" 
                       title="Delete Post"
                       class="post-icon-button delete-btn">
                        <i class="fa-solid fa-trash"></i>
                    </a>
                    {% else %}
                    <i class="fa-solid fa-ellipsis post-ellipsis-icon" 
                       style="cursor:pointer;"></i>
                    {% endif %}
                </div>
                </div>
            <b class="post-title" style="color: var(--text-dark);">{{post.content|urlize|linebreaksbr}}</b>
            
            {% if post.file %}
              <div class="audio-post-container">
                  <div class="audio-cover-area" 
                       style="background-image: url('{% if post.images.first %}{{post.images.first.image.url}}{% else %}{{post.author.profile.picture.url}}{% endif %}');">
                      </div>
                  <audio controls class="audio-control">
                    <source src="{{ post.file.url }}" type="audio/webm">
                  </audio>
              </div>
              {% endif %}

            {% if post.images.all %}
            <div class="post-image-carousel" id="carousel-{{ post.post_id }}" data-current-slide="0" data-total-slides="{{ post.images.all|length }}">
                <div class="slider-track" id="track-{{ post.post_id }}">
                    {% for p in post.images.all %}
                    <img src="{{p.image.url}}" onerror="this.onerror=null; this.src='https://placehold.co/600x400/999999/ffffff?text=KishiFace+Post';" alt="Post Image {{forloop.counter}}" class="post-image-slide">
                    {% empty %}
                    <img src="https://placehold.co/600x400/999999/ffffff?text=KishiFace" alt="No Post Image" class="post-image-slide">
                    {% endfor %}
                </div>

                {% if post.images.all|length > 1 %}
                <div class="slide-nav">
                    <button id="prev-{{ post.post_id }}" onclick="slidePost('{{ post.post_id }}', -1)" class="hidden"><i class="fa-solid fa-chevron-left"></i></button>
                    <button id="next-{{ post.post_id }}" onclick="slidePost('{{ post.post_id }}', 1)"><i class="fa-solid fa-chevron-right"></i></button>
                </div>

                <div class="slider-indicators" id="indicators-{{ post.post_id }}">
                    {% for p in post.images.all %}
                    <div class="indicator-dot {% if forloop.first %}active{% endif %}"></div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endif %}

            {% include 'snippet/post_like.html' %}
        </article>
        {% empty %}
        <div class="card text-center" style="padding:40px; margin-top: 20px;">
            <h3>No Posts Yet</h3>
            <p style="color: var(--text-muted);">Start by sharing your first moment!</p>
        </div>
        {% endfor %}

        {% if page_obj.has_next %}
        <a id="load-more-container"
            href="?page={{page_obj.next_page_number}}"
           >
            see more
          </a>
        {% endif %}
    </div> <div class="right-sidebar desktop-only">
        <div class="card">
            <div class="sidebar-content scrollable-content">
                <h4 class="desktop-member-title">Faces You May Know</h4>
                <div class="desktop-member-list">
                    {% for member in members %}
                        {% if user != member  %}
                            <div class="desktop-member-item">
                                <a href="{% url 'profile' member.username %}" class="username-link"  data-id="{{member.username}}">
                                    <div class="member-pic-wrapper" style="background: var(--border-color); padding: 0;">
                                        <img src="{{member.profile.picture.url}}" 
                                             
                                             alt="{{member.username}}" 
                                            class="member-pic">
                                    </div>
                                    <div>
                                        <span class="member-username block">{{member.first_name}} {{member.last_name}}</span>
                                        <br><span class="member-title block">@{{member.username}}</span>
                                    </div>
                                </a>
                                <a href="{% url 'follow' member.username %}">
                                    {% if user.profile in member.profile.followers.all %}
                                    <button type="submit" class="action-button btn-secondary">
                                    Following
                                    </button>
                                    {% else %}
                                    <button type="submit" class="action-button btn-secondary">
                                    Follow
                                    </button>
                                    {% endif %}
                                    </a>
                              
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div> </main>

<footer class="mobile-only">
    {% include 'footer.html' %}
</footer>

<script>

    /** pop for profile modal code */

  function setupLinks(){
      const isMobile = window.matchMedia("(max-width: 668px)").matches;
    const userLink = document.querySelectorAll(".username-link");
    userLink.forEach(link =>{
        link.addEventListener('click', function(e){
            if(isMobile){
                return;
            }

            e.preventDefault();

            const userId = this.getAttribute("data-id");
            fetch(`/popup/${userId}/`)
            .then(res =>res.text())
            .then(html =>{
                document.getElementById("panelContent").innerHTML = html;

                document.getElementById("sidePanel").style.right=0;
            });
        });
    });
  }
    setupLinks();
    window.matchMedia("(max-width: 668px)").addEventListener('change', setupLinks());
    function closePanel(){
        document.getElementById('sidePanel').style.right='-400px';
    }
     /* Auto close popup when changing to Mobile */
     window.addEventListener('resize', function(){
         setupLinks();
        const isMobile = window.matchMedia("(max-width: 668px)").matches;
        if(isMobile){
            const panel = document.getElementById('sidePanel');
            panel.style.right = '-400px';
            panel.innerHTML='';
        }
     })

     /* pop for comment */

     function setupLink(){
      const isMobile = window.matchMedia("(max-width: 668px)").matches;
    const commentLink = document.querySelectorAll(".action-item");
    commentLink.forEach(link =>{
        link.addEventListener('click', function(e){
            if(isMobile){
                return;
            }

            e.preventDefault();

            const commentId = this.getAttribute("data-id");
            fetch(`/commentpopup/${commentId}/`)
            .then(res =>res.text())
            .then(html =>{
                document.getElementById("panelContent2").innerHTML = html;

                document.getElementById("sidePanel2").style.left=0;
            });
        });
    });
  }
    setupLink();
    
     /* Auto close popup when changing to Mobile */
     window.addEventListener('resize', function(){
         setupLink();
        const isMobile = window.matchMedia("(max-width: 668px)").matches;
        if(isMobile){
            const panel2 = document.getElementById('sidePanel2');
            panel2.style.left = '-400px';
            panel2.innerHTML='';
        }
     })
function closePanel2(){
        document.getElementById('sidePanel2').style.left='-400px';
    }
    
  /**
   * Handles sliding of a post's image carousel.
   * @param {string} postId - The unique ID of the post.
   * @param {number} direction - -1 for previous, 1 for next.
   */
  function slidePost(postId, direction) {
    const carousel = document.getElementById(`carousel-${postId}`);
    const track = document.getElementById(`track-${postId}`);
    const indicatorsContainer = document.getElementById(`indicators-${postId}`);
    const prevButton = document.getElementById(`prev-${postId}`);
    const nextButton = document.getElementById(`next-${postId}`);

    if (!carousel || !track) return;

    let currentSlide = parseInt(carousel.getAttribute('data-current-slide') || '0');
    const totalSlides = parseInt(carousel.getAttribute('data-total-slides') || '1');

    if (totalSlides <= 1) return;

    let newSlide = currentSlide;

    if (direction !== 0) { // Only update slide index if direction is provided
        newSlide = currentSlide + direction;
    }

    // Clamp the new slide index
    if (newSlide < 0) {
      newSlide = 0;
    } else if (newSlide >= totalSlides) {
      newSlide = totalSlides - 1;
    }

    // 1. Update the slider position using CSS transform
    const slideWidth = carousel.clientWidth;
    const offset = newSlide * slideWidth;
    track.style.transform = `translateX(-${offset}px)`;

    // 2. Update the state attribute
    carousel.setAttribute('data-current-slide', newSlide);

    // 3. Update indicators
    if (indicatorsContainer) {
      indicatorsContainer.querySelectorAll('.indicator-dot').forEach((dot, index) => {
        dot.classList.toggle('active', index === newSlide);
      });
    }

    // 4. Update navigation buttons visibility
    if (prevButton) {
      prevButton.classList.toggle('hidden', newSlide === 0);
    }
    if (nextButton) {
      nextButton.classList.toggle('hidden', newSlide === totalSlides - 1);
    }
  }

  /**
   * Initializes all carousels on the page.
   */
  function initCarousels() {
    // Select all carousels that have more than one slide (checked by total-slides attribute)
    document.querySelectorAll('.post-image-carousel[data-total-slides]:not([data-total-slides="1"])').forEach(carousel => {
        const postId = carousel.id.split('-')[1];
        // Call slidePost with 0 direction to initialize current position and button visibility
        slidePost(postId, 0);
    });
  }

  // Ensure carousels are initialized and responsive on load and resize
  window.addEventListener('resize', initCarousels);
  window.addEventListener('load', initCarousels);

  // Fallback for immediate execution if the document is already ready
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
      initCarousels();
  }
</script>
</body>
</html>
