{% load humanize %}
{% load static %}
{% load time %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" href="{% static 'images/logo.jpg' %}" type="image/x-icon">
  <title>KishiFace - Home</title>
  <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.7/dist/htmx.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="stylesheet" href="{% static 'css/home.css' %}">
  <script src="{% static 'js/home.js' %}"></script>
  <style>
    
    /* Section Title Row */
    .section {
        margin-bottom: 25px;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        padding: 0 5px;
        margin-bottom: 12px;
    }

    .section-title {
        font-size: 17px;
        font-weight: 600;
        color: #222;
    }

    .see-all {
        font-size: 14px;
        color: #0095f6;
        cursor: pointer;
    }

    /* Marketplace (Instagram Shop) */
    .marketplace-list {
        display: flex;
        gap: 12px;
        overflow-x: auto;
        scrollbar-width: none;
    }

    .marketplace-list::-webkit-scrollbar {
        display: none;
    }

    .marketplace-item {
        min-width: 150px;
    }

    .marketplace-item img {
        width: 100%;
        height: 160px;
        object-fit: cover;
        border-radius: 12px;
    }

    .item-title {
        font-size: 14px;
        margin-top: 6px;
        color: #222;
    }

    .item-price {
        font-size: 13px;
        color: #444;
        margin-top: 2px;
    }

    /* ---------------- INSTAGRAM-STYLE AUDIO DESIGN ---------------- */
    .audio-post-container {
        /* Main container for the cover and controls */
        display: flex;
        flex-direction: column;
        border: 1px solid var(--divider-color);
        border-radius: 8px;
        overflow: hidden; 
        margin-top: 10px;
    }
    
    .audio-cover-area {
        /* Styles for the background poster image - now clickable */
        width: 100%;
        height: 250px; 
        background-size: cover;
        background-position: center;
        background-color: var(--text-dark); /* Fallback dark color */
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.4);
        cursor: pointer;
        position: relative;
    }
    
    /* Play/Pause icon over the audio cover */
    .audio-play-icon {
        font-size: 3em;
        color: white;
        text-shadow: 0 0 10px rgba(0, 0, 0, 0.9);
        z-index: 5;
        transition: opacity 0.3s ease;
    }

    /* Hide the native audio element */
    .audio-hidden {
        display: none; 
    }
    /* ---------------- END AUDIO DESIGN ---------------- */

    /* Existing styles from the original file (kept for compatibility) */
    .cover{
        width: 100%;
        height: 250px;
        /*background-image: url('https://placehold.co/600x400/999999/ffffff?text=KishiFace+Post');*/
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 10px;
    }
    .cover i{
        font-size: 50px;
        color: #bdbdbd;
        margin-right: 40px;
    }
    .audio{
        width: 100%;
        outline: none;
    }

    /* ---------------- Instagram Video Styles (CLEANED) ---------------- */
    .instagram-video-container {
        position: relative; 
        width: 100%;
        overflow: hidden;
        margin-top: 10px;
        background-color: black;
        min-height: 200px; 
        display: flex; 
        justify-content: center;
        align-items: center;
    }

    .instagram-video {
        max-width: 100%; 
        height: auto; 
        object-fit: contain; 
        display: block; 
    }

    /* Styling for the Play/Pause Icon */
    .play-pause-icon {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 4em; 
        color: white;
        background: rgba(0, 0, 0, 0.4);
        border-radius: 50%;
        padding: 15px 20px 15px 23px;
        pointer-events: none;
        opacity: 0; 
        transition: opacity 0.3s ease;
    }

    /* State Class: Show Play icon when video is paused */
    .instagram-video-container.paused .play-pause-icon {
        opacity: 1;
    }
    /* ---------------- End Instagram Video Styles ---------------- */
    
    /* ---------------- NEW OVERLAY SEEK ICONS ---------------- */
    .seek-overlay-btn {
        position: absolute;
        bottom: 10px; 
        background: rgba(0, 0, 0, 0.4);
        color: white;
        border: none;
        border-radius: 5px;
        padding: 8px 10px;
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        z-index: 10; 
        opacity: 0; 
        transition: opacity 0.3s ease;
    }

    .seek-overlay-btn:hover {
        background: rgba(0, 0, 0, 0.6);
    }

    .backward-btn {
        left: 10px;
    }

    .forward-btn {
        right: 10px; /* Adjusted position */
    }

    /* State Class: Show controls when paused or hovered */
    .instagram-video-container.paused .seek-overlay-btn,
    .instagram-video-container:hover .seek-overlay-btn {
        opacity: 1;
    }
    /* ---------------- END NEW SEEK ICONS ---------------- */
    
     /* Pop up design */

     #sidePanel{
        position: fixed;
        top: 0;
        right: -400px;
        width: 400px;
        height: 100%;
        background: white;
        box-shadow: -2px 0px 6px rgba(0, 0, 0, 0.2);
        border-left: 1px solid #ccc;
        transition:  right 0.3s ease;
        z-index: 9999;
        overflow: auto;
     }

      #sidePanel2{
        position: fixed;
        top: 0;
        left: -400px;
        width: 400px;
        height: 100%;
        background: white;
        box-shadow: -2px 0px 6px rgba(0, 0, 0, 0.2);
        border-left: 1px solid #ccc;
        transition:  left 0.4s ease;
        z-index: 9999;
        overflow: auto;
     }
    
    
  </style>
</head>
<body>

{% include 'header.html' %}

<main class="container">
    
    <div class="left-sidebar desktop-only">
        <div class="card">
            <div class="sidebar-content">
                <h4 class="sidebar-title">My Account</h4>
        
                <a href="{% url 'profile' user.username %}" class="sidebar-link" data-id="{{user.username}}">
                  <img src="{{user.profile.picture.url}}" height="30" width="30" style="border-radius: 50%;" alt="">  
                  {{user.profile.full_name}}
                </a>
                <a href="" class="sidebar-link">
                    <i class="fa-solid fa-cog"></i> Settings
                </a>
                <a href="{% url 'channel_create' %}" class="sidebar-link">
                    <i class="fa-solid fa-cog"></i> Channels
                </a>
                 <a href="{% url 'market' %}" class="sidebar-link">
                    <i class="fa-solid fa-cog"></i> Market Place
                </a>
                <a href="{% url 'post' %}" class="sidebar-link">
                <i><svg fill="none" stroke="currentColor" height="20" width="20" viewBox="0 0 24 24">
                  <circle cx="12" cy="12" r="10" stroke-width="2"/>
                  <line x1="12" y1="8" x2="12" y2="16" stroke-width="2"/>
                  <line x1="8" y1="12" x2="16" y2="12" stroke-width="2"/>
                </svg></i> Post
              </a>
                <hr class="sidebar-divider">
                <a href="{% url 'logout' %}" class="sidebar-link logout">
                    <i class="fa-solid fa-right-from-bracket"></i> Logout
                </a>
            </div>
           
        </div>
         Hello my people of Kishiface. We have to find something to this place
    </div>

    <div id="sidePanel">
        <div id="panelContent"></div>
    </div>
<div id="sidePanel2">
        <div id="panelContent2"></div>
    </div>

    <div class="main-feed">

        <div class="member-suggest-card mobile-only" id="mobile-member-section">
            <!-- MARKETPLACE SECTION -->
        <div class="section">
        <div class="section-header">
            <span class="section-title">Marketplace</span>
            <span class="see-all">
                <a href="{% url 'market' %}">See all</a>
            </span>
        </div>
        <div class="marketplace-list">
            {% for product in products %}
                <div class="marketplace-item">
                {% with first_image=product.images.first %}
                    {% if first_image %}
                    <img src="{{first_image.product_image.url}}" />
                    {% endif %}
                {% endwith %}
                <div class="item-title">{{product.product_name}}</div>
                <div class="item-price">₦{{product.product_price}}</div>
            </div>
            {% endfor %}
        </div>
    </div>

        </div>
        {% for post in page_obj.object_list %}
        <article class="card">
            <div class="post-header">
                <div class="post-user">
                    <img src="{{post.author.profile.picture.url}}" onerror="this.onerror=null; this.src='https://placehold.co/40x40/cccccc/ffffff?text=P';" alt="{{post.author.username}}" class="profile-pic">
                    <div class="user-details">
                        <a href="{% url 'profile' post.author.username %}" class="username-link"  data-id="{{post.author.username}}">{{post.author.first_name}} {{post.author.last_name}} 
                          {% if post.author.profile.is_verify and post.author.first_name %} <img src="{% static 'images/verify1.jpg' %}" height="20" width="20" alt="">{% endif %}
                        </a>
                        <div class="post-meta">
                            @{{post.author.username}}· {{post.created_at|insta_timesince}}
                        </div>
                    </div>
                </div>
                 
                <div class="action-buttons">
                    {% if request.user == post.author %}
                    <a href="{% url 'editpost' post.post_id %}" 
                       title="Edit Post"
                       class="post-icon-button">
                        <i class="fa-solid fa-pen-to-square"></i>
                    </a>
                    <a href="" 
                       title="Delete Post"
                       class="post-icon-button delete-btn">
                        <i class="fa-solid fa-trash"></i>
                    </a>
                    {% else %}
                    <i class="fa-solid fa-ellipsis post-ellipsis-icon" 
                       style="cursor:pointer;"></i>
                    {% endif %}
                </div>
                </div>
            <b class="post-title" style="color: var(--text-dark);">{{post.content|urlize|linebreaksbr}}</b>
            
            {% if post.file %}
              <div class="audio-post-container" id="audio-container-{{ post.post_id }}">
                  <div class="audio-cover-area" 
                       style="background-image: url('{% if post.images.first %}{{post.images.first.image.url}}{% else %}{{post.author.profile.picture.url}}{% endif %}');"
                       onclick="toggleAudioPlay('audio-{{ post.post_id }}')">
                        <i class="fa-solid fa-play audio-play-icon" id="audio-icon-{{ post.post_id }}"></i>
                  </div>
                  <audio id="audio-{{ post.post_id }}" class="audio-hidden">
                    <source src="{{ post.file.url }}" type="audio/webm">
                  </audio>
              </div>
            {% endif %}

              {% if post.video_file %}
              <div class="instagram-video-container" id="container-{{ post.post_id }}">
                  <video class="instagram-video" 
                         id="post-video-{{ post.post_id }}" 
                         preload="metadata" 
                         autoplay 
                         loop 
                         onclick="togglePlayPause('post-video-{{ post.post_id }}', event)"> 
                      
                      <source src="{{ post.video_file.url }}" type="video/mp4">
                      Your browser does not support HTML5 video.
                  </video>
                  
                  <i class="fa-solid fa-play play-pause-icon" id="play-icon-{{ post.post_id }}"></i>
                  
                  <button class="seek-overlay-btn backward-btn" 
                          onclick="event.stopPropagation(); seekVideo('post-video-{{ post.post_id }}', -10)">
                      <i class="fa-solid fa-backward-step"></i> 10s
                  </button>
                  <button class="seek-overlay-btn forward-btn" 
                          onclick="event.stopPropagation(); seekVideo('post-video-{{ post.post_id }}', 10)">
                      10s <i class="fa-solid fa-forward-step"></i>
                  </button>
                  </div>
              
              {% endif %}
              
            {% if post.images.all %}
            <div class="post-image-carousel" id="carousel-{{ post.post_id }}" data-current-slide="0" data-total-slides="{{ post.images.all|length }}">
                <div class="slider-track" id="track-{{ post.post_id }}">
                    {% for p in post.images.all %}
                    <img src="{{p.image.url}}" onerror="this.onerror=null; this.src='https://placehold.co/600x400/999999/ffffff?text=KishiFace+Post';" alt="Post Image {{forloop.counter}}" class="post-image-slide">
                    {% empty %}
                    <img src="https://placehold.co/600x400/999999/ffffff?text=KishiFace" alt="No Post Image" class="post-image-slide">
                    {% endfor %}
                </div>

                {% if post.images.all|length > 1 %}
                <div class="slide-nav">
                    <button id="prev-{{ post.post_id }}" onclick="slidePost('{{ post.post_id }}', -1)" class="hidden"><i class="fa-solid fa-chevron-left"></i></button>
                    <button id="next-{{ post.post_id }}" onclick="slidePost('{{ post.post_id }}', 1)"><i class="fa-solid fa-chevron-right"></i></button>
                </div>

                <div class="slider-indicators" id="indicators-{{ post.post_id }}">
                    {% for p in post.images.all %}
                    <div class="indicator-dot {% if forloop.first %}active{% endif %}"></div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endif %}

            {% include 'snippet/post_like.html' %}
        </article>
        {% empty %}
        <div class="card text-center" style="padding:40px; margin-top: 20px;">
            <h3>No Posts Yet</h3>
            <p style="color: var(--text-muted);">Start by sharing your first moment!</p>
        </div>
        {% endfor %}

     
    </div> <div class="right-sidebar desktop-only">
        <div class="card">
            <div class="sidebar-content scrollable-content">
                <h4 class="desktop-member-title">Faces You May Know</h4>
                <div class="desktop-member-list">
                    {% for member in members %}
                        {% if user != member  %}
                            <div class="desktop-member-item">
                                <a href="{% url 'profile' member.username %}" class="username-link"  data-id="{{member.username}}">
                                    <div class="member-pic-wrapper" style="background: var(--border-color); padding: 0;">
                                        <img src="{{member.profile.picture.url}}" 
                                             
                                             alt="{{member.username}}" 
                                            class="member-pic">
                                    </div>
                                    <div>
                                        <span class="member-username block">{{member.first_name}} {{member.last_name}}</span>
                                        <br><span class="member-title block">@{{member.username}}</span>
                                    </div>
                                </a>
                                <a href="{% url 'follow' member.username %}">
                                    {% if user.profile in member.profile.followers.all %}
                                    <button type="submit" class="action-button btn-secondary">
                                    Following
                                    </button>
                                    {% else %}
                                    <button type="submit" class="action-button btn-secondary">
                                    Follow
                                    </button>
                                    {% endif %}
                                    </a>
                              
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div> </main>

<footer class="mobile-only">
    {% include 'footer.html' %}
</footer>


</body>
</html>
