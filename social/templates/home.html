{% load humanize %}
{% load static %}
{% load time %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="shortcut icon" href="{% static 'images/logo.jpg' %}" type="image/x-icon">
  <title>KishiFace - Home</title>
  <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.7/dist/htmx.min.js" defer></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="stylesheet" href="{% static 'css/home.css' %}">
  <script src="{% static 'js/home.js' %}" defer></script>
  <style>
    /* Inline wave animation for immediate rendering */
    @keyframes wave-movement {
        0%, 100% { transform: scaleY(0.7); }
        50% { transform: scaleY(1.3); }
    }
  </style>
</head>
<body>

{% include 'header.html' %}

<main class="container">
    <div class="main-feed">
        <section class="card marketplace-container">
            <div class="section-header">
                <span class="section-title">Marketplace</span>
                <a href="{% url 'market' %}" class="see-all">See all</a>
            </div>
            <div class="marketplace-list">
                {% for product in products %}
                    <div class="marketplace-item">
                        {% with first_image=product.images.first %}
                            <img src="{{first_image.product_image.url}}" loading="lazy" alt="{{product.product_name}}">
                        {% endwith %}
                        <div class="item-title">{{product.product_name}}</div>
                        <div class="item-price">₦{{product.product_price}}</div>
                    </div>
                {% endfor %}
            </div>
        </section>

        {% for post in posts %}
        <article class="card">
            <div class="post-header">
                <div class="post-user">
                    <img src="{{post.author.profile.picture.url}}" loading="lazy" onerror="this.onerror=null; this.src='https://placehold.co/40x40/cccccc/ffffff?text=P';" class="profile-pic">
                    <div class="user-details">
                        <a href="{% url 'profile' post.author.username %}" class="username-link">{{post.author.first_name}} {{post.author.last_name}} 
                          {% if post.author.profile.is_verify %} <img src="{% static 'images/verify1.jpg' %}" height="18" width="18">{% endif %}
                        </a>
                        <div class="post-meta">@{{post.author.username}} · {{post.created_at|insta_timesince}}</div>
                    </div>
                </div>
                <div class="action-buttons">
                    {% if request.user == post.author %}
                        <a href="{% url 'editpost' post.post_id %}" class="post-icon-button"><i class="fa-solid fa-pen-to-square"></i></a>
                    {% else %}
                        <i class="fa-solid fa-ellipsis post-ellipsis-icon"></i>
                    {% endif %}
                </div>
            </div>

            <div class="post-title">{{post.content|urlize|linebreaksbr}}</div>
            
            {% if post.file %}
              <div class="audio-post-container" id="audio-container-{{ post.post_id }}">
                  <div class="audio-cover-area" 
                       style="background-image: url('{% if post.images.first %}{{post.images.first.image.url}}{% else %}{{post.author.profile.picture.url}}{% endif %}');"
                       onclick="toggleAudioPlay('audio-{{ post.post_id }}')">
                        <i class="fa-solid fa-play audio-play-icon" id="audio-icon-{{ post.post_id }}"></i>
                        <div class="audio-wave-visualizer" id="audio-wave-{{ post.post_id }}">
                            <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
                        </div>
                  </div>
                  <audio id="audio-{{ post.post_id }}" class="audio-hidden" preload="none">
                    <source src="{{ post.file.url }}" type="audio/webm">
                  </audio>
              </div>
            {% endif %}

            {% if post.video_file %}
              <div class="instagram-video-container" id="container-{{ post.post_id }}">
                  <video class="instagram-video" id="post-video-{{ post.post_id }}" 
                         preload="none" loop onclick="togglePlayPause('post-video-{{ post.post_id }}', event)"> 
                      <source src="{{ post.video_file.url }}" type="video/mp4">
                  </video>
                  <i class="fa-solid fa-play play-pause-icon" id="play-icon-{{ post.post_id }}"></i>
                  <div class="seek-controls">
                      <button class="seek-overlay-btn backward-btn" onclick="event.stopPropagation(); seekVideo('post-video-{{ post.post_id }}', -10)">
                          <i class="fa-solid fa-backward-step"></i> 10s
                      </button>
                      <button class="seek-overlay-btn forward-btn" onclick="event.stopPropagation(); seekVideo('post-video-{{ post.post_id }}', 10)">
                          10s <i class="fa-solid fa-forward-step"></i>
                      </button>
                  </div>
              </div>
            {% endif %}
              
            {% if post.images.all and not post.file %}
            <div class="post-image-carousel" id="carousel-{{ post.post_id }}" data-current-slide="0" data-total-slides="{{ post.images.all|length }}">
                <div class="slider-track" id="track-{{ post.post_id }}">
                    {% for p in post.images.all %}
                    <img src="{{p.image.url}}" loading="lazy" class="post-image-slide">
                    {% endfor %}
                </div>
                {% if post.images.all|length > 1 %}
                <div class="slide-nav">
                    <button id="prev-{{ post.post_id }}" onclick="slidePost('{{ post.post_id }}', -1)" class="hidden"><i class="fa-solid fa-chevron-left"></i></button>
                    <button id="next-{{ post.post_id }}" onclick="slidePost('{{ post.post_id }}', 1)"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
                {% endif %}
            </div>
            {% endif %}

            {% include 'snippet/post_like.html' %}
        </article>
        {% endfor %}
    </div>
</main>

<footer class="mobile-footer">
    {% include 'footer.html' %}
</footer>

</body>
</html>


