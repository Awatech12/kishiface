{% load humanize %}
{% load static %}

<!-- Font Awesome for Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
    :root {
        --kf-primary: #0095f6;
        --kf-bg: #ffffff;
        --kf-secondary-bg: #fafafa;
        --kf-border: #dbdbdb;
        --kf-text-main: #262626;
        --kf-text-muted: #8e8e8e;
        --kf-success: #2ecc71;
    }

    body {
        background-color: var(--kf-bg);
        color: var(--kf-text-main);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    .kf-container {
        max-width: 935px;
        margin: 20px auto;
        padding: 0 10px 100px;
    }

    /* Layout Grid */
    .kf-product-card {
        display: flex;
        flex-direction: row;
        border: 1px solid var(--kf-border);
        border-radius: 3px;
        background: #fff;
        min-height: 500px;
    }

    /* Left: Media Area */
    .kf-media-side {
        flex: 1.2;
        background: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        border-right: 1px solid var(--kf-border);
    }

    .kf-main-img {
        max-width: 100%;
        max-height: 600px;
        object-fit: contain;
    }

    /* Right: Info Area */
    .kf-info-side {
        flex: 0.8;
        display: flex;
        flex-direction: column;
        background: #fff;
    }

    /* Seller Header */
    .kf-seller-header {
        padding: 14px 16px;
        display: flex;
        align-items: center;
        border-bottom: 1px solid var(--kf-border);
    }

    .kf-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        margin-right: 12px;
        object-fit: cover;
        border: 1px solid var(--kf-border);
    }

    .kf-username {
        font-weight: 600;
        font-size: 14px;
        color: var(--kf-text-main);
        text-decoration: none;
    }

    /* Content Area */
    .kf-scroll-content {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
    }

    .kf-product-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .kf-price-tag {
        font-size: 20px;
        font-weight: 700;
        color: var(--kf-primary);
        margin-bottom: 15px;
    }

    .kf-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        margin-bottom: 10px;
    }
    .kf-badge-promoted { background: #fff0f0; color: #ff4757; border: 1px solid #ff4757; }
    .kf-badge-condition { background: #f0f0f0; color: #555; }

    .kf-description {
        font-size: 14px;
        line-height: 1.5;
        margin: 15px 0;
        white-space: pre-wrap;
    }

    .kf-meta-list {
        list-style: none;
        padding: 0;
        margin: 20px 0;
        font-size: 13px;
        color: var(--kf-text-muted);
    }

    .kf-meta-list li {
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* Action Buttons */
    .kf-actions {
        padding: 16px;
        border-top: 1px solid var(--kf-border);
    }

    .kf-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        margin-bottom: 8px;
        text-decoration: none;
        border: none;
        transition: opacity 0.2s;
    }

    .kf-btn:hover { opacity: 0.8; }
    .kf-btn-primary { background: var(--kf-primary); color: white; }
    .kf-btn-whatsapp { background: var(--kf-success); color: white; }
    .kf-btn-outline { background: white; color: var(--kf-text-main); border: 1px solid var(--kf-border); }

    /* Thumbnails */
    .kf-thumbs-wrapper {
        padding: 10px;
        display: flex;
        gap: 8px;
        overflow-x: auto;
    }

    .kf-thumb-img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        cursor: pointer;
        border-radius: 4px;
        border: 1px solid var(--kf-border);
    }

    /* More from Seller */
    .kf-more-section {
        margin-top: 40px;
        border-top: 1px solid var(--kf-border);
        padding-top: 20px;
    }

    .kf-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-top: 15px;
    }

    .kf-grid-item {
        aspect-ratio: 1/1;
        overflow: hidden;
        background: #eee;
        position: relative;
    }

    .kf-grid-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    /* Share Overlay */
    #kfShareModal {
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 2000;
        align-items: center;
        justify-content: center;
    }

    .kf-share-box {
        background: white;
        padding: 20px;
        border-radius: 12px;
        width: 90%;
        max-width: 400px;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
        .kf-product-card { flex-direction: column; border: none; }
        .kf-media-side { border-right: none; }
        .kf-info-side { border-bottom: 1px solid var(--kf-border); }
        .kf-grid { grid-template-columns: repeat(2, 1fr); }
        .kf-desktop-actions { display: none; }
        .kf-mobile-bar {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: white;
            padding: 12px;
            display: flex;
            gap: 8px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
    }

    @media (min-width: 769px) {
        .kf-mobile-bar { display: none; }
    }
</style>

<div class="kf-container">
    <!-- Back Button -->
    <div style="margin-bottom: 15px;">
        <a href="{% url 'market' %}" style="text-decoration: none; color: var(--kf-text-main); font-weight: 600;">
            <i class="fas fa-chevron-left"></i> Market
        </a>
    </div>

    <div class="kf-product-card">
        <!-- Left Visuals -->
        <div class="kf-media-side">
            <img src="{{ product.images.first.product_image.url }}" id="kfMainDisplay" class="kf-main-img" alt="Product">
        </div>

        <!-- Right Side -->
        <div class="kf-info-side">
            <!-- Header -->
            <div class="kf-seller-header">
                <a href="{% url 'profile' product.product_owner.username %}">
                    <img src="{{ seller.picture.url }}" class="kf-avatar">
                </a>
                <a href="{% url 'profile' product.product_owner.username %}" class="kf-username">
                    {{ product.product_owner.username }}
                </a>
                {% if seller.is_verify %}
                    <i class="fas fa-check-circle" style="color: #0095f6; font-size: 12px; margin-left: 4px;"></i>
                {% endif %}
            </div>

            <!-- Content -->
            <div class="kf-scroll-content">
                {% if product.is_promoted %}
                <span class="kf-badge kf-badge-promoted">Sponsored</span>
                {% endif %}
                <span class="kf-badge kf-badge-condition">{{ product.product_condition }}</span>
                
                <h1 class="kf-product-title">{{ product.product_name }}</h1>
                <div class="kf-price-tag">â‚¦{{ product.product_price|intcomma }}</div>

                <div class="kf-description">{{ product.product_description }}</div>

                <ul class="kf-meta-list">
                    <li><i class="fas fa-tag"></i> Category: {{ product.product_category }}</li>
                    <li><i class="fas fa-map-marker-alt"></i> {{ product.product_location }}</li>
                    <li><i class="fas fa-eye"></i> {{ product.views_count }} views</li>
                    <li><i class="fas fa-clock"></i> Posted {{ product.posted_on|naturaltime }}</li>
                </ul>

                <!-- Multi-image Thumbnails inside the scroll area -->
                <div class="kf-thumbs-wrapper">
                    {% for img in product.images.all %}
                    <img src="{{ img.product_image.url }}" class="kf-thumb-img" onclick="setKfImage('{{ img.product_image.url }}')">
                    {% endfor %}
                </div>
            </div>

            <!-- Desktop Actions -->
            <div class="kf-actions kf-desktop-actions">
                {% if request.user != product.product_owner %}
                    <a href="{% url 'message' product.product_owner.username %}" class="kf-btn kf-btn-primary">
                        <i class="fas fa-paper-plane"></i> Send Message
                    </a>
                    <a href="https://wa.me/{{ seller.phone }}?text=Hi, I am interested in {{ product.product_name }}" target="_blank" class="kf-btn kf-btn-whatsapp">
                        <i class="fab fa-whatsapp"></i> WhatsApp
                    </a>
                {% else %}
                    <a href="#" class="kf-btn kf-btn-outline">
                        <i class="fas fa-edit"></i> Edit Listing
                    </a>
                {% endif %}
                
                <button onclick="toggleShare()" class="kf-btn kf-btn-outline">
                    <i class="fas fa-share-alt"></i> Share Product
                </button>
            </div>
        </div>
    </div>

    <!-- More Products from Owner Section -->
    <div class="kf-more-section">
        <h3 style="font-size: 14px; color: var(--kf-text-muted); font-weight: 600; margin-bottom: 20px;">
            More products from <span style="color: var(--kf-text-main);">{{ product.product_owner.username }}</span>
        </h3>
        <div class="kf-grid">
            {% for item in product.product_owner.products.all|slice:":6" %}
                {% if item.product_id != product.product_id %}
                <a href="{% url 'product_detail' item.product_id %}" class="kf-grid-item">
                    <img src="{{ item.images.first.product_image.url }}" loading="lazy">
                </a>
                {% endif %}
            {% empty %}
                <p style="font-size: 13px; color: var(--kf-text-muted);">No other products available.</p>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Mobile Fixed Bar -->
<div class="kf-mobile-bar">
    {% if request.user != product.product_owner %}
        <a href="{% url 'message' product.product_owner.username %}" class="kf-btn kf-btn-primary" style="flex: 1; margin-bottom: 0;">
            Message
        </a>
        <a href="https://wa.me/{{ seller.phone }}" class="kf-btn kf-btn-whatsapp" style="flex: 1; margin-bottom: 0;">
            WhatsApp
        </a>
    {% endif %}
    <button onclick="toggleShare()" class="kf-btn kf-btn-outline" style="width: 50px; margin-bottom: 0;">
        <i class="fas fa-share-alt"></i>
    </button>
</div>

<!-- Share Modal -->
<div id="kfShareModal" onclick="toggleShare()">
    <div class="kf-share-box" onclick="event.stopPropagation()">
        <h3 style="margin-top:0">Share this item</h3>
        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px;">
            <button class="kf-btn kf-btn-outline" onclick="copyLink()">
                <i class="fas fa-link"></i> Copy Link
            </button>
            <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}" target="_blank" class="kf-btn kf-btn-outline" style="color: #1877F2;">
                <i class="fab fa-facebook"></i> Facebook
            </a>
            <a href="https://twitter.com/intent/tweet?url={{ request.build_absolute_uri }}&text=Check this out!" target="_blank" class="kf-btn kf-btn-outline" style="color: #1DA1F2;">
                <i class="fab fa-twitter"></i> Twitter
            </a>
            <button class="kf-btn kf-btn-primary" onclick="toggleShare()" style="margin-top: 10px;">Close</button>
        </div>
    </div>
</div>

<script>
    function setKfImage(url) {
        document.getElementById('kfMainDisplay').src = url;
    }

    function toggleShare() {
        const modal = document.getElementById('kfShareModal');
        modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
    }

    function copyLink() {
        const dummy = document.createElement('input');
        const text = window.location.href;
        document.body.appendChild(dummy);
        dummy.value = text;
        dummy.select();
        document.execCommand('copy');
        document.body.removeChild(dummy);
        alert('Link copied to clipboard!');
    }
</script>
